<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWS WMS Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.wms@0.2.0/dist/leaflet.wms.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 600px;
            width: 100%;
            border: 2px solid #333;
        }
        .info {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>NWS WMS Radar Test</h1>
    <div class="info">
        <h3>Test 1: Direct NWS WMS Connection</h3>
        <div id="test1-result" class="test-result">Testing...</div>
    </div>
    <div class="info">
        <h3>Test 2: Proxy Connection</h3>
        <div id="test2-result" class="test-result">Testing...</div>
    </div>
    <div class="info">
        <h3>Test 3: Leaflet WMS Layer</h3>
        <div id="map"></div>
        <div id="test3-result" class="test-result">Initializing map...</div>
    </div>

    <script>
        // Test 1: Direct NWS WMS request
        async function testDirectWMS() {
            const resultDiv = document.getElementById('test1-result');
            try {
                const url = 'https://opengeo.ncep.noaa.gov/geoserver/ows?SERVICE=WMS&REQUEST=GetMap&LAYERS=conus:conus_bref_qcd&STYLES=&FORMAT=image/png&TRANSPARENT=true&VERSION=1.3.0&WIDTH=256&HEIGHT=256&CRS=EPSG:3857&BBOX=-8375052.315150193,4774562.534805251,-8296780.798186173,4852834.051769271';
                
                const response = await fetch(url);
                const blob = await response.blob();
                const size = blob.size;
                const isImage = blob.type.startsWith('image/');
                
                // Check if it's a PNG
                const arrayBuffer = await blob.arrayBuffer();
                const bytes = new Uint8Array(arrayBuffer.slice(0, 8));
                const isPNG = bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47;
                
                if (response.ok && isImage && isPNG && size > 1000) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `✅ SUCCESS: Direct WMS works!<br>
                        Status: ${response.status}<br>
                        Size: ${size} bytes<br>
                        Type: ${blob.type}<br>
                        Is PNG: ${isPNG}<br>
                        <img src="${url}" style="max-width: 256px; border: 1px solid #333; margin-top: 10px;" alt="Test tile">`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `❌ FAILED: Direct WMS issue<br>
                        Status: ${response.status}<br>
                        Size: ${size} bytes<br>
                        Type: ${blob.type}<br>
                        Is PNG: ${isPNG}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ ERROR: ${error.message}`;
            }
        }

        // Test 2: Proxy connection
        async function testProxyWMS() {
            const resultDiv = document.getElementById('test2-result');
            try {
                // Use the deployed proxy URL
                const proxyUrl = 'https://weather-app.janglim3.workers.dev/api/nws-wms?SERVICE=WMS&REQUEST=GetMap&LAYERS=conus:conus_bref_qcd&STYLES=&FORMAT=image/png&TRANSPARENT=true&VERSION=1.3.0&WIDTH=256&HEIGHT=256&CRS=EPSG:3857&BBOX=-8375052.315150193,4774562.534805251,-8296780.798186173,4852834.051769271';
                
                const response = await fetch(proxyUrl);
                const blob = await response.blob();
                const size = blob.size;
                const isImage = blob.type.startsWith('image/');
                
                // Check if it's a PNG
                const arrayBuffer = await blob.arrayBuffer();
                const bytes = new Uint8Array(arrayBuffer.slice(0, 8));
                const isPNG = bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47;
                
                if (response.ok && isImage && isPNG && size > 1000) {
                    resultDiv.className = 'test-result success';
                    resultDiv.innerHTML = `✅ SUCCESS: Proxy works!<br>
                        Status: ${response.status}<br>
                        Size: ${size} bytes<br>
                        Type: ${blob.type}<br>
                        Is PNG: ${isPNG}<br>
                        <img src="${proxyUrl}" style="max-width: 256px; border: 1px solid #333; margin-top: 10px;" alt="Test tile">`;
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `❌ FAILED: Proxy issue<br>
                        Status: ${response.status}<br>
                        Size: ${size} bytes (${size === 68 ? 'This is our error PNG!' : 'Unexpected size'})<br>
                        Type: ${blob.type}<br>
                        Is PNG: ${isPNG}`;
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ ERROR: ${error.message}`;
            }
        }

        // Test 3: Leaflet WMS layer
        function testLeafletWMS() {
            const resultDiv = document.getElementById('test3-result');
            try {
                // Initialize map centered on US
                const map = L.map('map').setView([40.0, -100.0], 4);
                
                // Add base layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
                
                // Test direct WMS (no proxy)
                const directWMS = L.tileLayer.wms('https://opengeo.ncep.noaa.gov/geoserver/ows', {
                    layers: 'conus:conus_bref_qcd',
                    format: 'image/png',
                    transparent: true,
                    version: '1.3.0',
                    uppercase: true,
                    attribution: 'NWS Radar'
                });
                
                // Test proxy WMS
                const proxyWMS = L.tileLayer.wms('https://weather-app.janglim3.workers.dev/api/nws-wms', {
                    layers: 'conus:conus_bref_qcd',
                    format: 'image/png',
                    transparent: true,
                    version: '1.3.0',
                    uppercase: true,
                    attribution: 'NWS Radar (via Proxy)'
                });
                
                // Add direct WMS first
                directWMS.addTo(map);
                
                // Monitor tile loading
                let directTilesLoaded = 0;
                let directTilesErrored = 0;
                let proxyTilesLoaded = 0;
                let proxyTilesErrored = 0;
                
                directWMS.on('tileload', () => {
                    directTilesLoaded++;
                    updateResult();
                });
                
                directWMS.on('tileerror', (error, tile) => {
                    directTilesErrored++;
                    updateResult();
                });
                
                proxyWMS.on('tileload', () => {
                    proxyTilesLoaded++;
                    updateResult();
                });
                
                proxyWMS.on('tileerror', (error, tile) => {
                    proxyTilesErrored++;
                    updateResult();
                });
                
                function updateResult() {
                    resultDiv.innerHTML = `
                        <strong>Direct WMS:</strong> ${directTilesLoaded} loaded, ${directTilesErrored} errors<br>
                        <strong>Proxy WMS:</strong> ${proxyTilesLoaded} loaded, ${proxyTilesErrored} errors<br>
                        <button onclick="switchToProxy()" style="margin-top: 10px; padding: 5px 10px;">Switch to Proxy</button>
                    `;
                }
                
                // Make switchToProxy available globally
                window.switchToProxy = function() {
                    map.removeLayer(directWMS);
                    proxyWMS.addTo(map);
                };
                
                updateResult();
                
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `❌ ERROR: ${error.message}`;
            }
        }

        // Run all tests
        testDirectWMS();
        testProxyWMS();
        testLeafletWMS();
    </script>
</body>
</html>
