// This file is auto-generated by build.js
const HTML_CONTENT = "<!doctype html><html lang=\"en\"><head><meta charset=\"UTF-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>Jaccuweather</title><link rel=\"icon\" type=\"image/svg+xml\" href=\"/favicon.svg\"><link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"/apple-touch-icon.png?v=e0bc3a4d\"><meta name=\"apple-mobile-web-app-capable\" content=\"yes\"><meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black\"><meta name=\"apple-mobile-web-app-title\" content=\"Jaccuweather\"><meta name=\"theme-color\" content=\"#1a1a2e\"><meta property=\"og:title\" content=\"Jaccuweather\"><meta property=\"og:description\" content=\"Real-time weather forecasts with radar, hourly and daily forecasts\"><meta property=\"og:type\" content=\"website\"><script src=\"https://cdn.tailwindcss.com\"></script><script>window.MathJax = {\n            tex: { inlineMath: [['\\\\(', '\\\\)']], displayMath: [['\\\\[', '\\\\]']] },\n            chtml: { scale: 0.9 },\n            startup: {\n                ready: () => {\n                    MathJax.startup.defaultReady();\n                }\n            }\n        };</script><script id=\"MathJax-script\" async src=\"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"></script><script>tailwind.config = {\n            theme: {\n                extend: {\n                    fontFamily: {\n                        sans: ['Inter', 'system-ui', 'sans-serif'],\n                    }\n                }\n            }\n        }</script><script src=\"https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js\"></script><script src=\"https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js\"></script><link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\"><link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\"><script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script><script src=\"https://unpkg.com/leaflet.wms@0.2.0/dist/leaflet.wms.js\"></script><style>@import url(https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap);html{background:linear-gradient(135deg,#1a1a2e 0,#16213e 50%,#0f3460 100%);background-attachment:fixed}body{font-family:Inter,system-ui,sans-serif;background:linear-gradient(135deg,#1a1a2e 0,#16213e 50%,#0f3460 100%);background-attachment:fixed;min-height:100vh}.card{background:rgba(31,41,55,.8);backdrop-filter:blur(10px);border:1px solid rgba(75,85,99,.5)}.skeleton{background:linear-gradient(90deg,#374151 25%,#4b5563 50%,#374151 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px}@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}@keyframes spin{to{transform:rotate(360deg)}}::-webkit-scrollbar{height:8px;width:8px}::-webkit-scrollbar-track{background:#1f2937;border-radius:4px}::-webkit-scrollbar-thumb{background:#4b5563;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#6b7280}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.75);backdrop-filter:blur(5px)}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background:rgba(31,41,55,.95);backdrop-filter:blur(20px);margin:auto;padding:0;border:1px solid rgba(75,85,99,.5);border-radius:1rem;width:90%;max-width:900px;max-height:90vh;overflow-y:auto;animation:modalSlideIn .3s ease-out}@keyframes modalSlideIn{from{opacity:0;transform:translateY(-50px)}to{opacity:1;transform:translateY(0)}}.clickable{cursor:pointer;transition:transform .2s,background .2s}.clickable:hover{transform:scale(1.02);background:rgba(75,85,99,.6)!important}.stat-card{background:rgba(55,65,81,.5);border:1px solid rgba(75,85,99,.5);transition:all .2s ease}.stat-card:hover{background:rgba(55,65,81,.7);border-color:rgba(107,114,128,.6)}.ventusky-iframe-container{position:relative;width:100%;border-radius:.75rem;overflow:hidden;height:0;padding-bottom:100%;pointer-events:auto}@media (max-width:768px){.ventusky-iframe-container{padding-bottom:180%}}.ventusky-iframe-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:auto}@supports selector(:has(*)){.ventusky-iframe-container:has(iframe){overflow:hidden}}footer span{filter:grayscale(100%) brightness(0) invert(1) opacity(.6);display:inline-block}@media (max-width:768px){.ventusky-iframe-container::after{content:'';position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(to top,rgba(26,26,46,.95) 0,rgba(26,26,46,0) 100%);pointer-events:none;z-index:10;border-radius:0 0 .75rem .75rem}}.search-input{background:rgba(55,65,81,.6);border:1px solid rgba(75,85,99,.5);transition:all .2s ease}.search-input:focus{background:rgba(55,65,81,.8);border-color:rgba(107,114,128,.7);box-shadow:0 0 0 3px rgba(107,114,128,.2)}.btn{background:rgba(55,65,81,.6);border:1px solid rgba(75,85,99,.5);transition:all .2s ease}.btn:hover{background:rgba(75,85,99,.7);border-color:rgba(107,114,128,.6)}.source-pill{background:rgba(55,65,81,.5);border:1px solid rgba(75,85,99,.5);color:rgba(229,231,235,.9);transition:all .2s ease}.source-pill:hover{background:rgba(75,85,99,.65);color:#fff}.source-pill.active{background:rgba(59,130,246,.3);border-color:rgba(96,165,250,.75);color:#fff}.formula-container{background:rgba(31,41,55,.5);border-radius:.5rem;padding:1rem;text-align:center}.formula-container mjx-container{max-width:100%!important}@media (max-width:640px){.formula-container{padding:.75rem .5rem;font-size:.85em}}</style></head><body class=\"text-white p-4 md:p-8\"><div class=\"max-w-6xl mx-auto\"><header class=\"text-center mb-8\"><h1 class=\"text-3xl md:text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3\"><span class=\"text-4xl\">üå§Ô∏è</span> Jaccuweather</h1><p class=\"text-gray-400 text-sm\">Powered by Open-Meteo & Ventusky</p></header><div id=\"weatherAlerts\" class=\"hidden mb-6 max-w-6xl mx-auto space-y-3\"></div><div class=\"mb-6 px-2\"><div class=\"flex flex-wrap gap-2 max-w-2xl mx-auto\"><input id=\"locationInput\" placeholder=\"Search for a city or location...\" class=\"search-input flex-1 min-w-[200px] px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none\"><div class=\"flex gap-2\"><button id=\"searchBtn\" class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\"><i class=\"fas fa-search\"></i></button> <button id=\"locationBtn\" class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\" title=\"Use current location\"><i class=\"fas fa-location-arrow\"></i></button><div class=\"relative\"><button id=\"favoritesBtn\" class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\" title=\"Favorites\"><i class=\"fas fa-star\"></i></button><div id=\"favoritesDropdown\" class=\"hidden absolute right-0 mt-2 w-64 card rounded-xl shadow-xl z-50 max-h-96 overflow-y-auto\"><div class=\"p-3 border-b border-gray-600/50\"><div class=\"flex items-center justify-between\"><h3 class=\"text-white font-semibold\">Favorites</h3><button id=\"addFavoriteBtn\" class=\"text-gray-400 hover:text-white text-sm\"><i class=\"fas fa-plus mr-1\"></i>Add Current</button></div></div><div id=\"favoritesList\" class=\"p-2\"></div><div id=\"noFavorites\" class=\"p-4 text-gray-400 text-sm text-center hidden\">No favorites yet. Add your current location to get started.</div></div></div></div></div></div><div id=\"errorMessage\" class=\"hidden max-w-2xl mx-auto mb-4 p-4 bg-red-900/40 rounded-xl text-white border border-red-500/30\"><i class=\"fas fa-exclamation-circle mr-2\"></i> <span id=\"errorText\"></span></div><div id=\"loading\" class=\"hidden text-center py-12\"><div class=\"loading-spinner mx-auto mb-4\"></div><p class=\"text-gray-300\">Loading weather data...</p></div><div id=\"weatherContent\" class=\"hidden\"><section class=\"card rounded-2xl p-6 md:p-8 mb-6\"><div class=\"flex flex-col md:flex-row justify-between items-start md:items-center mb-6\"><div><h2 id=\"currentLocation\" class=\"text-2xl md:text-3xl font-bold text-white mb-2\"></h2><p id=\"currentDate\" class=\"text-gray-400\"></p><p id=\"lastUpdated\" class=\"text-gray-500 text-xs mt-1\"></p></div><div class=\"text-left md:text-right mt-4 md:mt-0\"><div class=\"flex flex-col md:flex-row md:items-end md:justify-end md:gap-3\"><div id=\"currentTemp\" class=\"text-4xl md:text-6xl font-bold text-white\"></div><div id=\"currentHighLow\" class=\"text-sm md:text-lg text-gray-300 md:mb-2\"></div></div><p id=\"currentCondition\" class=\"text-lg md:text-xl text-gray-300\"></p></div></div><div class=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-8 gap-3\"><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-thermometer-half text-orange-400 mr-1\"></i>Feels Like</div><div id=\"feelsLike\" class=\"text-xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tint text-blue-400 mr-1\"></i>Humidity</div><div id=\"humidity\" class=\"text-xl font-bold text-white\"></div><div class=\"text-gray-500 text-xs mt-1\">Dew: <span id=\"dewPoint\" class=\"text-gray-300\">--</span></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-wind text-cyan-400 mr-1\"></i>Wind</div><div id=\"windSpeed\" class=\"text-xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-sun text-yellow-400 mr-1\"></i>UV Index</div><div id=\"uvIndex\" class=\"text-xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-sun text-yellow-500 mr-1\"></i>Sun</div><div class=\"text-white\"><span class=\"text-yellow-400 text-xs\">‚Üë</span> <span id=\"sunrise\" class=\"text-sm font-semibold\">--</span></div><div class=\"text-white mt-0.5\"><span class=\"text-orange-400 text-xs\">‚Üì</span> <span id=\"sunset\" class=\"text-sm font-semibold\">--</span></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-gauge text-green-400 mr-1\"></i>Pressure</div><div class=\"flex items-center gap-1\"><span id=\"pressure\" class=\"text-xl font-bold text-white\">--</span> <span id=\"pressureTrend\" class=\"text-sm\"></span></div><div id=\"pressureStatus\" class=\"text-gray-500 text-xs\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-moon text-purple-400 mr-1\"></i>Moon <i class=\"fas fa-info-circle text-xs ml-1\"></i></div><div id=\"moonPhase\" class=\"flex items-center gap-2\"><span id=\"moonPhaseEmoji\" class=\"text-xl\"></span> <span id=\"moonPhaseName\" class=\"text-xs font-semibold text-white\"></span></div></div><div id=\"airQualitySection\" class=\"stat-card rounded-xl p-4 hidden\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-lungs text-green-400 mr-1\"></i>Air Quality</div><div id=\"aqiValue\" class=\"text-xl font-bold text-white\"></div><div id=\"aqiStatus\" class=\"text-gray-500 text-xs\"></div></div><div id=\"sinusRiskSection\" class=\"stat-card rounded-xl p-4 cursor-pointer hover:bg-gray-600/50 transition-colors\" onclick=\"openSymptomRiskModal('sinus')\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-head-side-cough text-blue-300 mr-1\"></i>Sinus <i class=\"fas fa-info-circle text-xs ml-1\"></i></div><div id=\"sinusRiskValue\" class=\"text-2xl font-bold text-white\"></div><div id=\"sinusRiskLabel\" class=\"text-xs mt-1\"></div></div><div id=\"allergyRiskSection\" class=\"stat-card rounded-xl p-4 cursor-pointer hover:bg-gray-600/50 transition-colors\" onclick=\"openSymptomRiskModal('allergy')\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-green-300 mr-1\"></i>Allergy <i class=\"fas fa-info-circle text-xs ml-1\"></i></div><div id=\"allergyRiskValue\" class=\"text-2xl font-bold text-white\"></div><div id=\"allergyRiskLabel\" class=\"text-xs mt-1\"></div></div></div></section><section id=\"snowForecastSection\" class=\"card rounded-2xl p-6 md:p-8 mb-6\"><div class=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4\"><div><h3 class=\"text-xl font-bold text-white flex items-center gap-2\"><span class=\"text-2xl\">‚ùÑÔ∏è</span> Snow Forecast</h3><p id=\"snowForecastSourceDescription\" class=\"text-gray-400 text-sm mt-1\"></p></div><div class=\"inline-flex rounded-full p-1 bg-gray-900/40 border border-gray-600/40\"><button id=\"snowSourceNws\" class=\"source-pill active px-4 py-1.5 rounded-full text-sm font-semibold\" type=\"button\">NWS</button> <button id=\"snowSourceEnsemble\" class=\"source-pill px-4 py-1.5 rounded-full text-sm font-semibold\" type=\"button\">Ensemble</button></div></div><div id=\"snowForecastLoading\" class=\"hidden flex items-center gap-3 text-gray-300\"><div class=\"loading-spinner\"></div><span class=\"text-sm\">Loading snow forecast...</span></div><div id=\"snowForecastResult\" class=\"text-white text-lg font-semibold\"></div><p id=\"snowForecastMeta\" class=\"text-gray-400 text-xs mt-2\"></p></section><div id=\"precipTimingSection\" class=\"hidden mb-6\"><div class=\"card rounded-2xl p-4 md:p-6\"><div class=\"flex items-center gap-3\"><span class=\"text-2xl\" id=\"precipIcon\">üåßÔ∏è</span><p id=\"precipTiming\" class=\"text-white font-medium\"></p></div></div></div><section id=\"weeklySnowSection\" class=\"hidden card rounded-2xl p-6 md:p-8 mb-6\"><h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\"><span class=\"text-2xl\">‚ùÑÔ∏è</span> Weekly Snow Totals</h3><div id=\"weeklySnowContent\" class=\"space-y-2\"></div></section><section id=\"pollenSection\" class=\"hidden card rounded-2xl p-6 md:p-8 mb-6\"><h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\"><span class=\"text-2xl\">üåø</span> Pollen Forecast</h3><div class=\"mb-6\"><h4 class=\"text-sm font-semibold text-gray-400 mb-3\">Current Levels</h4><div class=\"grid grid-cols-3 gap-3\"><div class=\"stat-card rounded-xl p-4 text-center\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tree text-green-400 mr-1\"></i>Tree</div><div id=\"pollenTreeValue\" class=\"text-xl font-bold text-white\"></div><div id=\"pollenTreeLabel\" class=\"text-xs mt-1\"></div></div><div class=\"stat-card rounded-xl p-4 text-center\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-leaf text-lime-400 mr-1\"></i>Grass</div><div id=\"pollenGrassValue\" class=\"text-xl font-bold text-white\"></div><div id=\"pollenGrassLabel\" class=\"text-xs mt-1\"></div></div><div class=\"stat-card rounded-xl p-4 text-center\"><div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-amber-400 mr-1\"></i>Weed</div><div id=\"pollenWeedValue\" class=\"text-xl font-bold text-white\"></div><div id=\"pollenWeedLabel\" class=\"text-xs mt-1\"></div></div></div></div><div><h4 class=\"text-sm font-semibold text-gray-400 mb-3\">5-Day Forecast</h4><div id=\"pollenForecast\" class=\"space-y-2\"></div></div><div class=\"mt-4 pt-4 border-t border-gray-600/30\"><p class=\"text-gray-500 text-xs\"><i class=\"fas fa-tree text-green-400 mr-1\"></i><strong>Tree:</strong> Alder, Birch, Olive &nbsp;|&nbsp; <i class=\"fas fa-leaf text-lime-400 mr-1\"></i><strong>Grass:</strong> General &nbsp;|&nbsp; <i class=\"fas fa-seedling text-amber-400 mr-1\"></i><strong>Weed:</strong> Mugwort, Ragweed</p></div></section><section class=\"card rounded-2xl p-6 md:p-8 mb-6\"><h3 class=\"text-xl font-bold text-white mb-4 cursor-pointer hover:text-gray-300 transition-colors flex items-center gap-2\" id=\"hourlyHeader\"><span class=\"text-2xl\">‚è∞</span> 24-Hour Forecast <i class=\"fas fa-external-link-alt ml-2 text-sm text-gray-400\"></i></h3><div id=\"hourlyForecast\" class=\"overflow-x-auto\"><div class=\"flex gap-3 min-w-max pb-2\"></div></div></section><section class=\"card rounded-2xl p-6 md:p-8 mb-6\"><h3 class=\"text-xl font-bold text-white mb-4 cursor-pointer hover:text-gray-300 transition-colors flex items-center gap-2\" id=\"dailyHeader\"><span class=\"text-2xl\">üìÖ</span> 14-Day Forecast <i class=\"fas fa-external-link-alt ml-2 text-sm text-gray-400\"></i></h3><div id=\"dailyForecast\" class=\"space-y-2\"></div></section><section class=\"card rounded-2xl p-6 md:p-8\"><h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\"><span class=\"text-2xl\">üì°</span> Weather Radar</h3><div id=\"radarContainer\" class=\"relative\"><div id=\"ventuskyContainer\" class=\"ventusky-iframe-container\"><iframe id=\"ventuskyFrame\" src=\"\" style=\"border:none\" allowfullscreen loading=\"lazy\" sandbox=\"allow-same-origin allow-scripts allow-popups allow-forms\" referrerpolicy=\"no-referrer-when-downgrade\"></iframe></div></div></section></div></div><div id=\"hourlyModal\" class=\"modal\"><div class=\"modal-content p-6 md:p-8\"><div class=\"flex justify-between items-center mb-6\"><div><h2 class=\"text-2xl font-bold text-white flex items-center gap-2\"><span class=\"text-3xl\">‚è∞</span> 24-Hour Detailed Forecast</h2><div class=\"mt-3\"><select id=\"hourlyChartSelect\" class=\"bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"><option value=\"all\">All Charts</option><option value=\"temp\">Temperature</option><option value=\"precip\">Precipitation</option><option value=\"wind\">Wind Speed</option><option value=\"humidity\">Humidity</option><option value=\"pressure\">Pressure</option><option value=\"snow\">Snowfall</option></select></div></div><button id=\"closeHourlyModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\"><i class=\"fas fa-times\"></i></button></div><div class=\"space-y-6\"><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"temp\"><canvas id=\"hourlyTempChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"precip\"><canvas id=\"hourlyPrecipChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"wind\"><canvas id=\"hourlyWindChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"humidity\"><canvas id=\"hourlyHumidityChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"pressure\"><canvas id=\"hourlyPressureChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"snow\"><canvas id=\"hourlySnowChart\" style=\"height:250px\"></canvas></div><div id=\"hourlyDetails\" class=\"grid grid-cols-1 md:grid-cols-2 gap-4\"></div></div></div></div><div id=\"dailyModal\" class=\"modal\"><div class=\"modal-content p-6 md:p-8\"><div class=\"flex justify-between items-center mb-6\"><div><h2 class=\"text-2xl font-bold text-white flex items-center gap-2\"><span class=\"text-3xl\">üìÖ</span> 14-Day Detailed Forecast</h2><div class=\"mt-3\"><select id=\"dailyChartSelect\" class=\"bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\"><option value=\"all\">All Charts</option><option value=\"temp\">Temperature</option><option value=\"feelslike\">Feels Like</option><option value=\"precip\">Precipitation</option><option value=\"wind\">Wind Speed</option><option value=\"pressure\">Pressure</option><option value=\"snow\">Snowfall</option><option value=\"moon\">Moon Phase</option></select></div></div><button id=\"closeDailyModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\"><i class=\"fas fa-times\"></i></button></div><div class=\"space-y-6\"><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"temp\"><canvas id=\"dailyTempChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"feelslike\"><canvas id=\"dailyFeelsLikeChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"precip\"><canvas id=\"dailyPrecipChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"wind\"><canvas id=\"dailyWindChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"pressure\"><canvas id=\"dailyPressureChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"snow\"><canvas id=\"dailySnowChart\" style=\"height:250px\"></canvas></div><div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"moon\"><canvas id=\"dailyMoonPhaseChart\" style=\"height:250px\"></canvas></div><div id=\"dailyDetails\" class=\"space-y-3\"></div></div></div></div><div id=\"moonDetailsModal\" class=\"modal\"><div class=\"modal-content p-6 md:p-8 max-w-2xl\"><div class=\"flex justify-between items-center mb-6\"><h2 class=\"text-2xl font-bold text-white flex items-center gap-2\"><span class=\"text-3xl\">üåô</span> Moon Details</h2><button id=\"closeMoonDetailsModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\"><i class=\"fas fa-times\"></i></button></div><div class=\"space-y-6\"><div class=\"text-center\"><div id=\"moonDetailsEmoji\" class=\"text-8xl mb-4\"></div><div id=\"moonDetailsName\" class=\"text-2xl font-bold text-white mb-2\"></div><div id=\"moonDetailsDate\" class=\"text-gray-400\"></div></div><div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\"><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-sun text-yellow-400 mr-1\"></i>Illumination</div><div id=\"moonIllumination\" class=\"text-2xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-arrow-up text-blue-400 mr-1\"></i>Moonrise</div><div id=\"moonRise\" class=\"text-2xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-arrow-down text-orange-400 mr-1\"></i>Moonset</div><div id=\"moonSet\" class=\"text-2xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-ruler text-purple-400 mr-1\"></i>Distance</div><div id=\"moonDistance\" class=\"text-2xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-calendar text-green-400 mr-1\"></i>Next Full Moon</div><div id=\"nextFullMoon\" class=\"text-2xl font-bold text-white\"></div></div><div class=\"stat-card rounded-xl p-4\"><div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-calendar text-gray-300 mr-1\"></i>Next New Moon</div><div id=\"nextNewMoon\" class=\"text-2xl font-bold text-white\"></div></div></div></div></div></div><div id=\"symptomRiskModal\" class=\"modal\"><div class=\"modal-content p-6 md:p-8 max-w-3xl\"><div class=\"flex justify-between items-center mb-6\"><h2 id=\"symptomRiskModalTitle\" class=\"text-2xl font-bold text-white flex items-center gap-2\"><span class=\"text-3xl\" id=\"symptomRiskModalIcon\"></span> <span id=\"symptomRiskModalTitleText\"></span></h2><button id=\"closeSymptomRiskModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\"><i class=\"fas fa-times\"></i></button></div><div class=\"mb-6\"><h3 class=\"text-lg font-semibold text-white mb-3\">Current Values</h3><div id=\"symptomCurrentValues\" class=\"grid grid-cols-2 md:grid-cols-4 gap-3\"></div></div><div class=\"space-y-6\"><div id=\"sinusFormulaSection\" class=\"hidden\"><h3 class=\"text-lg font-semibold text-white mb-3\"><i class=\"fas fa-head-side-cough text-blue-300 mr-2\"></i>Sinus Risk Calculation</h3><div class=\"stat-card rounded-xl p-5 space-y-4\"><p class=\"text-gray-300 text-sm mb-4\">Sinus symptoms are often triggered by rapid barometric pressure changes, high humidity, and temperature fluctuations. This index aggregates key meteorological factors associated with sinus discomfort.</p><div class=\"formula-container\"><div class=\"text-white\"> \\[ \\text{Sinus Risk} = \\sum \\text{(Factors)} \\] </div></div><h4 class=\"text-white font-semibold mt-4\">Factor Scoring:</h4><div class=\"space-y-3\"><div class=\"stat-card rounded-lg p-3\"><div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-tachometer-alt mr-2\"></i>Pressure Change (inHg)</div><div class=\"text-gray-300 text-sm mb-2\">Day-over-day barometric pressure change:</div><div class=\"formula-container\"> \\[ \\Delta P = P_{\\text{today}} - P_{\\text{yesterday}} \\] </div><ul class=\"text-gray-400 text-sm mt-2 space-y-1\"><li>‚Ä¢ \\(\\Delta P < -0.30\\) inHg ‚Üí <span class=\"text-red-400 font-semibold\">+5 points</span> (severe drop)</li><li>‚Ä¢ \\(-0.30 \\leq \\Delta P < -0.18\\) inHg ‚Üí <span class=\"text-orange-400 font-semibold\">+3 points</span></li><li>‚Ä¢ \\(-0.18 \\leq \\Delta P < -0.10\\) inHg ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></li></ul></div><div class=\"stat-card rounded-lg p-3\"><div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-tint mr-2\"></i>Humidity</div><div class=\"text-gray-400 text-sm\">‚Ä¢ Humidity \\(> 70\\%\\) ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span></div></div><div class=\"stat-card rounded-lg p-3\"><div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-cloud-rain mr-2\"></i>Precipitation</div><div class=\"text-gray-400 text-sm\">‚Ä¢ Precipitation \\(> 0.1\\) in ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span></div></div><div class=\"stat-card rounded-lg p-3\"><div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-thermometer-half mr-2\"></i>Temperature Swing</div><div class=\"text-gray-300 text-sm mb-2\">Daily high-low difference:</div><div class=\"formula-container\"> \\[ \\Delta T = T_{\\max} - T_{\\min} \\] </div><div class=\"text-gray-400 text-sm mt-2\">‚Ä¢ \\(\\Delta T > 20¬∞F\\) ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span></div></div></div></div></div><div id=\"allergyFormulaSection\" class=\"hidden\"><h3 class=\"text-lg font-semibold text-white mb-3\"><i class=\"fas fa-seedling text-green-300 mr-2\"></i>Allergy Risk Calculation</h3><div class=\"stat-card rounded-xl p-5 space-y-4\"><p class=\"text-gray-300 text-sm mb-4\">This calculation uses real pollen data from Open-Meteo, measuring actual pollen counts (grains/m¬≥) for tree, grass, and weed pollen to provide accurate allergy risk assessment.</p><div class=\"formula-container\"><div class=\"text-white\"> \\[ \\text{Allergy Risk} = \\sum \\text{(Factors)} \\] </div></div><h4 class=\"text-white font-semibold mt-4\">Factor Scoring:</h4><div class=\"space-y-3 mt-3\"><div class=\"stat-card rounded-lg p-3\"><div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-leaf mr-2\"></i>Pollen Count (max of Tree/Grass/Weed)</div><ul class=\"text-gray-400 text-sm space-y-1\"><li>‚Ä¢ \\(P > 200\\) grains/m¬≥ (Very High) ‚Üí <span class=\"text-red-400 font-semibold\">+5 points</span></li><li>‚Ä¢ \\(80 < P \\leq 200\\) grains/m¬≥ (High) ‚Üí <span class=\"text-orange-400 font-semibold\">+4 points</span></li><li>‚Ä¢ \\(20 < P \\leq 80\\) grains/m¬≥ (Moderate) ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></li><li>‚Ä¢ \\(0 < P \\leq 20\\) grains/m¬≥ (Low) ‚Üí <span class=\"text-green-400 font-semibold\">+1 point</span></li></ul></div><div class=\"stat-card rounded-lg p-3\"><div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-wind mr-2\"></i>Wind (disperses pollen)</div><div class=\"text-gray-400 text-sm\">‚Ä¢ Wind \\(> 10\\) mph ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></div></div><div class=\"stat-card rounded-lg p-3\"><div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-cloud-rain mr-2\"></i>Rain Washout</div><div class=\"text-gray-400 text-sm\">‚Ä¢ Precipitation \\(> 0.1\\) in ‚Üí <span class=\"text-green-400 font-semibold\">‚àí2 points</span></div></div></div></div></div><div class=\"mt-6\"><h3 class=\"text-lg font-semibold text-white mb-3\">Risk Level Scale</h3><div class=\"grid grid-cols-2 md:grid-cols-4 gap-3\"><div class=\"stat-card rounded-lg p-3 text-center\"><div class=\"text-green-400 font-bold text-xl\">0-2</div><div class=\"text-gray-400 text-sm\">Low</div></div><div class=\"stat-card rounded-lg p-3 text-center\"><div class=\"text-yellow-400 font-bold text-xl\">3-4</div><div class=\"text-gray-400 text-sm\">Moderate</div></div><div class=\"stat-card rounded-lg p-3 text-center\"><div class=\"text-orange-400 font-bold text-xl\">5-7</div><div class=\"text-gray-400 text-sm\">High</div></div><div class=\"stat-card rounded-lg p-3 text-center\"><div class=\"text-red-400 font-bold text-xl\">8-10</div><div class=\"text-gray-400 text-sm\">Very High</div></div></div></div><p class=\"text-gray-500 text-xs mt-4 text-center\"><i class=\"fas fa-info-circle mr-1\"></i> These indices are estimates based on meteorological data and general associations. Individual sensitivity may vary. Consult a healthcare provider for medical advice.</p></div></div></div><script src=\"app.js\"></script><footer class=\"text-center mt-8 mb-4 py-4 border-t border-gray-700/50\"><p class=\"text-gray-500 text-sm\">Vibecoded with <span class=\"text-gray-500\">‚ù§Ô∏è</span> by Jack A, maintained by TARS</p><p class=\"text-gray-600 text-xs mt-2\">Weather data provided by Open-Meteo</p><a href=\"https://strike.me/anglim3\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"inline-flex items-center gap-2 mt-3 px-4 py-2 text-sm text-gray-400 hover:text-white bg-gray-800/50 hover:bg-gray-700/50 border border-gray-600/50 hover:border-gray-500/50 rounded-lg transition-all\"><svg class=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M23.638 14.904c-1.602 6.43-8.113 10.34-14.542 8.736C2.67 22.05-1.244 15.525.362 9.105 1.962 2.67 8.475-1.243 14.9.358c6.43 1.605 10.342 8.115 8.738 14.548v-.002zm-6.35-4.613c.24-1.59-.974-2.45-2.64-3.03l.54-2.153-1.315-.33-.525 2.107c-.345-.087-.705-.167-1.064-.25l.526-2.127-1.32-.33-.54 2.165c-.285-.067-.565-.132-.84-.2l-1.815-.45-.35 1.407s.975.225.955.236c.535.136.63.486.615.766l-1.477 5.92c-.075.166-.24.406-.614.314.015.02-.96-.24-.96-.24l-.66 1.51 1.71.426.93.242-.54 2.19 1.32.327.54-2.17c.36.1.705.19 1.05.273l-.51 2.154 1.32.33.545-2.19c2.24.427 3.93.257 4.64-1.774.57-1.637-.03-2.58-1.217-3.196.854-.193 1.5-.76 1.68-1.93h.01zm-3.01 4.22c-.404 1.64-3.157.75-4.05.53l.72-2.9c.896.23 3.757.67 3.33 2.37zm.41-4.24c-.37 1.49-2.662.735-3.405.55l.654-2.64c.744.18 3.137.52 2.75 2.084v.006z\"/></svg> Donate</a></footer></body></html>";
const JS_CONTENT = "let currentLat=null,currentLon=null,currentLocationName=null,currentWeatherData=null,favorites=[],hourlyChart=null,dailyChart=null,snowForecastSource=localStorage.getItem(\"snowForecastSource\")||\"nws\",snowForecastRequestId=0;const US_BOUNDS={minLat:24,maxLat:50,minLon:-125,maxLon:-66};function formatUnit(e){return e?e.replace(\"mp/h\",\"mph\"):\"\"}function sleep(e){return new Promise(t=>setTimeout(t,e))}function isLikelyUsLocation(e,t){return e>=US_BOUNDS.minLat&&e<=US_BOUNDS.maxLat&&t>=US_BOUNDS.minLon&&t<=US_BOUNDS.maxLon}function getSnowForecastElements(){return{nwsBtn:document.getElementById(\"snowSourceNws\"),ensembleBtn:document.getElementById(\"snowSourceEnsemble\"),description:document.getElementById(\"snowForecastSourceDescription\"),loading:document.getElementById(\"snowForecastLoading\"),result:document.getElementById(\"snowForecastResult\"),meta:document.getElementById(\"snowForecastMeta\")}}function updateSnowSourceToggleUi(){const{nwsBtn:e,ensembleBtn:t,description:n}=getSnowForecastElements();if(!e||!t||!n)return;const a=\"nws\"===snowForecastSource;e.classList.toggle(\"active\",a),t.classList.toggle(\"active\",!a),n.textContent=a?\"NWS Forecast: US National Weather Service quantitative snowfall guidance (next 48h total).\":\"Ensemble Forecast: Multi-member snowfall spread (p10-p90, median) from Open-Meteo ensemble.\"}function showSnowForecastLoading(e){const{loading:t,result:n,meta:a}=getSnowForecastElements();t&&n&&a&&(t.classList.toggle(\"hidden\",!e),e&&(n.textContent=\"\",a.textContent=\"\"))}function setSnowForecastResult(e,t=\"\"){const{result:n,meta:a}=getSnowForecastElements();n&&a&&(n.textContent=e,a.textContent=t)}async function fetchWith503Retry(e,t={},n=2){let a=0;for(;a<=n;){const o=await fetch(e,t);if(503!==o.status||a===n)return o;a++,await sleep(1e3)}}function extractDurationHours(e){if(!e)return 0;const t=e.match(/(\\d+)D/),n=e.match(/(\\d+)H/),a=e.match(/(\\d+)M/);return 24*(t?Number(t[1]):0)+(n?Number(n[1]):0)+(a?Number(a[1]):0)/60}function overlapHours(e,t,n,a){const o=Math.max(e.getTime(),n.getTime()),i=Math.min(t.getTime(),a.getTime());return i<=o?0:(i-o)/36e5}function percentile(e,t){if(!e.length)return 0;if(1===e.length)return e[0];const n=(e.length-1)*t,a=Math.floor(n),o=Math.ceil(n);if(a===o)return e[a];const i=n-a;return e[a]*(1-i)+e[o]*i}let favoritesDB=null;function initFavoritesDB(){return new Promise((e,t)=>{const n=indexedDB.open(\"WeatherAppDB\",1);n.onerror=()=>t(n.error),n.onsuccess=()=>{favoritesDB=n.result,e(favoritesDB)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(\"favorites\")||t.createObjectStore(\"favorites\",{keyPath:\"id\",autoIncrement:!0})}})}async function loadFavorites(){try{favoritesDB||await initFavoritesDB();const e=favoritesDB.transaction([\"favorites\"],\"readonly\").objectStore(\"favorites\").getAll();e.onsuccess=()=>{const t=e.result;if(0===t.length){const e=localStorage.getItem(\"weatherFavorites\");if(e)try{const t=JSON.parse(e);if(t&&t.length>0)return favorites=t,void saveFavorites()}catch(e){console.error(\"Error parsing localStorage favorites:\",e)}}favorites=t.map(e=>({name:e.name,lat:e.lat,lon:e.lon})),renderFavorites()},e.onerror=()=>{console.error(\"Error loading favorites from IndexedDB\");const e=localStorage.getItem(\"weatherFavorites\");if(e)try{favorites=JSON.parse(e)}catch(e){favorites=[]}renderFavorites()}}catch(e){console.error(\"Error initializing favorites DB:\",e);const t=localStorage.getItem(\"weatherFavorites\");if(t)try{favorites=JSON.parse(t)}catch(e){favorites=[]}renderFavorites()}}async function saveFavorites(){try{favoritesDB||await initFavoritesDB();const e=favoritesDB.transaction([\"favorites\"],\"readwrite\").objectStore(\"favorites\");await new Promise((t,n)=>{const a=e.clear();a.onsuccess=()=>t(),a.onerror=()=>n(a.error)});const t=favorites.map(t=>new Promise((n,a)=>{const o=e.add(t);o.onsuccess=()=>n(),o.onerror=()=>a(o.error)}));await Promise.all(t),localStorage.setItem(\"weatherFavorites\",JSON.stringify(favorites)),renderFavorites()}catch(e){console.error(\"Error saving favorites to IndexedDB:\",e);try{localStorage.setItem(\"weatherFavorites\",JSON.stringify(favorites))}catch(e){console.error(\"Error saving to localStorage:\",e)}renderFavorites()}}function addFavorite(){currentLat&&currentLon&&currentLocationName?favorites.some(e=>Math.abs(e.lat-currentLat)<.001&&Math.abs(e.lon-currentLon)<.001)?alert(\"This location is already in your favorites.\"):(favorites.push({name:currentLocationName,lat:currentLat,lon:currentLon}),saveFavorites()):alert(\"Please search for a location first or use your current location.\")}function removeFavorite(e){favorites.splice(e,1),saveFavorites()}function switchToFavorite(e,t,n){currentLocationName=n,fetchWeather(e,t),document.getElementById(\"favoritesDropdown\").classList.add(\"hidden\")}function renderFavorites(){const e=document.getElementById(\"favoritesList\"),t=document.getElementById(\"noFavorites\");e.innerHTML=\"\",0===favorites.length?(t.classList.remove(\"hidden\"),e.classList.add(\"hidden\")):(t.classList.add(\"hidden\"),e.classList.remove(\"hidden\"),favorites.forEach((t,n)=>{const a=document.createElement(\"div\");a.className=\"flex items-center justify-between p-3 hover:bg-white/10 rounded-lg mb-1\";const o=document.createElement(\"div\");o.className=\"flex-1 cursor-pointer\",o.innerHTML=`\\n                <div class=\"text-white font-semibold\">${t.name}</div>\\n                <div class=\"text-white/60 text-xs\">${t.lat.toFixed(4)}, ${t.lon.toFixed(4)}</div>\\n            `,o.addEventListener(\"click\",()=>switchToFavorite(t.lat,t.lon,t.name));const i=document.createElement(\"button\");i.className=\"text-red-400 hover:text-red-300 ml-2 p-1\",i.innerHTML='<i class=\"fas fa-trash\"></i>',i.addEventListener(\"click\",e=>{e.stopPropagation(),removeFavorite(n)}),a.appendChild(o),a.appendChild(i),e.appendChild(a)}))}const originalWindowOpen=window.open;window.open=function(e,t,n){return e&&(e.includes(\"ventusky.com\")||e.includes(\"ventusky\"))?(console.log(\"Blocked Ventusky window.open:\",e),null):\"_blank\"===t&&e&&(e.includes(\"ventusky.com\")||e.includes(\"ventusky\"))?(console.log(\"Blocked Ventusky _blank link:\",e),null):originalWindowOpen.apply(this,arguments)},window.addEventListener(\"message\",e=>{if(e.origin.includes(\"ventusky.com\")&&e.data&&(\"string\"==typeof e.data||\"object\"==typeof e.data)){const t=JSON.stringify(e.data);if(t.includes(\"open\")||t.includes(\"navigate\")||t.includes(\"window\"))return console.log(\"Blocked Ventusky postMessage:\",e.data),e.stopPropagation(),!1}},{capture:!0}),window.addEventListener(\"DOMContentLoaded\",()=>{\"nws\"!==snowForecastSource&&\"ensemble\"!==snowForecastSource&&(snowForecastSource=\"nws\",localStorage.setItem(\"snowForecastSource\",snowForecastSource)),updateSnowSourceToggleUi();const e=document.getElementById(\"snowSourceNws\"),t=document.getElementById(\"snowSourceEnsemble\");e&&t&&(e.addEventListener(\"click\",()=>handleSnowSourceChange(\"nws\")),t.addEventListener(\"click\",()=>handleSnowSourceChange(\"ensemble\"))),loadFavorites(),document.getElementById(\"favoritesBtn\").addEventListener(\"click\",e=>{e.stopPropagation(),document.getElementById(\"favoritesDropdown\").classList.toggle(\"hidden\")}),document.getElementById(\"addFavoriteBtn\").addEventListener(\"click\",e=>{e.stopPropagation(),addFavorite()}),document.addEventListener(\"click\",e=>{const t=document.getElementById(\"favoritesDropdown\"),n=document.getElementById(\"favoritesBtn\");t.contains(e.target)||n.contains(e.target)||t.classList.add(\"hidden\")}),navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{currentLat=e.coords.latitude,currentLon=e.coords.longitude,fetchWeather(currentLat,currentLon)},()=>{fetchWeather(51.5074,-.1278)}):fetchWeather(51.5074,-.1278)}),document.getElementById(\"searchBtn\").addEventListener(\"click\",handleSearch),document.getElementById(\"locationInput\").addEventListener(\"keypress\",e=>{\"Enter\"===e.key&&handleSearch()}),document.getElementById(\"locationBtn\").addEventListener(\"click\",()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{currentLat=e.coords.latitude,currentLon=e.coords.longitude,fetchWeather(currentLat,currentLon)},()=>showError(\"Unable to get your location. Please search for a city.\")):showError(\"Geolocation is not supported by your browser.\")});const STATE_ABBREVIATIONS={AL:\"Alabama\",AK:\"Alaska\",AZ:\"Arizona\",AR:\"Arkansas\",CA:\"California\",CO:\"Colorado\",CT:\"Connecticut\",DE:\"Delaware\",FL:\"Florida\",GA:\"Georgia\",HI:\"Hawaii\",ID:\"Idaho\",IL:\"Illinois\",IN:\"Indiana\",IA:\"Iowa\",KS:\"Kansas\",KY:\"Kentucky\",LA:\"Louisiana\",ME:\"Maine\",MD:\"Maryland\",MA:\"Massachusetts\",MI:\"Michigan\",MN:\"Minnesota\",MS:\"Mississippi\",MO:\"Missouri\",MT:\"Montana\",NE:\"Nebraska\",NV:\"Nevada\",NH:\"New Hampshire\",NJ:\"New Jersey\",NM:\"New Mexico\",NY:\"New York\",NC:\"North Carolina\",ND:\"North Dakota\",OH:\"Ohio\",OK:\"Oklahoma\",OR:\"Oregon\",PA:\"Pennsylvania\",RI:\"Rhode Island\",SC:\"South Carolina\",SD:\"South Dakota\",TN:\"Tennessee\",TX:\"Texas\",UT:\"Utah\",VT:\"Vermont\",VA:\"Virginia\",WA:\"Washington\",WV:\"West Virginia\",WI:\"Wisconsin\",WY:\"Wyoming\",DC:\"District of Columbia\"},STATE_NAMES_TO_ABBR={};function normalizeState(e){if(!e)return null;const t=e.trim();if(t.length<=2)return STATE_ABBREVIATIONS[t.toUpperCase()]||t;const n=t.toLowerCase();return STATE_NAMES_TO_ABBR[n]?STATE_ABBREVIATIONS[STATE_NAMES_TO_ABBR[n]]:t}function matchesState(e,t){if(!t)return!0;const n=(e.admin1||\"\").toLowerCase(),a=normalizeState(t).toLowerCase();return n===a||n.includes(a)||a.includes(n)}async function handleSearch(){const e=document.getElementById(\"locationInput\").value.trim();if(e)try{const t=e.split(\",\").map(e=>e.trim()),n=t[0],a=t.length>1?t[1]:null,o=t.length>2?t[2]:null;let i=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(n)}`;o&&(i+=`&country=${encodeURIComponent(o)}`),i+=\"&count=10\";const r=await fetch(i),s=await r.json();if(s.results&&s.results.length>0){let e=s.results[0];if(a){const t=s.results.find(e=>matchesState(e,a));t?e=t:console.log(\"State not found, using first result:\",e)}currentLat=e.latitude,currentLon=e.longitude;const t=e.name||e.admin1||e.admin2||\"\",n=e.country||\"\",o=e.admin1||\"\",i=n&&(n.includes(\"United States\")||\"US\"===n||\"USA\"===n);currentLocationName=t&&n?i&&o?`${t}, ${o}`:i?t:`${t}, ${n}`:t||o||null,fetchWeather(currentLat,currentLon)}else showError(\"Location not found. Please try another search.\")}catch(e){showError(\"Error searching for location. Please try again.\"),console.error(e)}}async function fetchWeather(e,t){currentLat=e,currentLon=t,showLoading(),hideError(),hideContent();try{const n=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,uv_index,weather_code,dewpoint_2m,surface_pressure&hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,precipitation_probability,precipitation,snowfall,surface_pressure&daily=weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,wind_speed_10m_max,precipitation_probability_max,snowfall_sum,sunrise,sunset&forecast_days=14&past_days=2&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=auto`);if(429===n.status)return void showError((await n.json().catch(()=>({error:!0,reason:\"Rate limit exceeded\"}))).reason||\"Rate limit exceeded. Please wait a moment and try again.\");if(!n.ok)return void showError((await n.json().catch(()=>({error:!0,reason:\"Failed to fetch weather data\"}))).reason||`Failed to fetch weather data (${n.status})`);const a=await n.json();if(a.error)return void showError(a.reason||\"Failed to fetch weather data\");if(!currentLocationName)try{const n=new AbortController,a=setTimeout(()=>n.abort(),5e3),o=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(e)}&longitude=${encodeURIComponent(t)}&localityLanguage=en`,{signal:n.signal});if(clearTimeout(a),!o.ok)throw new Error(`HTTP ${o.status}`);const i=await o.json();if(i){const e=i.city||i.locality||i.town||i.village||i.municipality||i.county,t=i.principalSubdivision,n=i.countryName,a=n&&(n.includes(\"United States\")||\"US\"===n||\"USA\"===n);e?currentLocationName=t&&a?`${e}, ${t}`:n&&!a?`${e}, ${n}`:e:t&&a?currentLocationName=t:n&&!a&&(currentLocationName=n)}}catch(e){console.error(\"Reverse geocoding failed:\",e.message)}currentWeatherData=a,displayWeather(a),updateSnowForecastForCurrentLocation(),initializeVentuskyRadar(e,t),fetchWeatherAlerts(e,t),fetchAirQuality(e,t)}catch(e){showError(\"Failed to fetch weather data. Please try again.\"),console.error(e)}finally{hideLoading()}}function displayWeather(e){let t=currentLocationName;if(t||(t=`${e.latitude.toFixed(2)}, ${e.longitude.toFixed(2)}`),document.getElementById(\"currentLocation\").textContent=t,document.getElementById(\"currentDate\").textContent=(new Date).toLocaleDateString(\"en-US\",{weekday:\"long\",year:\"numeric\",month:\"long\",day:\"numeric\"}),document.getElementById(\"lastUpdated\").textContent=`Updated ${formatLastUpdated(new Date)}`,document.getElementById(\"currentTemp\").textContent=`${Math.round(e.current.temperature_2m)}${e.current_units.temperature_2m}`,e.daily&&e.daily.temperature_2m_max&&void 0!==e.daily.temperature_2m_max[2]){const t=Math.round(e.daily.temperature_2m_max[2]),n=Math.round(e.daily.temperature_2m_min[2]),a=window.innerWidth<=768;document.getElementById(\"currentHighLow\").textContent=a?`${t}¬∞/${n}¬∞`:`H:${t}¬∞ L:${n}¬∞`}if(document.getElementById(\"currentCondition\").textContent=getWeatherDescription(e.current.weather_code),document.getElementById(\"feelsLike\").textContent=`${Math.round(e.current.apparent_temperature)}${e.current_units.apparent_temperature}`,document.getElementById(\"humidity\").textContent=`${e.current.relative_humidity_2m}${e.current_units.relative_humidity_2m}`,void 0!==e.current.dewpoint_2m&&(document.getElementById(\"dewPoint\").textContent=`${Math.round(e.current.dewpoint_2m)}${e.current_units.dewpoint_2m}`),document.getElementById(\"windSpeed\").textContent=`${e.current.wind_speed_10m} ${formatUnit(e.current_units.wind_speed_10m)}`,document.getElementById(\"uvIndex\").textContent=e.current.uv_index,displayPressure(e),e.daily&&e.daily.sunrise&&e.daily.sunrise[0]){const t=new Date(e.daily.sunrise[0]);document.getElementById(\"sunrise\").textContent=formatTime12Hour(t)}if(e.daily&&e.daily.sunset&&e.daily.sunset[0]){const t=new Date(e.daily.sunset[0]);document.getElementById(\"sunset\").textContent=formatTime12Hour(t)}const n=new Date,a=getMoonPhase(calculateMoonPhase(n));document.getElementById(\"moonPhaseEmoji\").textContent=a.emoji,document.getElementById(\"moonPhaseName\").textContent=a.name;const o=document.getElementById(\"moonPhase\");if(o&&(o.style.cursor=\"pointer\",o.addEventListener(\"click\",()=>openMoonDetailsModal(n))),e.hourly&&e.hourly.surface_pressure){const t=new Date,n=new Date(t);n.setDate(n.getDate()-1);const a=calculateDailyAverages(e.hourly,t),o=calculateDailyAverages(e.hourly,n);if(a){const t=o?a.avgPressureInhg-o.avgPressureInhg:0,n=2,i=e.daily.temperature_2m_max[n]-e.daily.temperature_2m_min[n];currentSymptomData={pressureChange:t,humidity:a.avgHumidity,precipitation:a.precipSum,tempSwing:i,avgTemp:a.avgTemp,windMax:a.windMax};const r=calculateSinusRisk(t,a.avgHumidity,a.precipSum,i),s=calculateAllergyRisk(a.windMax,a.precipSum,currentPollenData),l=getRiskLabel(r);document.getElementById(\"sinusRiskValue\").textContent=`${r}/10`,document.getElementById(\"sinusRiskLabel\").textContent=l.label,document.getElementById(\"sinusRiskLabel\").className=`text-xs font-semibold ${l.colorClass}`;const d=getRiskLabel(s);document.getElementById(\"allergyRiskValue\").textContent=`${s}/10`,document.getElementById(\"allergyRiskLabel\").textContent=d.label,document.getElementById(\"allergyRiskLabel\").className=`text-xs font-semibold ${d.colorClass}`}}displayPrecipitationTiming(e);const i=document.getElementById(\"hourlyForecast\").querySelector(\".flex\");i.innerHTML=\"\";const r=(new Date).getHours(),s=new Date;s.setHours(0,0,0,0);let l=0;for(let t=0;t<e.hourly.time.length;t++){const n=new Date(e.hourly.time[t]);if(n.setHours(0,0,0,0),n.getTime()>=s.getTime()){for(let n=t;n<e.hourly.time.length;n++)if(new Date(e.hourly.time[n]).getHours()>=r){l=n;break}if(l>0)break}}for(let t=0;t<24&&l+t<e.hourly.time.length;t++){const n=l+t,a=new Date(e.hourly.time[n]),o=document.createElement(\"div\");o.className=\"flex flex-col items-center bg-white/10 rounded-lg p-3 backdrop-blur-sm min-w-[80px] clickable\",o.innerHTML=`\\n            <div class=\"text-white/70 text-sm mb-1\">${formatTime12Hour(a)}</div>\\n            <div class=\"text-2xl mb-2\">${getWeatherIcon(e.hourly.weather_code[n])}</div>\\n            <div class=\"text-white font-bold text-lg\">${Math.round(e.hourly.temperature_2m[n])}${e.hourly_units.temperature_2m}</div>\\n            <div class=\"text-white/60 text-xs mt-1\">${e.hourly.wind_speed_10m[n]} ${formatUnit(e.hourly_units.wind_speed_10m)}</div>\\n        `,o.addEventListener(\"click\",()=>openHourlyModal(e)),i.appendChild(o)}const d=document.getElementById(\"dailyForecast\");d.innerHTML=\"\";const c=window.innerWidth<=768?\"short\":\"long\";for(let t=0;t<Math.min(14,e.daily.time.length-2);t++){const n=t+2,a=parseDateString(e.daily.time[n]),o=e.daily.apparent_temperature_max?e.daily.apparent_temperature_max[n]:null,i=e.daily.apparent_temperature_min?e.daily.apparent_temperature_min[n]:null,r=null!=o&&null!=i,s=r?Math.round(o):null,l=r?Math.round(i):null,u=e.daily_units.apparent_temperature_max||e.daily_units.temperature_2m_max,m=document.createElement(\"div\");m.className=\"flex items-center justify-between bg-white/10 rounded-lg p-4 backdrop-blur-sm clickable\",m.innerHTML=`\\n            <div class=\"flex items-center gap-4\">\\n                <div class=\"text-3xl\">${getWeatherIcon(e.daily.weather_code[n])}</div>\\n                <div>\\n                    <div class=\"text-white font-semibold text-lg\">${a.toLocaleDateString(\"en-US\",{weekday:c})}</div>\\n                    <div class=\"text-white/70 text-sm\">${a.toLocaleDateString(\"en-US\",{month:\"short\",day:\"numeric\"})}</div>\\n                </div>\\n            </div>\\n            <div class=\"flex items-center gap-6\">\\n                <div class=\"text-right\">\\n                    <div class=\"text-white font-bold text-xl\">${Math.round(e.daily.temperature_2m_max[n])}${e.daily_units.temperature_2m_max}</div>\\n                    <div class=\"text-white/70 text-sm\">${Math.round(e.daily.temperature_2m_min[n])}${e.daily_units.temperature_2m_min}</div>\\n                    ${r?`<div class=\"text-white/50 text-xs\">Feels like ${s}${u} / ${l}${u}</div>`:\"\"}\\n                </div>\\n                <div class=\"text-white/70 text-sm text-right min-w-[100px]\">\\n                    ${e.daily.snowfall_sum&&e.daily.snowfall_sum[n]>0?\"\":`<div><i class=\"fas fa-tint mr-1\"></i>${e.daily.precipitation_sum[n]||0} ${e.daily_units.precipitation_sum}</div>`}\\n                    ${e.daily.snowfall_sum&&e.daily.snowfall_sum[n]>0?`<div><i class=\"fas fa-snowflake mr-1\"></i>${e.daily.snowfall_sum[n]} ${e.daily_units.snowfall_sum||\"in\"}</div>`:\"\"}\\n                    ${e.daily.snowfall_sum&&e.daily.snowfall_sum[n]>0?e.daily.precipitation_probability_max&&null!==e.daily.precipitation_probability_max[n]&&void 0!==e.daily.precipitation_probability_max[n]?`<div><i class=\"fas fa-snowflake mr-1\"></i>${e.daily.precipitation_probability_max[n]}%</div>`:\"\":e.daily.precipitation_probability_max&&null!==e.daily.precipitation_probability_max[n]&&void 0!==e.daily.precipitation_probability_max[n]?`<div><i class=\"fas fa-tint mr-1\"></i>${e.daily.precipitation_probability_max[n]}%</div>`:\"\"}\\n                    <div><i class=\"fas fa-wind mr-1\"></i>${e.daily.wind_speed_10m_max[n]} ${formatUnit(e.daily_units.wind_speed_10m_max)}</div>\\n                </div>\\n            </div>\\n        `,m.addEventListener(\"click\",()=>openDailyModal(e)),d.appendChild(m)}displayWeeklySnowTotals(e),showContent(),currentWeatherData&&(document.getElementById(\"hourlyHeader\").addEventListener(\"click\",()=>openHourlyModal(currentWeatherData)),document.getElementById(\"dailyHeader\").addEventListener(\"click\",()=>openDailyModal(currentWeatherData)))}function displayWeeklySnowTotals(e){const t=document.getElementById(\"weeklySnowSection\"),n=document.getElementById(\"weeklySnowContent\");if(n.innerHTML=\"\",!e.daily.snowfall_sum)return void t.classList.add(\"hidden\");const a=[],o=window.innerWidth<=768?\"short\":\"long\";for(let t=0;t<Math.min(14,e.daily.time.length-2);t++){const n=t+2,i=e.daily.snowfall_sum[n]||0;if(i>0){const r=parseDateString(e.daily.time[n]),s=r.toLocaleDateString(\"en-US\",{weekday:o}),l=r.toLocaleDateString(\"en-US\",{month:\"short\",day:\"numeric\"}),d=Math.round(10*i)/10;a.push({dayName:s,dateStr:l,snowfall:d,index:t})}}if(0===a.length)return void t.classList.add(\"hidden\");const i=[];let r=null;for(let e=0;e<a.length;e++){const t=a[e];if(r){const e=r.days[r.days.length-1].index;t.index===e+1?(r.days.push(t),r.totalSnow+=t.snowfall):(i.push(r),r={days:[t],totalSnow:t.snowfall})}else r={days:[t],totalSnow:t.snowfall}}r&&i.push(r),t.classList.remove(\"hidden\"),i.forEach(e=>{const t=document.createElement(\"div\");t.className=\"bg-white/10 rounded-lg p-4 backdrop-blur-sm\";const a=Math.round(10*e.totalSnow)/10,o=1===a?\"inch\":\"inches\";let i;if(1===e.days.length){const n=e.days[0];n.snowfall,i=`Snowfall on ${n.dayName} (${n.dateStr}) is ${a.toFixed(1)} ${o}`,t.innerHTML=`\\n                <div class=\"text-white font-semibold\">${i}</div>\\n            `}else{const n=e.days[0],r=e.days[e.days.length-1];i=`Snowfall between ${n.dayName} (${n.dateStr}) and ${r.dayName} (${r.dateStr}) is ${a.toFixed(1)} ${o}`;const s=e.days.map(e=>{const t=1===e.snowfall?\"inch\":\"inches\";return`${e.dayName}: ${e.snowfall.toFixed(1)} ${t}`}).join(\" ‚Ä¢ \");t.innerHTML=`\\n                <div class=\"flex-1\">\\n                    <div class=\"text-white font-semibold mb-1\">${i}</div>\\n                    <div class=\"text-white/70 text-sm\">${s}</div>\\n                </div>\\n            `}n.appendChild(t)})}function getWeatherIcon(e){return{0:\"‚òÄÔ∏è\",1:\"üå§Ô∏è\",2:\"‚õÖ\",3:\"‚òÅÔ∏è\",45:\"üå´Ô∏è\",48:\"üå´Ô∏è\",51:\"üå¶Ô∏è\",53:\"üå¶Ô∏è\",55:\"üå¶Ô∏è\",56:\"üå®Ô∏è\",57:\"üå®Ô∏è\",61:\"üåßÔ∏è\",63:\"üåßÔ∏è\",65:\"üåßÔ∏è\",66:\"üå®Ô∏è\",67:\"üå®Ô∏è\",71:\"‚ùÑÔ∏è\",73:\"‚ùÑÔ∏è\",75:\"‚ùÑÔ∏è\",77:\"‚ùÑÔ∏è\",80:\"üå¶Ô∏è\",81:\"üå¶Ô∏è\",82:\"üå¶Ô∏è\",85:\"üå®Ô∏è\",86:\"üå®Ô∏è\",95:\"‚õàÔ∏è\",96:\"‚õàÔ∏è\",99:\"‚õàÔ∏è\"}[e]||\"‚òÄÔ∏è\"}function getWeatherDescription(e){return{0:\"Clear sky\",1:\"Mainly clear\",2:\"Partly cloudy\",3:\"Overcast\",45:\"Foggy\",48:\"Depositing rime fog\",51:\"Light drizzle\",53:\"Moderate drizzle\",55:\"Dense drizzle\",56:\"Light freezing drizzle\",57:\"Dense freezing drizzle\",61:\"Slight rain\",63:\"Moderate rain\",65:\"Heavy rain\",66:\"Light freezing rain\",67:\"Heavy freezing rain\",71:\"Slight snow\",73:\"Moderate snow\",75:\"Heavy snow\",77:\"Snow grains\",80:\"Slight rain showers\",81:\"Moderate rain showers\",82:\"Violent rain showers\",85:\"Slight snow showers\",86:\"Heavy snow showers\",95:\"Thunderstorm\",96:\"Thunderstorm with slight hail\",99:\"Thunderstorm with heavy hail\"}[e]||\"Unknown\"}function calculateMoonPhase(e){const t=29.53058867,n=(e-new Date(\"2000-01-06T18:14:00Z\"))/864e5%t/t;return n<0?n+1:n}function getMoonPhase(e){return null==e?{emoji:\"üåë\",name:\"Unknown\"}:e<.03||e>=.97?{emoji:\"üåë\",name:\"New Moon\"}:e>=.03&&e<.22?{emoji:\"üåí\",name:\"Waxing Crescent\"}:e>=.22&&e<.28?{emoji:\"üåì\",name:\"First Quarter\"}:e>=.28&&e<.47?{emoji:\"üåî\",name:\"Waxing Gibbous\"}:e>=.47&&e<.53?{emoji:\"üåï\",name:\"Full Moon\"}:e>=.53&&e<.72?{emoji:\"üåñ\",name:\"Waning Gibbous\"}:e>=.72&&e<.78?{emoji:\"üåó\",name:\"Last Quarter\"}:{emoji:\"üåò\",name:\"Waning Crescent\"}}function getMoonIllumination(e){const t=SunCalc.getMoonIllumination(e);return Math.round(100*t.fraction)}function calculateMoonDistance(e,t,n){const a=.621371*SunCalc.getMoonPosition(e,t,n).distance;return Math.round(a)}function calculateMoonRiseSet(e,t,n){const a=SunCalc.getMoonTimes(e,t,n);return{rise:a.rise||null,set:a.set||null,alwaysUp:a.alwaysUp||!1,alwaysDown:a.alwaysDown||!1}}function getNextFullMoon(e){const t=calculateMoonPhase(e);let n=0;n=t<.5?29.53058867*(.5-t):29.53058867*(1.5-t);const a=new Date(e);return a.setDate(a.getDate()+Math.round(n)),{date:a,days:Math.round(n)}}function getNextNewMoon(e){const t=calculateMoonPhase(e);let n=0;n=t<.97?29.53058867*(1-t):29.53058867*(1-t+1);const a=new Date(e);return a.setDate(a.getDate()+Math.round(n)),{date:a,days:Math.round(n)}}function openMoonDetailsModal(e){document.getElementById(\"moonDetailsModal\").classList.add(\"active\");const t=currentLat||40.7128,n=currentLon||-74.006,a=getMoonPhase(calculateMoonPhase(e)),o=getMoonIllumination(e),i=calculateMoonDistance(e,t,n),r=calculateMoonRiseSet(e,t,n),s=getNextFullMoon(e),l=getNextNewMoon(e);document.getElementById(\"moonDetailsEmoji\").textContent=a.emoji,document.getElementById(\"moonDetailsName\").textContent=a.name,document.getElementById(\"moonDetailsDate\").textContent=e.toLocaleDateString(\"en-US\",{weekday:\"long\",year:\"numeric\",month:\"long\",day:\"numeric\"}),document.getElementById(\"moonIllumination\").textContent=`${o}%`,r.alwaysUp?document.getElementById(\"moonRise\").textContent=\"Always up\":r.alwaysDown?document.getElementById(\"moonRise\").textContent=\"Always down\":r.rise?document.getElementById(\"moonRise\").textContent=formatTime12Hour(r.rise):document.getElementById(\"moonRise\").textContent=\"N/A\",r.alwaysUp?document.getElementById(\"moonSet\").textContent=\"Always up\":r.alwaysDown?document.getElementById(\"moonSet\").textContent=\"Always down\":r.set?document.getElementById(\"moonSet\").textContent=formatTime12Hour(r.set):document.getElementById(\"moonSet\").textContent=\"N/A\",document.getElementById(\"moonDistance\").textContent=`${i.toLocaleString()} mi`,document.getElementById(\"nextFullMoon\").textContent=`${s.days} days (${s.date.toLocaleDateString(\"en-US\",{month:\"short\",day:\"numeric\"})})`,document.getElementById(\"nextNewMoon\").textContent=`${l.days} days (${l.date.toLocaleDateString(\"en-US\",{month:\"short\",day:\"numeric\"})})`}function formatTime12Hour(e){let t=e.getHours();const n=e.getMinutes(),a=t>=12?\"PM\":\"AM\";return t%=12,t=t||12,`${t}:${n<10?\"0\"+n:n} ${a}`}function parseDateString(e){const t=e.split(\"-\");if(3===t.length){const e=parseInt(t[0],10),n=parseInt(t[1],10)-1,a=parseInt(t[2],10);return new Date(e,n,a)}return new Date(e)}function formatLastUpdated(e){const t=new Date-e,n=Math.floor(t/6e4);if(n<1)return\"just now\";if(1===n)return\"1 minute ago\";if(n<60)return`${n} minutes ago`;{const e=Math.floor(n/60);return 1===e?\"1 hour ago\":`${e} hours ago`}}function displayPressure(e){const t=document.getElementById(\"pressure\"),n=document.getElementById(\"pressureTrend\"),a=document.getElementById(\"pressureStatus\");if(!e.current.surface_pressure)return;const o=(.02953*e.current.surface_pressure).toFixed(2);t.textContent=`${o}\"`;let i=\"\",r=\"Steady\";if(e.hourly&&e.hourly.surface_pressure){const t=new Date,a=t.getHours();let o=-1;for(let n=0;n<e.hourly.time.length;n++){const i=new Date(e.hourly.time[n]);if(i.getHours()===a&&i.getDate()===t.getDate()){o=n;break}}if(o>=3){const t=e.hourly.surface_pressure[o]-e.hourly.surface_pressure[o-3];t>1?(i=\"‚Üë\",r=\"Rising\",n.className=\"text-lg text-green-400\"):t<-1?(i=\"‚Üì\",r=\"Falling\",n.className=\"text-lg text-red-400\"):(i=\"‚Üí\",r=\"Steady\",n.className=\"text-lg text-gray-400\")}}n.textContent=i,a.textContent=r}function displayPrecipitationTiming(e){const t=document.getElementById(\"precipTimingSection\"),n=document.getElementById(\"precipTiming\"),a=document.getElementById(\"precipIcon\");if(!e.hourly||!e.hourly.precipitation)return void t.classList.add(\"hidden\");const o=new Date,i=o.getHours();let r=0;for(let t=0;t<e.hourly.time.length;t++){const n=new Date(e.hourly.time[t]);if(n.getHours()>=i&&n.getDate()===o.getDate()){r=t;break}}let s=null,l=null,d=!1,c=0;for(let t=r;t<Math.min(r+24,e.hourly.time.length);t++){const n=e.hourly.precipitation[t]||0,a=e.hourly.snowfall&&e.hourly.snowfall[t]||0;if(n>0||a>0)s||(s=new Date(e.hourly.time[t]),d=a>0),c+=n+a,l=new Date(e.hourly.time[t]);else if(s&&!l)break}if(s){const e=s.getHours(),i=o.getHours(),r=s.getDate(),l=o.getDate();if(a.textContent=d?\"‚ùÑÔ∏è\":\"üåßÔ∏è\",e===i&&r===l){const e=d?\"Snow\":\"Rain\";n.textContent=`${e} is currently falling`}else{const e=d?\"Snow\":\"Rain\",t=formatTime12Hour(s);if(r===l)n.textContent=`${e} expected around ${t}`;else if(r===l+1)n.textContent=`${e} expected tomorrow around ${t}`;else{const a=s.toLocaleDateString(\"en-US\",{weekday:\"long\"});n.textContent=`${e} expected ${a} around ${t}`}}t.classList.remove(\"hidden\")}else a.textContent=\"‚òÄÔ∏è\",n.textContent=\"No precipitation expected in the next 24 hours\",t.classList.remove(\"hidden\")}async function fetchNwsSnowForecast(e,t){if(!isLikelyUsLocation(e,t))return{unavailable:!0,message:\"NWS data not available for this location\"};const n=await fetchWith503Retry(`https://api.weather.gov/points/${e.toFixed(4)},${t.toFixed(4)}`);if(!n.ok){if(404===n.status)return{unavailable:!0,message:\"NWS data not available for this location\"};throw new Error(`NWS points request failed (${n.status})`)}const a=await n.json(),o=a?.properties?.forecastGridData;if(!o)return{unavailable:!0,message:\"NWS data not available for this location\"};const i=await fetchWith503Retry(o);if(!i.ok)throw new Error(`NWS grid request failed (${i.status})`);const r=await i.json(),s=r?.properties?.snowfallAmount?.values||[];if(!s.length)return{totalInches:0};const l=new Date,d=new Date(l.getTime()+1728e5);let c=0;return s.forEach(e=>{const t=e.validTime||\"\",[n,a=\"PT0H\"]=t.split(\"/\"),o=n?new Date(n):null;if(!o||Number.isNaN(o.getTime()))return;const i=extractDurationHours(a||e.period),r=i>0?i:1,s=new Date(o.getTime()+60*r*60*1e3),u=overlapHours(o,s,l,d);if(u<=0)return;const m=Number(e.value)||0;c+=m*(u/r)}),{totalInches:c/25.4}}async function fetchEnsembleSnowForecast(e,t){const n=`https://ensemble-api.open-meteo.com/v1/ensemble?latitude=${encodeURIComponent(e)}&longitude=${encodeURIComponent(t)}&hourly=snowfall&models=gfs_seamless,ecmwf_ifs025&timezone=auto`,a=await fetch(n);if(!a.ok)throw new Error(`Ensemble request failed (${a.status})`);const o=await a.json(),i=o?.hourly;if(!i?.time?.length)return{p10:0,p50:0,p90:0};const r=new Date,s=new Date(r.getTime()+1728e5),l=[];for(let e=0;e<i.time.length;e++){const t=new Date(i.time[e]);t>=r&&t<=s&&l.push(e)}const d=Object.keys(i).filter(e=>e.startsWith(\"snowfall_member\"));if(!d.length||!l.length)return{mean:0,low:0,high:0};const c=d.map(e=>{const t=i[e]||[];let n=0;return l.forEach(e=>{n+=Number(t[e])||0}),n/2.54}),u=[...c].sort((e,t)=>e-t),m=u.length;function p(e,t){const n=t*(e.length-1),a=Math.floor(n),o=Math.ceil(n);return a===o?e[a]:e[a]+(e[o]-e[a])*(n-a)}return{mean:c.reduce((e,t)=>e+t,0)/m,low:Math.max(0,p(u,.25)),high:p(u,.75)}}async function updateSnowForecastForCurrentLocation(){if(null===currentLat||null===currentLon)return;const e=++snowForecastRequestId;updateSnowSourceToggleUi(),showSnowForecastLoading(!0);try{if(\"nws\"===snowForecastSource){const t=await fetchNwsSnowForecast(currentLat,currentLon);if(e!==snowForecastRequestId)return;return t.unavailable?void setSnowForecastResult(t.message,\"Switch to Ensemble for global coverage.\"):t.totalInches<.1?void setSnowForecastResult(\"No snow expected in the next 48 hours\",\"Source: NWS Forecast\"):void setSnowForecastResult(`NWS Forecast: ${t.totalInches.toFixed(1)} in`,\"Total expected snowfall over the next 48 hours.\")}const t=await fetchEnsembleSnowForecast(currentLat,currentLon);if(e!==snowForecastRequestId)return;if(t.high<.1)return void setSnowForecastResult(\"No snow expected in the next 48 hours\",\"Source: Ensemble Forecast\");setSnowForecastResult(`${t.low.toFixed(1)} ‚Äì ${t.high.toFixed(1)} in`,`Likely range (middle 50% of GFS + ECMWF ensemble members). Mean: ${t.mean.toFixed(1)} in over the next 48 hours.`)}catch(t){if(e!==snowForecastRequestId)return;console.error(\"Snow forecast error:\",t),setSnowForecastResult(\"Snow forecast unavailable right now\",\"Please try again in a moment.\")}finally{e===snowForecastRequestId&&showSnowForecastLoading(!1)}}function handleSnowSourceChange(e){\"nws\"!==e&&\"ensemble\"!==e||snowForecastSource!==e&&(snowForecastSource=e,localStorage.setItem(\"snowForecastSource\",e),updateSnowSourceToggleUi(),updateSnowForecastForCurrentLocation())}function showLoading(){document.getElementById(\"loading\").classList.remove(\"hidden\")}function hideLoading(){document.getElementById(\"loading\").classList.add(\"hidden\")}function showContent(){document.getElementById(\"weatherContent\").classList.remove(\"hidden\")}function hideContent(){document.getElementById(\"weatherContent\").classList.add(\"hidden\")}function showError(e){document.getElementById(\"errorMessage\").classList.remove(\"hidden\"),document.getElementById(\"errorText\").textContent=e}function hideError(){document.getElementById(\"errorMessage\").classList.add(\"hidden\")}async function fetchWeatherAlerts(e,t){if(!(e<24||e>50||t<-125||t>-66))try{const n=await fetch(`/api/nws-points/${e.toFixed(4)},${t.toFixed(4)}`);if(!n.ok)return void console.log(\"NWS points API not available:\",n.status);const a=await n.json();if(a.error)return void console.log(\"NWS points API error:\",a.reason);const o=a.properties?.forecastZone;if(!o)return void console.log(\"No forecast zone URL found in NWS response\");const i=o.split(\"/\").pop();if(!i)return void console.log(\"Could not extract zone ID from URL:\",o);const r=await fetch(`/api/alerts/active/zone/${i}`);if(!r.ok)return void console.log(\"NWS alerts API not available:\",r.status);const s=await r.json();if(s.error)return void console.log(\"NWS alerts API error:\",s.reason);if(s.features&&s.features.length>0){const e=s.features.filter(e=>\"Actual\"===e.properties.status);e.length>0&&displayAlerts(e)}}catch(e){console.error(\"Weather alerts error:\",e.message)}}function displayAlerts(e){const t=document.getElementById(\"weatherAlerts\");t.innerHTML=\"\",t.classList.remove(\"hidden\"),e.forEach((e,n)=>{const a=e.properties,o=a.severity?.toLowerCase()||\"unknown\";a.urgency?.toLowerCase();let i=\"bg-yellow-500/20 border-yellow-300/30\";\"extreme\"===o||\"severe\"===o?i=\"bg-red-500/20 border-red-300/30\":\"moderate\"===o&&(i=\"bg-orange-500/20 border-orange-300/30\");const r=document.createElement(\"div\");r.className=`${i} backdrop-blur-sm rounded-lg border shadow-lg mb-3`;const s=a.event||\"Weather Alert\",l=a.headline||\"\",d=a.description||\"\",c=a.effective?new Date(a.effective).toLocaleString(\"en-US\"):\"\",u=a.expires?new Date(a.expires).toLocaleString(\"en-US\"):\"\",m=`alert-header-${n}`,p=`alert-content-${n}`,h=`alert-icon-${n}`;r.innerHTML=`\\n            <div class=\"cursor-pointer\" id=\"${m}\">\\n                <div class=\"flex items-center justify-between p-4\">\\n                    <div class=\"flex items-center gap-3 flex-1 min-w-0\">\\n                        <i class=\"fas fa-exclamation-triangle text-2xl text-white flex-shrink-0\"></i>\\n                        <div class=\"flex-1 min-w-0\">\\n                            <div class=\"flex items-center gap-2 mb-1 flex-wrap\">\\n                                <h3 class=\"text-xl font-bold text-white\">${s}</h3>\\n                                ${a.severity?`<span class=\"px-2 py-1 bg-white/20 rounded text-xs text-white font-semibold uppercase whitespace-nowrap\">${a.severity}</span>`:\"\"}\\n                            </div>\\n                            ${l?`<p class=\"text-white font-semibold text-sm\">${l}</p>`:\"\"}\\n                        </div>\\n                    </div>\\n                    <i id=\"${h}\" class=\"fas fa-chevron-down text-white transition-transform duration-200 flex-shrink-0 ml-2\"></i>\\n                </div>\\n            </div>\\n            <div id=\"${p}\" class=\"hidden px-4 pb-4\">\\n                <div class=\"border-t border-white/20 pt-4\">\\n                    ${d?`<p class=\"text-white/90 text-sm mb-3 whitespace-pre-line\">${d}</p>`:\"\"}\\n                    ${c||u?`\\n                    <div class=\"flex flex-col gap-2 text-white/70 text-xs mt-4 pt-4 border-t border-white/10\">\\n                        ${c?`<div><i class=\"fas fa-clock mr-1\"></i>Effective: ${c}</div>`:\"\"}\\n                        ${u?`<div><i class=\"fas fa-calendar-times mr-1\"></i>Expires: ${u}</div>`:\"\"}\\n                    </div>\\n                    `:\"\"}\\n                </div>\\n            </div>\\n        `;const y=r.querySelector(`#${m}`),g=r.querySelector(`#${p}`),v=r.querySelector(`#${h}`);y.addEventListener(\"click\",()=>{g.classList.contains(\"hidden\")?(g.classList.remove(\"hidden\"),v.classList.remove(\"fa-chevron-down\"),v.classList.add(\"fa-chevron-up\"),v.style.transform=\"rotate(180deg)\"):(g.classList.add(\"hidden\"),v.classList.remove(\"fa-chevron-up\"),v.classList.add(\"fa-chevron-down\"),v.style.transform=\"rotate(0deg)\")}),t.appendChild(r)})}Object.keys(STATE_ABBREVIATIONS).forEach(e=>{STATE_NAMES_TO_ABBR[STATE_ABBREVIATIONS[e].toLowerCase()]=e});let currentPollenData=null;async function fetchAirQuality(e,t){try{const n=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${e}&longitude=${t}&current=us_aqi,pm10,pm2_5,ozone,nitrogen_dioxide,sulphur_dioxide,carbon_monoxide,alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&hourly=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&forecast_days=5&timezone=auto`);if(!n.ok)return document.getElementById(\"airQualitySection\").classList.add(\"hidden\"),void document.getElementById(\"pollenSection\").classList.add(\"hidden\");const a=await n.json();if(a.error||!a.current)return document.getElementById(\"airQualitySection\").classList.add(\"hidden\"),void document.getElementById(\"pollenSection\").classList.add(\"hidden\");currentPollenData=a,displayAirQuality(a.current),displayPollenData(a),updateAllergyRiskWithPollenData()}catch(e){console.error(\"Error fetching air quality:\",e),document.getElementById(\"airQualitySection\").classList.add(\"hidden\"),document.getElementById(\"pollenSection\").classList.add(\"hidden\")}}function displayAirQuality(e){const t=document.getElementById(\"airQualitySection\"),n=document.getElementById(\"aqiValue\"),a=document.getElementById(\"aqiStatus\");t.classList.remove(\"hidden\");const o=e.us_aqi||0;let i,r;o<=50?(i=\"Good\",r=\"text-green-400\"):o<=100?(i=\"Moderate\",r=\"text-yellow-400\"):o<=150?(i=\"Unhealthy for Sensitive Groups\",r=\"text-orange-400\"):o<=200?(i=\"Unhealthy\",r=\"text-red-400\"):o<=300?(i=\"Very Unhealthy\",r=\"text-purple-400\"):(i=\"Hazardous\",r=\"text-red-600\"),n.textContent=o,n.className=`text-2xl font-bold ${r}`,a.textContent=i,a.className=`text-white/90 text-xs mt-1 ${r}`}let currentSymptomData=null;function hpaToInhg(e){return.02953*e}function calculateDailyAverages(e,t){const n=t.toISOString().split(\"T\")[0];let a=0,o=0,i=0,r=0,s=0,l=0;for(let t=0;t<e.time.length;t++)e.time[t].split(\"T\")[0]===n&&(a+=e.temperature_2m[t]||0,o+=e.relative_humidity_2m[t]||0,i+=e.surface_pressure&&e.surface_pressure[t]||0,r+=e.precipitation&&e.precipitation[t]||0,s=Math.max(s,e.wind_speed_10m[t]||0),l++);return 0===l?null:{avgTemp:a/l,avgHumidity:o/l,avgPressureInhg:hpaToInhg(i/l),precipSum:r,windMax:s}}function calculateSinusRisk(e,t,n,a){let o=0;return e<-.3?o+=5:e>=-.3&&e<-.18?o+=3:e>=-.18&&e<-.1&&(o+=2),t>70&&(o+=1),n>.1&&(o+=1),a>20&&(o+=1),Math.max(0,Math.min(10,o))}function calculateAllergyRisk(e,t,n=null){if(!n||!n.current)return 0;let a=0;const o=n.current,i=Math.max(o.alder_pollen||0,o.birch_pollen||0,o.olive_pollen||0),r=o.grass_pollen||0,s=Math.max(o.mugwort_pollen||0,o.ragweed_pollen||0),l=Math.max(i,r,s);return l>200?a+=5:l>80?a+=4:l>20?a+=2:l>0&&(a+=1),e>10&&(a+=2),t>.1&&(a-=2),Math.max(0,Math.min(10,a))}function getRiskLabel(e){return e<=2?{label:\"Low\",colorClass:\"text-green-400\"}:e<=4?{label:\"Moderate\",colorClass:\"text-yellow-400\"}:e<=7?{label:\"High\",colorClass:\"text-orange-400\"}:{label:\"Very High\",colorClass:\"text-red-400\"}}function updateAllergyRiskWithPollenData(){if(!currentSymptomData||!currentPollenData)return;const e=calculateAllergyRisk(currentSymptomData.windMax,currentSymptomData.precipitation,currentPollenData),t=getRiskLabel(e);document.getElementById(\"allergyRiskValue\").textContent=`${e}/10`,document.getElementById(\"allergyRiskLabel\").textContent=t.label,document.getElementById(\"allergyRiskLabel\").className=`text-xs font-semibold ${t.colorClass}`}function getPollenLevel(e){return null==e||0===e?{label:\"None\",colorClass:\"text-gray-400\",level:0}:e<=20?{label:\"Low\",colorClass:\"text-green-400\",level:1}:e<=80?{label:\"Moderate\",colorClass:\"text-yellow-400\",level:2}:e<=200?{label:\"High\",colorClass:\"text-orange-400\",level:3}:{label:\"Very High\",colorClass:\"text-red-400\",level:4}}function displayPollenData(e){const t=document.getElementById(\"pollenSection\");if(!e.current)return void t.classList.add(\"hidden\");const n=e.current,a=Math.max(n.alder_pollen||0,n.birch_pollen||0,n.olive_pollen||0),o=n.grass_pollen||0,i=Math.max(n.mugwort_pollen||0,n.ragweed_pollen||0);if(0===a&&0===o&&0===i&&![n.alder_pollen,n.birch_pollen,n.olive_pollen,n.grass_pollen,n.mugwort_pollen,n.ragweed_pollen].some(e=>null!=e))return void t.classList.add(\"hidden\");t.classList.remove(\"hidden\");const r=getPollenLevel(a);document.getElementById(\"pollenTreeValue\").textContent=Math.round(a),document.getElementById(\"pollenTreeLabel\").textContent=r.label,document.getElementById(\"pollenTreeLabel\").className=`text-xs mt-1 font-semibold ${r.colorClass}`;const s=getPollenLevel(o);document.getElementById(\"pollenGrassValue\").textContent=Math.round(o),document.getElementById(\"pollenGrassLabel\").textContent=s.label,document.getElementById(\"pollenGrassLabel\").className=`text-xs mt-1 font-semibold ${s.colorClass}`;const l=getPollenLevel(i);document.getElementById(\"pollenWeedValue\").textContent=Math.round(i),document.getElementById(\"pollenWeedLabel\").textContent=l.label,document.getElementById(\"pollenWeedLabel\").className=`text-xs mt-1 font-semibold ${l.colorClass}`,e.hourly&&e.hourly.time&&displayPollenForecast(e.hourly)}function displayPollenForecast(e){const t=document.getElementById(\"pollenForecast\");t.innerHTML=\"\";const n={};for(let t=0;t<e.time.length;t++){const a=e.time[t].split(\"T\")[0];n[a]||(n[a]={tree:0,grass:0,weed:0}),n[a].tree=Math.max(n[a].tree,e.alder_pollen?.[t]||0,e.birch_pollen?.[t]||0,e.olive_pollen?.[t]||0),n[a].grass=Math.max(n[a].grass,e.grass_pollen?.[t]||0),n[a].weed=Math.max(n[a].weed,e.mugwort_pollen?.[t]||0,e.ragweed_pollen?.[t]||0)}const a=Object.keys(n).slice(0,5),o=window.innerWidth<=768;a.forEach((e,a)=>{const i=parseDateString(e),r=n[e],s=getPollenLevel(r.tree),l=getPollenLevel(r.grass),d=getPollenLevel(r.weed),c=Math.max(s.level,l.level,d.level),u=document.createElement(\"div\");u.className=\"stat-card rounded-xl p-4 flex items-center justify-between\";const m=0===a?\"Today\":1===a?\"Tomorrow\":i.toLocaleDateString(\"en-US\",{weekday:o?\"short\":\"long\"}),p=i.toLocaleDateString(\"en-US\",{month:\"short\",day:\"numeric\"});u.innerHTML=`\\n            <div class=\"flex items-center gap-3\">\\n                <div class=\"text-2xl\">${getPollenEmoji(c)}</div>\\n                <div>\\n                    <div class=\"text-white font-semibold\">${m}</div>\\n                    <div class=\"text-gray-400 text-xs\">${p}</div>\\n                </div>\\n            </div>\\n            <div class=\"flex items-center gap-4 text-sm\">\\n                <div class=\"text-center\">\\n                    <div class=\"text-gray-500 text-xs mb-1\">Tree</div>\\n                    <div class=\"${s.colorClass} font-semibold\">${s.label}</div>\\n                </div>\\n                <div class=\"text-center\">\\n                    <div class=\"text-gray-500 text-xs mb-1\">Grass</div>\\n                    <div class=\"${l.colorClass} font-semibold\">${l.label}</div>\\n                </div>\\n                <div class=\"text-center\">\\n                    <div class=\"text-gray-500 text-xs mb-1\">Weed</div>\\n                    <div class=\"${d.colorClass} font-semibold\">${d.label}</div>\\n                </div>\\n            </div>\\n        `,t.appendChild(u)})}function getPollenEmoji(e){switch(e){case 0:return\"üòä\";case 1:return\"üôÇ\";case 2:return\"üòê\";case 3:return\"üò∑\";case 4:return\"ü§ß\";default:return\"üåø\"}}function openSymptomRiskModal(e){const t=document.getElementById(\"symptomRiskModal\"),n=document.getElementById(\"symptomRiskModalTitleText\"),a=document.getElementById(\"symptomRiskModalIcon\"),o=document.getElementById(\"sinusFormulaSection\"),i=document.getElementById(\"allergyFormulaSection\"),r=document.getElementById(\"symptomCurrentValues\");if(\"sinus\"===e?(n.textContent=\"Sinus Risk Methodology\",a.innerHTML='<i class=\"fas fa-head-side-cough text-blue-300\"></i>',o.classList.remove(\"hidden\"),i.classList.add(\"hidden\")):(n.textContent=\"Allergy Risk Methodology\",a.innerHTML='<i class=\"fas fa-seedling text-green-300\"></i>',o.classList.add(\"hidden\"),i.classList.remove(\"hidden\")),currentSymptomData){const t=currentSymptomData;if(\"sinus\"===e)r.innerHTML=`\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Pressure Change</div>\\n                    <div class=\"text-white font-bold\">${t.pressureChange>=0?\"+\":\"\"}${t.pressureChange.toFixed(2)} inHg</div>\\n                </div>\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Humidity</div>\\n                    <div class=\"text-white font-bold\">${t.humidity.toFixed(0)}%</div>\\n                </div>\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Precipitation</div>\\n                    <div class=\"text-white font-bold\">${t.precipitation.toFixed(2)} in</div>\\n                </div>\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Temp Swing</div>\\n                    <div class=\"text-white font-bold\">${t.tempSwing.toFixed(1)}¬∞F</div>\\n                </div>\\n            `;else{let e=\"\";if(currentPollenData&&currentPollenData.current){const t=currentPollenData.current,n=Math.max(t.alder_pollen||0,t.birch_pollen||0,t.olive_pollen||0),a=t.grass_pollen||0,o=Math.max(t.mugwort_pollen||0,t.ragweed_pollen||0),i=getPollenLevel(n),r=getPollenLevel(a),s=getPollenLevel(o);e=`\\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tree text-green-400 mr-1\"></i>Tree Pollen</div>\\n                        <div class=\"text-white font-bold\">${Math.round(n)}</div>\\n                        <div class=\"text-xs ${i.colorClass}\">${i.label}</div>\\n                    </div>\\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-leaf text-lime-400 mr-1\"></i>Grass Pollen</div>\\n                        <div class=\"text-white font-bold\">${Math.round(a)}</div>\\n                        <div class=\"text-xs ${r.colorClass}\">${r.label}</div>\\n                    </div>\\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-amber-400 mr-1\"></i>Weed Pollen</div>\\n                        <div class=\"text-white font-bold\">${Math.round(o)}</div>\\n                        <div class=\"text-xs ${s.colorClass}\">${s.label}</div>\\n                    </div>\\n                `}r.innerHTML=`\\n                ${e}\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Max Wind</div>\\n                    <div class=\"text-white font-bold\">${t.windMax.toFixed(1)} mph</div>\\n                </div>\\n                <div class=\"stat-card rounded-lg p-3 text-center\">\\n                    <div class=\"text-gray-400 text-xs mb-1\">Precipitation</div>\\n                    <div class=\"text-white font-bold\">${t.precipitation.toFixed(2)} in</div>\\n                </div>\\n            `}}t.classList.add(\"active\"),window.MathJax&&MathJax.typesetPromise([t]).catch(function(e){console.log(\"MathJax typeset error:\",e)})}function initializeChartSelector(e){const t=document.getElementById(e);if(!t)return;const n=t.closest(\".modal\").querySelectorAll(\".chart-container\");function a(){const e=t.value;n.forEach(t=>{if(\"all\"===e)t.style.display=\"block\";else{const n=t.getAttribute(\"data-chart-type\");t.style.display=n===e?\"block\":\"none\"}})}t.value=\"temp\",a(),t.addEventListener(\"change\",a)}function openHourlyModal(e){document.getElementById(\"hourlyModal\").classList.add(\"active\"),hourlyChart&&Object.values(hourlyChart).forEach(e=>{e&&e.destroy()});const t=(new Date).getHours(),n=new Date;n.setHours(0,0,0,0);let a=0;for(let o=0;o<e.hourly.time.length;o++){const i=new Date(e.hourly.time[o]);if(i.setHours(0,0,0,0),i.getTime()>=n.getTime()){for(let n=o;n<e.hourly.time.length;n++)if(new Date(e.hourly.time[n]).getHours()>=t){a=n;break}if(a>0)break}}const o=[],i=[],r=[],s=[],l=[],d=[],c=[],u=[];for(let t=0;t<24&&a+t<e.hourly.time.length;t++){const n=a+t,m=new Date(e.hourly.time[n]);u.push(formatTime12Hour(m)),o.push(m),i.push(Math.round(e.hourly.temperature_2m[n])),r.push(e.hourly.precipitation?e.hourly.precipitation[n]:0),s.push(e.hourly.snowfall?e.hourly.snowfall[n]:0),l.push(e.hourly.wind_speed_10m[n]),d.push(e.hourly.relative_humidity_2m[n]),c.push(e.hourly.surface_pressure?(.02953*e.hourly.surface_pressure[n]).toFixed(2):null)}const m={type:\"line\",options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:\"#fff\"}}},scales:{x:{ticks:{color:\"#fff\"},grid:{color:\"rgba(255,255,255,0.1)\"}},y:{ticks:{color:\"#fff\"},grid:{color:\"rgba(255,255,255,0.1)\"}}}}},p=s.some(e=>e>0);hourlyChart={temp:new Chart(document.getElementById(\"hourlyTempChart\"),{...m,data:{labels:u,datasets:[{label:`Temperature (${e.hourly_units.temperature_2m})`,data:i,borderColor:\"rgb(255, 99, 132)\",backgroundColor:\"rgba(255, 99, 132, 0.2)\",tension:.4}]}}),precip:new Chart(document.getElementById(\"hourlyPrecipChart\"),{...m,data:{labels:u,datasets:[{label:`Precipitation (${e.hourly_units.precipitation||\"in\"})`,data:r,borderColor:\"rgb(54, 162, 235)\",backgroundColor:\"rgba(54, 162, 235, 0.2)\",tension:.4,fill:!0}]}}),wind:new Chart(document.getElementById(\"hourlyWindChart\"),{...m,data:{labels:u,datasets:[{label:`Wind Speed (${formatUnit(e.hourly_units.wind_speed_10m)})`,data:l,borderColor:\"rgb(255, 206, 86)\",backgroundColor:\"rgba(255, 206, 86, 0.2)\",tension:.4}]}}),humidity:new Chart(document.getElementById(\"hourlyHumidityChart\"),{...m,data:{labels:u,datasets:[{label:`Humidity (${e.hourly_units.relative_humidity_2m})`,data:d,borderColor:\"rgb(75, 192, 192)\",backgroundColor:\"rgba(75, 192, 192, 0.2)\",tension:.4}]}}),pressure:new Chart(document.getElementById(\"hourlyPressureChart\"),{...m,data:{labels:u,datasets:[{label:\"Pressure (inHg)\",data:c,borderColor:\"rgb(34, 197, 94)\",backgroundColor:\"rgba(34, 197, 94, 0.2)\",tension:.4}]}}),snow:new Chart(document.getElementById(\"hourlySnowChart\"),{...m,data:{labels:u,datasets:[{label:`Snowfall (${e.hourly_units.snowfall||\"in\"})`,data:s,borderColor:\"rgb(176, 196, 222)\",backgroundColor:\"rgba(176, 196, 222, 0.2)\",tension:.4,fill:!0}]}})};const h=document.getElementById(\"hourlyPrecipChart\").parentElement,y=document.getElementById(\"hourlySnowChart\").parentElement;p?(h.style.display=\"none\",y.style.display=\"block\"):(h.style.display=\"block\",y.style.display=\"none\");const g=document.getElementById(\"hourlyDetails\");g.innerHTML=\"\";for(let t=0;t<o.length;t++){const n=a+t,u=o[t],m=document.createElement(\"div\");m.className=\"bg-white/10 rounded-lg p-4 backdrop-blur-sm\",m.innerHTML=`\\n                <div class=\"flex items-center justify-between mb-2\">\\n                <div class=\"text-white font-semibold\">${u.toLocaleDateString(\"en-US\",{weekday:\"short\",month:\"short\",day:\"numeric\"})} ${formatTime12Hour(u)}</div>\\n                <div class=\"text-2xl\">${getWeatherIcon(e.hourly.weather_code[n])}</div>\\n            </div>\\n            <div class=\"grid grid-cols-2 gap-2 text-sm\">\\n                <div><span class=\"text-white/70\">Temp:</span> <span class=\"text-white font-bold\">${Math.round(i[t])}${e.hourly_units.temperature_2m}</span></div>\\n                <div><span class=\"text-white/70\">Condition:</span> <span class=\"text-white\">${getWeatherDescription(e.hourly.weather_code[n])}</span></div>\\n                <div><span class=\"text-white/70\">Wind:</span> <span class=\"text-white\">${l[t]} ${formatUnit(e.hourly_units.wind_speed_10m)}</span></div>\\n                <div><span class=\"text-white/70\">Humidity:</span> <span class=\"text-white\">${d[t]}${e.hourly_units.relative_humidity_2m}</span></div>\\n                ${c[t]?`<div><span class=\"text-white/70\">Pressure:</span> <span class=\"text-white\">${c[t]}\" inHg</span></div>`:\"\"}\\n                ${e.hourly.snowfall&&s[t]>0?\"\":e.hourly.precipitation?`<div><span class=\"text-white/70\">Precip:</span> <span class=\"text-white\">${r[t]} ${e.hourly_units.precipitation||\"in\"}</span>${e.hourly.precipitation_probability&&null!==e.hourly.precipitation_probability[n]&&void 0!==e.hourly.precipitation_probability[n]?` <span class=\"text-white/60\">(${e.hourly.precipitation_probability[n]}%)</span>`:\"\"}</div>`:\"\"}\\n                ${e.hourly.snowfall&&s[t]>0?`<div><span class=\"text-white/70\">Snow:</span> <span class=\"text-white\">${s[t]} ${e.hourly_units.snowfall||\"in\"}</span>${e.hourly.precipitation_probability&&null!==e.hourly.precipitation_probability[n]&&void 0!==e.hourly.precipitation_probability[n]?` <span class=\"text-white/60\">(${e.hourly.precipitation_probability[n]}%)</span>`:\"\"}</div>`:\"\"}\\n                ${e.hourly.snowfall&&s[t]>0?\"\":e.hourly.precipitation_probability&&null!==e.hourly.precipitation_probability[n]&&void 0!==e.hourly.precipitation_probability[n]&&!e.hourly.precipitation?`<div><span class=\"text-white/70\">Rain Chance:</span> <span class=\"text-white\">${e.hourly.precipitation_probability[n]}%</span></div>`:\"\"}\\n            </div>\\n            <div class=\"mt-2 text-white/80 text-sm\">${getWeatherDescription(e.hourly.weather_code[n])}</div>\\n        `,g.appendChild(m)}initializeChartSelector(\"hourlyChartSelect\")}function openDailyModal(e){const t=document.getElementById(\"dailyModal\");t.classList.add(\"active\"),t.querySelectorAll(\".chart-container\").forEach(e=>e.style.display=\"none\"),dailyChart&&Object.values(dailyChart).forEach(e=>{e&&e.destroy()});const n=[],a=[],o=[],i=[],r=[],s=[],l=[],d=[],c=[],u=[],m=[],p=e.daily_units.apparent_temperature_max||e.daily_units.temperature_2m_max;for(let t=0;t<Math.min(14,e.daily.time.length-2);t++){const p=t+2,h=parseDateString(e.daily.time[p]);n.push(h.toLocaleDateString(\"en-US\",{weekday:\"short\"})),a.push(Math.round(e.daily.temperature_2m_max[p])),o.push(Math.round(e.daily.temperature_2m_min[p]));const y=e.daily.apparent_temperature_max?e.daily.apparent_temperature_max[p]:null,g=e.daily.apparent_temperature_min?e.daily.apparent_temperature_min[p]:null;if(i.push(null!=y?Math.round(y):null),r.push(null!=g?Math.round(g):null),s.push(e.daily.precipitation_sum[p]||0),l.push(e.daily.snowfall_sum&&e.daily.snowfall_sum[p]||0),d.push(e.daily.wind_speed_10m_max[p]),c.push(e.daily.precipitation_probability_max?e.daily.precipitation_probability_max[p]:0),u.push(calculateMoonPhase(h)),e.hourly&&e.hourly.surface_pressure){const t=e.daily.time[p],n=e.hourly.time.findIndex(e=>e.startsWith(t)&&e.includes(\"T12:\"));if(-1!==n)m.push((.02953*e.hourly.surface_pressure[n]).toFixed(2));else{const n=e.hourly.time.findIndex(e=>e.startsWith(t));-1!==n?m.push((.02953*e.hourly.surface_pressure[n]).toFixed(2)):m.push(null)}}else m.push(null)}const h={type:\"line\",options:{animation:!1,responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:\"#fff\"}}},scales:{x:{ticks:{color:\"#fff\"},grid:{color:\"rgba(255,255,255,0.1)\"}},y:{ticks:{color:\"#fff\"},grid:{color:\"rgba(255,255,255,0.1)\"}}}}};dailyChart={temp:new Chart(document.getElementById(\"dailyTempChart\"),{...h,data:{labels:n,datasets:[{label:`High (${e.daily_units.temperature_2m_max})`,data:a,borderColor:\"rgb(255, 99, 132)\",backgroundColor:\"rgba(255, 99, 132, 0.2)\",tension:.4},{label:`Low (${e.daily_units.temperature_2m_min})`,data:o,borderColor:\"rgb(54, 162, 235)\",backgroundColor:\"rgba(54, 162, 235, 0.2)\",tension:.4}]}}),feelsLike:new Chart(document.getElementById(\"dailyFeelsLikeChart\"),{...h,data:{labels:n,datasets:[{label:`Feels Like High (${e.daily_units.apparent_temperature_max||e.daily_units.temperature_2m_max})`,data:i,borderColor:\"rgb(251, 146, 60)\",backgroundColor:\"rgba(251, 146, 60, 0.2)\",tension:.4,spanGaps:!0},{label:`Feels Like Low (${e.daily_units.apparent_temperature_min||e.daily_units.temperature_2m_min})`,data:r,borderColor:\"rgb(56, 189, 248)\",backgroundColor:\"rgba(56, 189, 248, 0.2)\",tension:.4,spanGaps:!0}]}}),precip:new Chart(document.getElementById(\"dailyPrecipChart\"),{...h,data:{labels:n,datasets:[{label:`Precipitation (${e.daily_units.precipitation_sum})`,data:s,borderColor:\"rgb(54, 162, 235)\",backgroundColor:\"rgba(54, 162, 235, 0.2)\",tension:.4}]}}),wind:new Chart(document.getElementById(\"dailyWindChart\"),{...h,data:{labels:n,datasets:[{label:`Wind Speed (${formatUnit(e.daily_units.wind_speed_10m_max)})`,data:d,borderColor:\"rgb(255, 206, 86)\",backgroundColor:\"rgba(255, 206, 86, 0.2)\",tension:.4}]}}),pressure:new Chart(document.getElementById(\"dailyPressureChart\"),{...h,data:{labels:n,datasets:[{label:\"Pressure (inHg)\",data:m,borderColor:\"rgb(34, 197, 94)\",backgroundColor:\"rgba(34, 197, 94, 0.2)\",tension:.4}]}}),snow:new Chart(document.getElementById(\"dailySnowChart\"),{...h,data:{labels:n,datasets:[{label:`Snowfall (${e.daily_units.snowfall_sum||\"in\"})`,data:l,borderColor:\"rgb(173, 216, 230)\",backgroundColor:\"rgba(173, 216, 230, 0.3)\",tension:.4,fill:!0}]}}),moonPhase:new Chart(document.getElementById(\"dailyMoonPhaseChart\"),{...h,data:{labels:n,datasets:[{label:\"Moon Phase\",data:u,borderColor:\"rgb(147, 112, 219)\",backgroundColor:\"rgba(147, 112, 219, 0.2)\",tension:.4,fill:!0}]},options:{...h.options,scales:{...h.options.scales,y:{...h.options.scales.y,min:0,max:1,ticks:{...h.options.scales.y.ticks,stepSize:.125,callback:function(e){return getMoonPhase(e).emoji}}}},plugins:{...h.options.plugins,tooltip:{callbacks:{label:function(e){const t=getMoonPhase(e.parsed.y);return`Moon Phase: ${t.emoji} ${t.name} (${(100*e.parsed.y).toFixed(1)}%)`}}}}}})};const y=document.getElementById(\"dailySnowChart\").parentElement,g=document.getElementById(\"dailyPrecipChart\").parentElement,v=l.some(e=>e>0),f=s.some(e=>e>0);v&&f?(y.style.display=\"block\",g.style.display=\"block\"):v?(y.style.display=\"block\",g.style.display=\"none\"):(y.style.display=\"none\",g.style.display=\"block\");const w=document.getElementById(\"dailyDetails\");w.innerHTML=\"\";for(let t=0;t<Math.min(14,e.daily.time.length-2);t++){const n=t+2,u=parseDateString(e.daily.time[n]),h=getMoonPhase(calculateMoonPhase(u)),y=document.createElement(\"div\");y.className=\"bg-white/10 rounded-lg p-4 backdrop-blur-sm\",y.innerHTML=`\\n            <div class=\"flex items-center justify-between mb-3\">\\n                <div>\\n                    <div class=\"text-white font-semibold text-lg\">${u.toLocaleDateString(\"en-US\",{weekday:\"long\"})}</div>\\n                    <div class=\"text-white/70 text-sm\">${u.toLocaleDateString(\"en-US\",{month:\"long\",day:\"numeric\",year:\"numeric\"})}</div>\\n                </div>\\n                <div class=\"text-4xl\">${getWeatherIcon(e.daily.weather_code[n])}</div>\\n            </div>\\n            <div class=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\">High / Low</div>\\n                    <div class=\"text-white font-bold\">${Math.round(a[t])}${e.daily_units.temperature_2m_max} / ${Math.round(o[t])}${e.daily_units.temperature_2m_min}</div>\\n                    ${null!==i[t]&&void 0!==i[t]&&null!==r[t]&&void 0!==r[t]?`<div class=\"text-white/60 text-xs mt-1\">Feels like ${i[t]}${p} / ${r[t]}${p}</div>`:\"\"}\\n                </div>\\n                ${l[t]>0?`\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-snowflake mr-1\"></i>Snowfall</div>\\n                    <div class=\"text-white font-bold\">${l[t]} ${e.daily_units.snowfall_sum||\"in\"}</div>\\n                    ${null!==c[t]&&void 0!==c[t]?`<div class=\"text-white/60 text-xs mt-1\"><i class=\"fas fa-snowflake mr-1\"></i>${c[t]}%</div>`:\"\"}\\n                </div>\\n                `:`\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\">Precipitation</div>\\n                    <div class=\"text-white font-bold\">${s[t]} ${e.daily_units.precipitation_sum}</div>\\n                    ${null!==c[t]&&void 0!==c[t]?`<div class=\"text-white/60 text-xs mt-1\"><i class=\"fas fa-tint mr-1\"></i>${c[t]}%</div>`:\"\"}\\n                </div>\\n                `}\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\">Wind Speed</div>\\n                    <div class=\"text-white font-bold\">${d[t]} ${formatUnit(e.daily_units.wind_speed_10m_max)}</div>\\n                </div>\\n                ${m[t]?`\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-gauge mr-1\"></i>Pressure</div>\\n                    <div class=\"text-white font-bold\">${m[t]}\" inHg</div>\\n                </div>\\n                `:\"\"}\\n                <div class=\"bg-white/10 rounded p-3 moon-phase-clickable\" style=\"cursor: pointer;\">\\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-moon mr-1\"></i>Moon Phase</div>\\n                    <div class=\"text-white font-bold flex items-center gap-2\">\\n                        <span class=\"text-xl\">${h.emoji}</span>\\n                        <span class=\"text-sm\">${h.name}</span>\\n                    </div>\\n                </div>\\n                <div class=\"bg-white/10 rounded p-3\">\\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-sun mr-1\"></i>Sun</div>\\n                    <div class=\"text-white\">\\n                        <span class=\"text-yellow-400 text-xs\">‚Üë</span> <span class=\"text-sm font-semibold\">${e.daily.sunrise&&e.daily.sunrise[t]?formatTime12Hour(new Date(e.daily.sunrise[t])):\"N/A\"}</span>\\n                    </div>\\n                    <div class=\"text-white mt-0.5\">\\n                        <span class=\"text-orange-400 text-xs\">‚Üì</span> <span class=\"text-sm font-semibold\">${e.daily.sunset&&e.daily.sunset[t]?formatTime12Hour(new Date(e.daily.sunset[t])):\"N/A\"}</span>\\n                    </div>\\n                </div>\\n            </div>\\n            <div class=\"mt-3 text-white/80\">${getWeatherDescription(e.daily.weather_code[n])}</div>\\n        `;const g=y.querySelector(\".moon-phase-clickable\");g&&g.addEventListener(\"click\",e=>{e.stopPropagation(),openMoonDetailsModal(u)}),w.appendChild(y)}setTimeout(()=>initializeChartSelector(\"dailyChartSelect\"),320)}function initializeVentuskyRadar(e,t){const n=`/ventusky-proxy/precipitation-map?p=${e};${t};${window.innerWidth<=768?7:8}&l=rain`,a=document.getElementById(\"ventuskyFrame\");a&&(a.src=n,a.addEventListener(\"load\",()=>{try{const e=a.contentWindow;e&&(e.open=function(){return console.log(\"Blocked iframe window.open\"),null})}catch(e){}}));const o=document.getElementById(\"radarContainer\"),i=document.getElementById(\"ventuskyContainer\");if(o){let e,t=!1;window.addEventListener(\"scroll\",()=>{t=!0,clearTimeout(e),e=setTimeout(()=>{t=!1},300)},{passive:!0}),o.addEventListener(\"click\",e=>t?(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!1):e.target===o||e.target===i?(e.preventDefault(),e.stopPropagation(),!1):void 0,{passive:!1,capture:!0}),o.addEventListener(\"focusin\",e=>{t&&(e.preventDefault(),e.stopPropagation())},{capture:!0})}}function updateVentuskyLocation(e,t){const n=`/ventusky-proxy/precipitation-map?p=${e};${t};${window.innerWidth<=768?7:8}&l=rain`,a=document.getElementById(\"ventuskyFrame\");a&&(a.src=n)}document.getElementById(\"closeHourlyModal\").addEventListener(\"click\",()=>{document.getElementById(\"hourlyModal\").classList.remove(\"active\")}),document.getElementById(\"closeDailyModal\").addEventListener(\"click\",()=>{document.getElementById(\"dailyModal\").classList.remove(\"active\")}),document.getElementById(\"closeMoonDetailsModal\").addEventListener(\"click\",()=>{document.getElementById(\"moonDetailsModal\").classList.remove(\"active\")}),document.getElementById(\"closeSymptomRiskModal\").addEventListener(\"click\",()=>{document.getElementById(\"symptomRiskModal\").classList.remove(\"active\")}),document.getElementById(\"hourlyModal\").addEventListener(\"click\",e=>{\"hourlyModal\"===e.target.id&&document.getElementById(\"hourlyModal\").classList.remove(\"active\")}),document.getElementById(\"dailyModal\").addEventListener(\"click\",e=>{\"dailyModal\"===e.target.id&&document.getElementById(\"dailyModal\").classList.remove(\"active\")}),document.getElementById(\"moonDetailsModal\").addEventListener(\"click\",e=>{\"moonDetailsModal\"===e.target.id&&document.getElementById(\"moonDetailsModal\").classList.remove(\"active\")}),document.getElementById(\"symptomRiskModal\").addEventListener(\"click\",e=>{\"symptomRiskModal\"===e.target.id&&document.getElementById(\"symptomRiskModal\").classList.remove(\"active\")}),document.addEventListener(\"keydown\",e=>{\"Escape\"===e.key&&(document.getElementById(\"hourlyModal\").classList.remove(\"active\"),document.getElementById(\"dailyModal\").classList.remove(\"active\"),document.getElementById(\"moonDetailsModal\").classList.remove(\"active\"),document.getElementById(\"symptomRiskModal\").classList.remove(\"active\"))});";
const FAVICON_CONTENT = "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" width=\"512\" height=\"512\">\n  <defs>\n    <!-- Dark gray gradient background -->\n    <linearGradient id=\"bgGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n      <stop offset=\"0%\" style=\"stop-color:#374151;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#1f2937;stop-opacity:1\" />\n    </linearGradient>\n    <!-- Gradient for cloud -->\n    <linearGradient id=\"cloudGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n      <stop offset=\"0%\" style=\"stop-color:#93c5fd;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#60a5fa;stop-opacity:1\" />\n    </linearGradient>\n    <!-- Gradient for sun -->\n    <radialGradient id=\"sunGradient\" cx=\"50%\" cy=\"50%\">\n      <stop offset=\"0%\" style=\"stop-color:#fef3c7;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#fbbf24;stop-opacity:1\" />\n    </radialGradient>\n    <!-- Shadow filter -->\n    <filter id=\"shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n      <feGaussianBlur in=\"SourceAlpha\" stdDeviation=\"4\"/>\n      <feOffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>\n      <feComponentTransfer>\n        <feFuncA type=\"linear\" slope=\"0.3\"/>\n      </feComponentTransfer>\n      <feMerge>\n        <feMergeNode/>\n        <feMergeNode in=\"SourceGraphic\"/>\n      </feMerge>\n    </filter>\n  </defs>\n  \n  <!-- Dark gray gradient background -->\n  <rect width=\"512\" height=\"512\" fill=\"url(#bgGradient)\"/>\n  \n  <!-- Cloud with gradient and shadow - scaled and centered -->\n  <g transform=\"translate(80, 200) scale(0.7)\">\n    <path fill=\"url(#cloudGradient)\" filter=\"url(#shadow)\" d=\"M416 128c-.6 0-1.1.2-1.6.2 1.1-5.2 1.6-10.6 1.6-16 0-44.2-35.8-80-80-80-24.6 0-46.3 11.3-61 28.8C256.4 24.8 219.3 0 176 0 114 0 64 50 64 112c0 7.1.7 14.1 2.1 20.8C27.8 145.4 0 181.5 0 224c0 53 43 96 96 96h320c53 0 96-43 96-96s-43-96-96-96z\"/>\n  </g>\n  \n  <!-- Sun with gradient and shadow - positioned just above the cloud, slightly to the right -->\n  <g transform=\"translate(320, 160)\">\n    <g filter=\"url(#shadow)\">\n      <!-- Sun rays (8 rays evenly spaced) -->\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"0\" y1=\"-100\" x2=\"0\" y2=\"-80\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"0\" y1=\"80\" x2=\"0\" y2=\"100\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-100\" y1=\"0\" x2=\"-80\" y2=\"0\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"80\" y1=\"0\" x2=\"100\" y2=\"0\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-70.71\" y1=\"-70.71\" x2=\"-56.57\" y2=\"-56.57\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"56.57\" y1=\"56.57\" x2=\"70.71\" y2=\"70.71\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"70.71\" y1=\"-70.71\" x2=\"56.57\" y2=\"-56.57\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-56.57\" y1=\"56.57\" x2=\"-70.71\" y2=\"70.71\"/>\n      <!-- Sun circle -->\n      <circle fill=\"url(#sunGradient)\" cx=\"0\" cy=\"0\" r=\"40\"/>\n    </g>\n  </g>\n</svg>\n";
const APPLE_TOUCH_ICON_BASE64 = "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";

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // Serve the HTML page
    if (url.pathname === '/' || url.pathname === '/index.html') {
      return new Response(HTML_CONTENT, {
        headers: {
          'Content-Type': 'text/html;charset=UTF-8',
        },
      });
    }
    
    // Serve the JavaScript file
    if (url.pathname === '/app.js') {
      return new Response(JS_CONTENT, {
        headers: {
          'Content-Type': 'application/javascript',
        },
      });
    }
    
    // Serve the favicon
    if (url.pathname === '/favicon.svg') {
      return new Response(FAVICON_CONTENT, {
        headers: {
          'Content-Type': 'image/svg+xml',
          'Cache-Control': 'public, max-age=31536000', // Cache for 1 year
        },
      });
    }
    
    // Serve the Apple touch icon (PNG for iOS)
    if (url.pathname === '/apple-touch-icon.png') {
      const pngBuffer = Uint8Array.from(atob(APPLE_TOUCH_ICON_BASE64), c => c.charCodeAt(0));
      return new Response(pngBuffer, {
        headers: {
          'Content-Type': 'image/png',
          'Cache-Control': 'public, max-age=31536000', // Cache for 1 year
        },
      });
    }
    
    // Proxy API requests to avoid CORS issues
    if (url.pathname.startsWith('/api/')) {
      const apiPath = url.pathname.replace('/api/', '');
      let targetUrl;
      
      // Geocoding API uses a different base URL
      if (apiPath.startsWith('geocoding')) {
        // Convert /api/geocoding?name=... to geocoding-api.open-meteo.com/v1/search?name=...
        const searchParams = url.search;
        targetUrl = `https://geocoding-api.open-meteo.com/v1/search${searchParams}`;
      } else if (apiPath.startsWith('reverse')) {
        // Reverse geocoding using BigDataCloud (free, no API key needed)
        // Extract lat and lon from query params
        const lat = url.searchParams.get('lat');
        const lon = url.searchParams.get('lon');
        if (lat && lon) {
          targetUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&localityLanguage=en`;
        } else {
          return new Response(JSON.stringify({ error: true, reason: 'Missing lat or lon parameters' }), {
            status: 400,
            headers: {
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
            },
          });
        }
      } else if (apiPath.startsWith('alerts')) {
        // National Weather Service alerts API (US only)
        // Remove /api/ prefix and construct the full NWS URL
        const nwsPath = apiPath; // apiPath is already "alerts/active/zone/..." or "alerts/active"
        targetUrl = `https://api.weather.gov/${nwsPath}${url.search}`;
      } else if (apiPath.startsWith('nws-points')) {
        // NWS points API to get forecast zones
        const pathParts = apiPath.split('/');
        if (pathParts.length > 1) {
          targetUrl = `https://api.weather.gov/points/${pathParts.slice(1).join('/')}`;
        } else {
          targetUrl = `https://api.weather.gov/points${url.search}`;
        }
      } else if (apiPath.startsWith('nws-wms')) {
        // Proxy for NWS WMS service to handle CORS
        // Extract WMS parameters from query string
        const wmsParams = new URLSearchParams(url.search);
        // #region agent log
        const logData = {originalQuery:url.search,allParams:Object.fromEntries(wmsParams.entries()),hasTime:wmsParams.has('time'),timeValue:wmsParams.get('time')};
        // #endregion
        // Build the WMS GetMap request URL
        // Use RIDGE2 WMS endpoint - official NWS radar service
        const wmsBaseUrl = 'https://opengeo.ncep.noaa.gov/geoserver/ows';
        // Preserve all existing parameters (including time if present)
        wmsParams.set('service', 'WMS');
        wmsParams.set('request', 'GetMap');
        if (!wmsParams.has('version')) {
          wmsParams.set('version', '1.3.0');
        }
        if (!wmsParams.has('styles')) {
          wmsParams.set('styles', '');
        }
        targetUrl = `${wmsBaseUrl}?${wmsParams.toString()}`;
        // #region agent log
        const finalLogData = {targetUrl:targetUrl,finalParams:Object.fromEntries(wmsParams.entries()),hasTimeFinal:wmsParams.has('time'),timeValueFinal:wmsParams.get('time')};
        // #endregion
      } else {
        // Weather API uses the standard base URL
        targetUrl = `https://api.open-meteo.com/v1/${apiPath}${url.search}`;
      }
      
      try {
        let fetchOptions = {};
        // Add user agent for NWS (required by their usage policy)
        if (apiPath.startsWith('alerts') || apiPath.startsWith('nws-points') || apiPath.startsWith('nws-wms')) {
          const headers = new Headers();
          headers.set('User-Agent', 'WeatherApp/1.0 (contact@example.com)');
          fetchOptions = { headers };
        }
        
        // Special handling for NWS WMS - proxy images with CORS headers
        if (apiPath.startsWith('nws-wms')) {
          try {
            // #region agent log
            // Log the full request URL and all parameters for debugging
            const requestParams = {
              targetUrl: targetUrl,
              method: 'GET',
              hasTime: wmsParams.has('time'),
              timeValue: wmsParams.get('time'),
              allParams: Object.fromEntries(wmsParams.entries()),
              bbox: wmsParams.get('BBOX') || wmsParams.get('bbox'),
              crs: wmsParams.get('CRS') || wmsParams.get('crs'),
              layers: wmsParams.get('LAYERS') || wmsParams.get('layers')
            };
            console.error('NWS_WMS_PROXY_REQUEST', JSON.stringify(requestParams));
            // #endregion
            const response = await fetch(targetUrl, fetchOptions);
            
            // Get content type early
            const responseContentType = response.headers.get('Content-Type') || 'unknown';
            const responseIsImage = responseContentType.startsWith('image/');
            const responseIsXML = responseContentType.includes('xml') || responseContentType.includes('html');
            
            // #region agent log
            console.error('NWS_WMS_PROXY_RESPONSE', JSON.stringify({status:response.status,statusText:response.statusText,ok:response.ok,contentType:responseContentType,isImage:responseIsImage,isXML:responseIsXML,targetUrl:targetUrl}));
            // #endregion
            
            if (!response.ok) {
              // #region agent log
              const errorText = await response.text().catch(() => '');
              console.error('NWS_WMS_PROXY_ERROR', JSON.stringify({status:response.status,statusText:response.statusText,errorText:errorText.substring(0,200),targetUrl:targetUrl}));
              // #endregion
              // Return a transparent PNG for errors
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=300',
                },
              });
            }
            
            // Get the response data
            const responseData = await response.arrayBuffer();
            
            // Check if response is actually a valid PNG (starts with PNG signature: 89 50 4E 47)
            const pngFirstBytes = Array.from(new Uint8Array(responseData.slice(0, 8)));
            const pngIsValid = pngFirstBytes[0] === 0x89 && pngFirstBytes[1] === 0x50 && pngFirstBytes[2] === 0x4E && pngFirstBytes[3] === 0x47;
            
            // #region agent log
            console.error('NWS_WMS_PROXY_DATA', JSON.stringify({dataSize:responseData.byteLength,contentType:responseContentType,isImage:responseIsImage,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
            // #endregion
            
            // If it's not an image (likely XML error), return transparent PNG
            if (!responseIsImage) {
              // #region agent log
              const textData = new TextDecoder().decode(responseData.slice(0, 500));
              console.error('NWS_WMS_PROXY_NOT_IMAGE', JSON.stringify({contentType:responseContentType,textData:textData,targetUrl:targetUrl}));
              // #endregion
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=60',
                },
              });
            }
            
            // If it's not a valid PNG (might be error image or XML), check and log
            if (!pngIsValid && responseData.byteLength > 0) {
              // #region agent log
              const textData = new TextDecoder().decode(responseData.slice(0, 500));
              console.error('NWS_WMS_PROXY_INVALID_PNG', JSON.stringify({contentType:responseContentType,textData:textData,dataSize:responseData.byteLength,targetUrl:targetUrl}));
              // #endregion
              // Return transparent PNG for invalid images
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=60',
                },
              });
            }
            
            // Only log small PNGs but don't block them - valid tiles can be small
            // Only block if it's exactly our 68-byte error PNG
            const ourErrorPngSize = 68; // Size of our transparent error PNG
            if (pngIsValid && responseData.byteLength === ourErrorPngSize) {
              // #region agent log
              console.error('NWS_WMS_PROXY_SUSPECTED_ERROR_PNG', JSON.stringify({dataSize:responseData.byteLength,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
              // #endregion
              // This might be our own error PNG being returned - investigate but still pass it through
            } else if (pngIsValid && responseData.byteLength < 200) {
              // Log small but potentially valid PNGs (might be empty/transparent tiles)
              // #region agent log
              console.error('NWS_WMS_PROXY_SMALL_PNG', JSON.stringify({dataSize:responseData.byteLength,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
              // #endregion
            }
            
            // #region agent log
            console.error('NWS_WMS_PROXY_SUCCESS', JSON.stringify({imageDataSize:responseData.byteLength,isPNG:pngIsValid,targetUrl:targetUrl}));
            // #endregion
            
            // Return the image with CORS headers - pass through all valid PNGs regardless of size
            return new Response(responseData, {
              headers: {
                'Content-Type': responseContentType || 'image/png',
                'Access-Control-Allow-Origin': '*',
                'Cache-Control': 'public, max-age=300', // Cache for 5 minutes
              },
            });
          } catch (error) {
            // #region agent log
            console.error('NWS_WMS_PROXY_FETCH_ERROR', JSON.stringify({errorMessage:error.message,errorStack:error.stack,targetUrl:targetUrl}));
            // #endregion
            console.error('NWS WMS proxy error:', error, 'for URL:', targetUrl);
            // Return transparent PNG on error
            const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
              status: 200,
              headers: {
                'Content-Type': 'image/png',
                'Access-Control-Allow-Origin': '*',
                'Cache-Control': 'public, max-age=60',
              },
            });
          }
        }
        
        if (apiPath.startsWith('reverse')) {
          // Special handling for reverse geocoding (BigDataCloud)
          try {
            const response = await fetch(targetUrl, fetchOptions);
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Reverse geocoding API error (${response.status}):`, errorText.substring(0, 200));
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // BigDataCloud returns the data directly, no error field to check
            // Transform to match expected format
            const transformedData = {
              address: {
                city: data.city || data.locality,
                town: data.town,
                village: data.village,
                municipality: data.municipality,
                county: data.county,
                state: data.principalSubdivision,
                state_district: data.principalSubdivision,
                country: data.countryName,
              },
              display_name: data.displayName || `${data.city || data.locality || ''}, ${data.principalSubdivision || ''}`.trim(),
            };
            
            return new Response(JSON.stringify(transformedData), {
              headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
              },
            });
          } catch (fetchError) {
            // Re-throw to be caught by outer catch block
            throw fetchError;
          }
        } else {
          // Standard handling for other APIs (forecast, geocoding, etc.)
          try {
            // Create cache key from the full request URL
            const cacheKey = new Request(targetUrl);
            
            // Try to get from cache first (only for forecast and geocoding)
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              const cachedResponse = await caches.default.match(cacheKey);
              if (cachedResponse) {
                // Clone the cached response and add CORS headers
                const cachedData = await cachedResponse.json();
                return new Response(JSON.stringify(cachedData), {
                  headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'X-Cache': 'HIT',
                  },
                });
              }
            }
            
            // Add timeout for long-running requests (30 seconds)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            
            if (!fetchOptions) {
              fetchOptions = {};
            }
            fetchOptions.signal = controller.signal;
            
            // Add User-Agent header for Open-Meteo to help with rate limiting
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              if (!fetchOptions.headers) {
                fetchOptions.headers = new Headers();
              }
              // Use a descriptive User-Agent to help Open-Meteo identify the app
              fetchOptions.headers.set('User-Agent', 'WeatherApp/1.0 (https://weather-app.jackanglim3.workers.dev)');
            }
            
            // Retry logic for rate limits (max 2 retries)
            let response;
            let retries = 0;
            const maxRetries = 2;
            
            while (retries <= maxRetries) {
              response = await fetch(targetUrl, fetchOptions);
              
              // If we get a 429, check for Retry-After header and wait accordingly
              if (response.status === 429 && retries < maxRetries) {
                const retryAfter = response.headers.get('Retry-After');
                const waitTime = retryAfter 
                  ? parseInt(retryAfter, 10) * 1000 
                  : Math.pow(2, retries) * 1000; // 1s, 2s, 4s
                console.log(`Rate limited, retrying in ${waitTime}ms... (attempt ${retries + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, Math.min(waitTime, 10000))); // Max 10s wait
                retries++;
                continue;
              }
              
              break; // Success or non-retryable error
            }
            
            clearTimeout(timeoutId);
            
            // Handle rate limiting (429) after retries exhausted
            if (response.status === 429) {
              // Check for Retry-After header to provide specific wait time
              const retryAfter = response.headers.get('Retry-After');
              let waitMessage = 'Rate limit exceeded. ';
              if (retryAfter) {
                const waitSeconds = parseInt(retryAfter, 10);
                const waitMinutes = Math.ceil(waitSeconds / 60);
                waitMessage += `Please wait ${waitMinutes} minute${waitMinutes > 1 ? 's' : ''} and try again.`;
              } else {
                waitMessage += 'Please wait 1-2 minutes and try again.';
              }
              
              return new Response(JSON.stringify({ 
                error: true, 
                reason: waitMessage
              }), {
                status: 429,
                headers: {
                  'Content-Type': 'application/json',
                  'Access-Control-Allow-Origin': '*',
                },
              });
            }
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`API error (${response.status}) for ${targetUrl}:`, errorText.substring(0, 200));
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Try to parse as JSON
            let data;
            let text;
            try {
              text = await response.text();
              // Check if response is empty
              if (!text || text.trim().length === 0) {
                throw new Error('Empty response from API');
              }
              data = JSON.parse(text);
            } catch (parseError) {
              const contentType = response.headers.get('content-type');
              console.error('Failed to parse JSON response. Content-Type:', contentType, 'Response preview:', text?.substring(0, 200));
              
              // If we got a 429 but it's not JSON, return a proper error
              if (response.status === 429) {
                return new Response(JSON.stringify({ 
                  error: true, 
                  reason: 'Rate limit exceeded. Please try again in a few moments.' 
                }), {
                  status: 429,
                  headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                  },
                });
              }
              
              throw new Error(`Invalid response format: ${parseError.message}`);
            }
            
            // Cache successful responses (only for forecast and geocoding)
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              // Determine cache duration based on API type
              const cacheSeconds = apiPath.startsWith('forecast') ? 600 : 3600; // 10 min for forecast, 1 hour for geocoding
              
              // Create a response with cache headers
              const cacheResponse = new Response(JSON.stringify(data), {
                headers: {
                  'Content-Type': 'application/json',
                  'Cache-Control': `public, max-age=${cacheSeconds}`,
                },
              });
              
              // Store in cache
              ctx.waitUntil(caches.default.put(cacheKey, cacheResponse.clone()));
            }
            
            return new Response(JSON.stringify(data), {
              headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'X-Cache': 'MISS',
              },
            });
          } catch (fetchError) {
            if (fetchError.name === 'AbortError') {
              console.error('Request timeout for', targetUrl);
              throw new Error('Request timeout');
            }
            console.error('Fetch error for', targetUrl, ':', fetchError.message);
            throw fetchError;
          }
        }
      } catch (error) {
        console.error('API proxy error:', error);
        return new Response(JSON.stringify({ error: true, reason: error.message }), {
          status: 500,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
        });
      }
    }
    
    // Proxy Ventusky iframe with desktop user agent to remove mobile download button
    if (url.pathname.startsWith('/ventusky-proxy')) {
      try {
        // Extract Ventusky path and parameters
        // Remove /ventusky-proxy prefix to get the Ventusky path (e.g., /precipitation-map)
        const ventuskyPath = url.pathname.replace('/ventusky-proxy', '') || '/precipitation-map';
        const ventuskyParams = url.search;
        const ventuskyUrl = `https://www.ventusky.com${ventuskyPath}${ventuskyParams}`;
        
        // Fetch with desktop user agent to get desktop version (no download button)
        const response = await fetch(ventuskyUrl, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.9',
          },
        });
        
        if (!response.ok) {
          return new Response('Failed to load Ventusky', { status: response.status });
        }
        
        // Get the HTML content
        let html = await response.text();
        
        // Inject CSS and JavaScript to hide download button
        const hideButtonScript = `
          <style>
            /* Hide download app button */
            a[href*="app"], 
            button[class*="app"],
            div[class*="app-button"],
            div[class*="download"],
            a[class*="download"],
            button[class*="download"],
            [data-app-button],
            [id*="app-button"],
            [id*="download-button"] {
              display: none !important;
              visibility: hidden !important;
              opacity: 0 !important;
              height: 0 !important;
              width: 0 !important;
              overflow: hidden !important;
            }
          </style>
          <script>
            // Additional JavaScript to hide button after page loads
            (function() {
              function hideDownloadButton() {
                const selectors = [
                  'a[href*="app"]',
                  'button[class*="app"]',
                  'div[class*="app-button"]',
                  'div[class*="download"]',
                  'a[class*="download"]',
                  'button[class*="download"]',
                  '[data-app-button]',
                  '[id*="app-button"]',
                  '[id*="download-button"]'
                ];
                selectors.forEach(selector => {
                  document.querySelectorAll(selector).forEach(el => {
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                    el.style.opacity = '0';
                    el.style.height = '0';
                    el.style.width = '0';
                  });
                });
              }
              // Run immediately and on various events
              hideDownloadButton();
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideDownloadButton);
              }
              window.addEventListener('load', hideDownloadButton);
              // Use MutationObserver to catch dynamically added buttons
              const observer = new MutationObserver(hideDownloadButton);
              observer.observe(document.body, { childList: true, subtree: true });
              // Also run periodically as fallback
              setInterval(hideDownloadButton, 1000);
            })();
          </script>
        `;
        
        // Inject the script before closing head tag, or at the beginning of body
        if (html.includes('</head>')) {
          html = html.replace('</head>', hideButtonScript + '</head>');
        } else if (html.includes('<body')) {
          html = html.replace('<body', hideButtonScript + '<body');
        } else {
          html = hideButtonScript + html;
        }
        
        // Return modified HTML with proper headers
        return new Response(html, {
          headers: {
            'Content-Type': 'text/html;charset=UTF-8',
            'X-Frame-Options': 'ALLOWALL',
            'Content-Security-Policy': "frame-ancestors *;",
          },
        });
      } catch (error) {
        console.error('Ventusky proxy error:', error);
        return new Response('Error proxying Ventusky', { status: 500 });
      }
    }
    
    return new Response('Not Found', { status: 404 });
  },
};
