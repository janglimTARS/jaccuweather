// This file is auto-generated by build.js
const HTML_CONTENT = "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Jaccuweather</title>\n    <link rel=\"icon\" type=\"image/svg+xml\" href=\"/favicon.svg\">\n    <link rel=\"apple-touch-icon\" sizes=\"180x180\" href=\"/apple-touch-icon.png?v=e0bc3a4d\">\n    <meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n    <meta name=\"apple-mobile-web-app-status-bar-style\" content=\"black\">\n    <meta name=\"apple-mobile-web-app-title\" content=\"Jaccuweather\">\n    <meta name=\"theme-color\" content=\"#1a1a2e\">\n    <meta property=\"og:title\" content=\"Jaccuweather\">\n    <meta property=\"og:description\" content=\"Real-time weather forecasts with radar, hourly and daily forecasts\">\n    <meta property=\"og:type\" content=\"website\">\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <script>\n        window.MathJax = {\n            tex: { inlineMath: [['\\\\(', '\\\\)']], displayMath: [['\\\\[', '\\\\]']] },\n            chtml: { scale: 0.9 },\n            startup: {\n                ready: () => {\n                    MathJax.startup.defaultReady();\n                }\n            }\n        };\n    </script>\n    <script id=\"MathJax-script\" async src=\"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js\"></script>\n    <script>\n        tailwind.config = {\n            theme: {\n                extend: {\n                    fontFamily: {\n                        sans: ['Inter', 'system-ui', 'sans-serif'],\n                    }\n                }\n            }\n        }\n    </script>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js\"></script>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n    <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n    <script src=\"https://unpkg.com/leaflet.wms@0.2.0/dist/leaflet.wms.js\"></script>\n    <style>\n        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');\n        \n        html {\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);\n            background-attachment: fixed;\n        }\n        \n        body {\n            font-family: 'Inter', system-ui, sans-serif;\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);\n            background-attachment: fixed;\n            min-height: 100vh;\n        }\n        \n        .card {\n            background: rgba(31, 41, 55, 0.8);\n            backdrop-filter: blur(10px);\n            border: 1px solid rgba(75, 85, 99, 0.5);\n        }\n        \n        .skeleton {\n            background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);\n            background-size: 200% 100%;\n            animation: shimmer 1.5s infinite;\n            border-radius: 4px;\n        }\n        \n        @keyframes shimmer {\n            0% { background-position: 200% 0; }\n            100% { background-position: -200% 0; }\n        }\n        \n        .loading-spinner {\n            display: inline-block;\n            width: 20px;\n            height: 20px;\n            border: 3px solid rgba(255,255,255,.3);\n            border-radius: 50%;\n            border-top-color: #fff;\n            animation: spin 1s ease-in-out infinite;\n        }\n        \n        @keyframes spin {\n            to { transform: rotate(360deg); }\n        }\n        \n        ::-webkit-scrollbar {\n            height: 8px;\n            width: 8px;\n        }\n        \n        ::-webkit-scrollbar-track {\n            background: #1f2937;\n            border-radius: 4px;\n        }\n        \n        ::-webkit-scrollbar-thumb {\n            background: #4b5563;\n            border-radius: 4px;\n        }\n        \n        ::-webkit-scrollbar-thumb:hover {\n            background: #6b7280;\n        }\n        \n        .modal {\n            display: none;\n            position: fixed;\n            z-index: 1000;\n            left: 0;\n            top: 0;\n            width: 100%;\n            height: 100%;\n            overflow: auto;\n            background-color: rgba(0,0,0,0.75);\n            backdrop-filter: blur(5px);\n        }\n        \n        .modal.active {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        \n        .modal-content {\n            background: rgba(31, 41, 55, 0.95);\n            backdrop-filter: blur(20px);\n            margin: auto;\n            padding: 0;\n            border: 1px solid rgba(75, 85, 99, 0.5);\n            border-radius: 1rem;\n            width: 90%;\n            max-width: 900px;\n            max-height: 90vh;\n            overflow-y: auto;\n            animation: modalSlideIn 0.3s ease-out;\n        }\n        \n        @keyframes modalSlideIn {\n            from {\n                opacity: 0;\n                transform: translateY(-50px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n        \n        .clickable {\n            cursor: pointer;\n            transition: transform 0.2s, background 0.2s;\n        }\n        \n        .clickable:hover {\n            transform: scale(1.02);\n            background: rgba(75, 85, 99, 0.6) !important;\n        }\n        \n        .stat-card {\n            background: rgba(55, 65, 81, 0.5);\n            border: 1px solid rgba(75, 85, 99, 0.5);\n            transition: all 0.2s ease;\n        }\n        \n        .stat-card:hover {\n            background: rgba(55, 65, 81, 0.7);\n            border-color: rgba(107, 114, 128, 0.6);\n        }\n        \n        .ventusky-iframe-container {\n            position: relative;\n            width: 100%;\n            border-radius: 0.75rem;\n            overflow: hidden;\n            height: 0;\n            padding-bottom: 100%;\n            pointer-events: auto;\n        }\n        \n        @media (max-width: 768px) {\n            .ventusky-iframe-container {\n                padding-bottom: 180%;\n            }\n        }\n        \n        .ventusky-iframe-container iframe {\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            pointer-events: auto;\n        }\n        \n        @supports selector(:has(*)) {\n            .ventusky-iframe-container:has(iframe) {\n                overflow: hidden;\n            }\n        }\n        \n        footer span {\n            filter: grayscale(100%) brightness(0) invert(1) opacity(0.6);\n            display: inline-block;\n        }\n        \n        @media (max-width: 768px) {\n            .ventusky-iframe-container::after {\n                content: '';\n                position: absolute;\n                bottom: 0;\n                left: 0;\n                right: 0;\n                height: 60px;\n                background: linear-gradient(to top, rgba(26, 26, 46, 0.95) 0%, rgba(26, 26, 46, 0) 100%);\n                pointer-events: none;\n                z-index: 10;\n                border-radius: 0 0 0.75rem 0.75rem;\n            }\n        }\n        \n        .search-input {\n            background: rgba(55, 65, 81, 0.6);\n            border: 1px solid rgba(75, 85, 99, 0.5);\n            transition: all 0.2s ease;\n        }\n        \n        .search-input:focus {\n            background: rgba(55, 65, 81, 0.8);\n            border-color: rgba(107, 114, 128, 0.7);\n            box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.2);\n        }\n        \n        .btn {\n            background: rgba(55, 65, 81, 0.6);\n            border: 1px solid rgba(75, 85, 99, 0.5);\n            transition: all 0.2s ease;\n        }\n        \n        .btn:hover {\n            background: rgba(75, 85, 99, 0.7);\n            border-color: rgba(107, 114, 128, 0.6);\n        }\n        \n        /* MathJax formula containers */\n        .formula-container {\n            background: rgba(31, 41, 55, 0.5);\n            border-radius: 0.5rem;\n            padding: 1rem;\n            text-align: center;\n        }\n        \n        .formula-container mjx-container {\n            max-width: 100% !important;\n        }\n        \n        @media (max-width: 640px) {\n            .formula-container {\n                padding: 0.75rem 0.5rem;\n                font-size: 0.85em;\n            }\n        }\n    </style>\n</head>\n<body class=\"text-white p-4 md:p-8\">\n    <div class=\"max-w-6xl mx-auto\">\n        <!-- Header -->\n        <header class=\"text-center mb-8\">\n            <h1 class=\"text-3xl md:text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3\">\n                <span class=\"text-4xl\">üå§Ô∏è</span>\n                Jaccuweather\n            </h1>\n            <p class=\"text-gray-400 text-sm\">Powered by Open-Meteo & Ventusky</p>\n        </header>\n\n        <!-- Weather Alerts -->\n        <div id=\"weatherAlerts\" class=\"hidden mb-6 max-w-6xl mx-auto space-y-3\">\n            <!-- Alerts will be inserted here -->\n        </div>\n\n        <!-- Search Bar -->\n        <div class=\"mb-6 px-2\">\n            <div class=\"flex flex-wrap gap-2 max-w-2xl mx-auto\">\n                <input \n                    type=\"text\" \n                    id=\"locationInput\" \n                    placeholder=\"Search for a city or location...\"\n                    class=\"search-input flex-1 min-w-[200px] px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none\"\n                >\n                <div class=\"flex gap-2\">\n                    <button \n                        id=\"searchBtn\"\n                        class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\"\n                    >\n                        <i class=\"fas fa-search\"></i>\n                    </button>\n                    <button \n                        id=\"locationBtn\"\n                        class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\"\n                        title=\"Use current location\"\n                    >\n                        <i class=\"fas fa-location-arrow\"></i>\n                    </button>\n                    <div class=\"relative\">\n                        <button \n                            id=\"favoritesBtn\"\n                            class=\"btn px-4 md:px-6 py-3 rounded-lg text-white font-semibold\"\n                            title=\"Favorites\"\n                        >\n                            <i class=\"fas fa-star\"></i>\n                        </button>\n                        <div id=\"favoritesDropdown\" class=\"hidden absolute right-0 mt-2 w-64 card rounded-xl shadow-xl z-50 max-h-96 overflow-y-auto\">\n                            <div class=\"p-3 border-b border-gray-600/50\">\n                                <div class=\"flex items-center justify-between\">\n                                    <h3 class=\"text-white font-semibold\">Favorites</h3>\n                                    <button id=\"addFavoriteBtn\" class=\"text-gray-400 hover:text-white text-sm\">\n                                        <i class=\"fas fa-plus mr-1\"></i>Add Current\n                                    </button>\n                                </div>\n                            </div>\n                            <div id=\"favoritesList\" class=\"p-2\">\n                                <!-- Favorites will be inserted here -->\n                            </div>\n                            <div id=\"noFavorites\" class=\"p-4 text-gray-400 text-sm text-center hidden\">\n                                No favorites yet. Add your current location to get started.\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Error Message -->\n        <div id=\"errorMessage\" class=\"hidden max-w-2xl mx-auto mb-4 p-4 bg-red-900/40 rounded-xl text-white border border-red-500/30\">\n            <i class=\"fas fa-exclamation-circle mr-2\"></i>\n            <span id=\"errorText\"></span>\n        </div>\n\n        <!-- Loading State -->\n        <div id=\"loading\" class=\"hidden text-center py-12\">\n            <div class=\"loading-spinner mx-auto mb-4\"></div>\n            <p class=\"text-gray-300\">Loading weather data...</p>\n        </div>\n\n        <!-- Main Content -->\n        <div id=\"weatherContent\" class=\"hidden\">\n            <!-- Current Weather -->\n            <section class=\"card rounded-2xl p-6 md:p-8 mb-6\">\n                <div class=\"flex flex-col md:flex-row justify-between items-start md:items-center mb-6\">\n                    <div>\n                        <h2 id=\"currentLocation\" class=\"text-2xl md:text-3xl font-bold text-white mb-2\"></h2>\n                        <p id=\"currentDate\" class=\"text-gray-400\"></p>\n                        <p id=\"lastUpdated\" class=\"text-gray-500 text-xs mt-1\"></p>\n                    </div>\n                    <div class=\"text-right mt-4 md:mt-0\">\n                        <div id=\"currentTemp\" class=\"text-5xl md:text-6xl font-bold text-white mb-2\"></div>\n                        <div id=\"currentHighLow\" class=\"text-lg text-gray-300 mb-2\"></div>\n                        <p id=\"currentCondition\" class=\"text-xl text-gray-300\"></p>\n                    </div>\n                </div>\n                \n                <div class=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-8 gap-3\">\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-thermometer-half text-orange-400 mr-1\"></i>Feels Like</div>\n                        <div id=\"feelsLike\" class=\"text-xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tint text-blue-400 mr-1\"></i>Humidity</div>\n                        <div id=\"humidity\" class=\"text-xl font-bold text-white\"></div>\n                        <div class=\"text-gray-500 text-xs mt-1\">Dew: <span id=\"dewPoint\" class=\"text-gray-300\">--</span></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-wind text-cyan-400 mr-1\"></i>Wind</div>\n                        <div id=\"windSpeed\" class=\"text-xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-sun text-yellow-400 mr-1\"></i>UV Index</div>\n                        <div id=\"uvIndex\" class=\"text-xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-sun text-yellow-500 mr-1\"></i>Sun</div>\n                        <div class=\"text-white\">\n                            <span class=\"text-yellow-400 text-xs\">‚Üë</span> <span id=\"sunrise\" class=\"text-sm font-semibold\">--</span>\n                        </div>\n                        <div class=\"text-white mt-0.5\">\n                            <span class=\"text-orange-400 text-xs\">‚Üì</span> <span id=\"sunset\" class=\"text-sm font-semibold\">--</span>\n                        </div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-gauge text-green-400 mr-1\"></i>Pressure</div>\n                        <div class=\"flex items-center gap-1\">\n                            <span id=\"pressure\" class=\"text-xl font-bold text-white\">--</span>\n                            <span id=\"pressureTrend\" class=\"text-sm\"></span>\n                        </div>\n                        <div id=\"pressureStatus\" class=\"text-gray-500 text-xs\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-moon text-purple-400 mr-1\"></i>Moon <i class=\"fas fa-info-circle text-xs ml-1\"></i></div>\n                        <div id=\"moonPhase\" class=\"flex items-center gap-2\">\n                            <span id=\"moonPhaseEmoji\" class=\"text-xl\"></span>\n                            <span id=\"moonPhaseName\" class=\"text-xs font-semibold text-white\"></span>\n                        </div>\n                    </div>\n                    <div id=\"airQualitySection\" class=\"stat-card rounded-xl p-4 hidden\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-lungs text-green-400 mr-1\"></i>Air Quality</div>\n                        <div id=\"aqiValue\" class=\"text-xl font-bold text-white\"></div>\n                        <div id=\"aqiStatus\" class=\"text-gray-500 text-xs\"></div>\n                    </div>\n                    <div id=\"sinusRiskSection\" class=\"stat-card rounded-xl p-4 cursor-pointer hover:bg-gray-600/50 transition-colors\" onclick=\"openSymptomRiskModal('sinus')\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-head-side-cough text-blue-300 mr-1\"></i>Sinus <i class=\"fas fa-info-circle text-xs ml-1\"></i></div>\n                        <div id=\"sinusRiskValue\" class=\"text-2xl font-bold text-white\"></div>\n                        <div id=\"sinusRiskLabel\" class=\"text-xs mt-1\"></div>\n                    </div>\n                    <div id=\"allergyRiskSection\" class=\"stat-card rounded-xl p-4 cursor-pointer hover:bg-gray-600/50 transition-colors\" onclick=\"openSymptomRiskModal('allergy')\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-green-300 mr-1\"></i>Allergy <i class=\"fas fa-info-circle text-xs ml-1\"></i></div>\n                        <div id=\"allergyRiskValue\" class=\"text-2xl font-bold text-white\"></div>\n                        <div id=\"allergyRiskLabel\" class=\"text-xs mt-1\"></div>\n                    </div>\n                </div>\n            </section>\n\n            <!-- Precipitation Timing -->\n            <div id=\"precipTimingSection\" class=\"hidden mb-6\">\n                <div class=\"card rounded-2xl p-4 md:p-6\">\n                    <div class=\"flex items-center gap-3\">\n                        <span class=\"text-2xl\" id=\"precipIcon\">üåßÔ∏è</span>\n                        <p id=\"precipTiming\" class=\"text-white font-medium\"></p>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Weekly Snow Totals -->\n            <section id=\"weeklySnowSection\" class=\"hidden card rounded-2xl p-6 md:p-8 mb-6\">\n                <h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n                    <span class=\"text-2xl\">‚ùÑÔ∏è</span> Weekly Snow Totals\n                </h3>\n                <div id=\"weeklySnowContent\" class=\"space-y-2\">\n                    <!-- Snow totals will be inserted here -->\n                </div>\n            </section>\n\n            <!-- Pollen Forecast -->\n            <section id=\"pollenSection\" class=\"hidden card rounded-2xl p-6 md:p-8 mb-6\">\n                <h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n                    <span class=\"text-2xl\">üåø</span> Pollen Forecast\n                </h3>\n                \n                <!-- Current Pollen Levels -->\n                <div class=\"mb-6\">\n                    <h4 class=\"text-sm font-semibold text-gray-400 mb-3\">Current Levels</h4>\n                    <div class=\"grid grid-cols-3 gap-3\">\n                        <div class=\"stat-card rounded-xl p-4 text-center\">\n                            <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tree text-green-400 mr-1\"></i>Tree</div>\n                            <div id=\"pollenTreeValue\" class=\"text-xl font-bold text-white\"></div>\n                            <div id=\"pollenTreeLabel\" class=\"text-xs mt-1\"></div>\n                        </div>\n                        <div class=\"stat-card rounded-xl p-4 text-center\">\n                            <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-leaf text-lime-400 mr-1\"></i>Grass</div>\n                            <div id=\"pollenGrassValue\" class=\"text-xl font-bold text-white\"></div>\n                            <div id=\"pollenGrassLabel\" class=\"text-xs mt-1\"></div>\n                        </div>\n                        <div class=\"stat-card rounded-xl p-4 text-center\">\n                            <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-amber-400 mr-1\"></i>Weed</div>\n                            <div id=\"pollenWeedValue\" class=\"text-xl font-bold text-white\"></div>\n                            <div id=\"pollenWeedLabel\" class=\"text-xs mt-1\"></div>\n                        </div>\n                    </div>\n                </div>\n                \n                <!-- 5-Day Pollen Forecast -->\n                <div>\n                    <h4 class=\"text-sm font-semibold text-gray-400 mb-3\">5-Day Forecast</h4>\n                    <div id=\"pollenForecast\" class=\"space-y-2\">\n                        <!-- Forecast items will be inserted here -->\n                    </div>\n                </div>\n                \n                <!-- Pollen Types Legend -->\n                <div class=\"mt-4 pt-4 border-t border-gray-600/30\">\n                    <p class=\"text-gray-500 text-xs\">\n                        <i class=\"fas fa-tree text-green-400 mr-1\"></i><strong>Tree:</strong> Alder, Birch, Olive &nbsp;|&nbsp;\n                        <i class=\"fas fa-leaf text-lime-400 mr-1\"></i><strong>Grass:</strong> General &nbsp;|&nbsp;\n                        <i class=\"fas fa-seedling text-amber-400 mr-1\"></i><strong>Weed:</strong> Mugwort, Ragweed\n                    </p>\n                </div>\n            </section>\n\n            <!-- Hourly Forecast -->\n            <section class=\"card rounded-2xl p-6 md:p-8 mb-6\">\n                <h3 class=\"text-xl font-bold text-white mb-4 cursor-pointer hover:text-gray-300 transition-colors flex items-center gap-2\" id=\"hourlyHeader\">\n                    <span class=\"text-2xl\">‚è∞</span> 24-Hour Forecast <i class=\"fas fa-external-link-alt ml-2 text-sm text-gray-400\"></i>\n                </h3>\n                <div id=\"hourlyForecast\" class=\"overflow-x-auto\">\n                    <div class=\"flex gap-3 min-w-max pb-2\">\n                        <!-- Hourly items will be inserted here -->\n                    </div>\n                </div>\n            </section>\n\n            <!-- Daily Forecast -->\n            <section class=\"card rounded-2xl p-6 md:p-8 mb-6\">\n                <h3 class=\"text-xl font-bold text-white mb-4 cursor-pointer hover:text-gray-300 transition-colors flex items-center gap-2\" id=\"dailyHeader\">\n                    <span class=\"text-2xl\">üìÖ</span> 14-Day Forecast <i class=\"fas fa-external-link-alt ml-2 text-sm text-gray-400\"></i>\n                </h3>\n                <div id=\"dailyForecast\" class=\"space-y-2\">\n                    <!-- Daily items will be inserted here -->\n                </div>\n            </section>\n\n            <!-- Weather Radar -->\n            <section class=\"card rounded-2xl p-6 md:p-8\">\n                <h3 class=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n                    <span class=\"text-2xl\">üì°</span> Weather Radar\n                </h3>\n                <div id=\"radarContainer\" class=\"relative\">\n                    <!-- Ventusky iframe -->\n                    <div id=\"ventuskyContainer\" class=\"ventusky-iframe-container\">\n                        <iframe \n                            id=\"ventuskyFrame\"\n                            src=\"\" \n                            style=\"border: none;\"\n                            allowfullscreen\n                            loading=\"lazy\"\n                            sandbox=\"allow-same-origin allow-scripts allow-popups allow-forms\"\n                            referrerpolicy=\"no-referrer-when-downgrade\">\n                        </iframe>\n                    </div>\n                </div>\n            </section>\n        </div>\n    </div>\n\n    <!-- Hourly Forecast Modal -->\n    <div id=\"hourlyModal\" class=\"modal\">\n        <div class=\"modal-content p-6 md:p-8\">\n            <div class=\"flex justify-between items-center mb-6\">\n                <div>\n                    <h2 class=\"text-2xl font-bold text-white flex items-center gap-2\">\n                        <span class=\"text-3xl\">‚è∞</span> 24-Hour Detailed Forecast\n                    </h2>\n                    <div class=\"mt-3\">\n                        <select id=\"hourlyChartSelect\" class=\"bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\">\n                            <option value=\"all\">All Charts</option>\n                            <option value=\"temp\">Temperature</option>\n                            <option value=\"precip\">Precipitation</option>\n                            <option value=\"wind\">Wind Speed</option>\n                            <option value=\"humidity\">Humidity</option>\n                            <option value=\"pressure\">Pressure</option>\n                            <option value=\"snow\">Snowfall</option>\n                        </select>\n                    </div>\n                </div>\n                <button id=\"closeHourlyModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n            <div class=\"space-y-6\">\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"temp\">\n                    <canvas id=\"hourlyTempChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"precip\">\n                    <canvas id=\"hourlyPrecipChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"wind\">\n                    <canvas id=\"hourlyWindChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"humidity\">\n                    <canvas id=\"hourlyHumidityChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"pressure\">\n                    <canvas id=\"hourlyPressureChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"snow\">\n                    <canvas id=\"hourlySnowChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div id=\"hourlyDetails\" class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <!-- Detailed hourly items will be inserted here -->\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Daily Forecast Modal -->\n    <div id=\"dailyModal\" class=\"modal\">\n        <div class=\"modal-content p-6 md:p-8\">\n            <div class=\"flex justify-between items-center mb-6\">\n                <div>\n                    <h2 class=\"text-2xl font-bold text-white flex items-center gap-2\">\n                        <span class=\"text-3xl\">üìÖ</span> 14-Day Detailed Forecast\n                    </h2>\n                    <div class=\"mt-3\">\n                        <select id=\"dailyChartSelect\" class=\"bg-gray-700 text-white border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500\">\n                            <option value=\"all\">All Charts</option>\n                            <option value=\"temp\">Temperature</option>\n                            <option value=\"precip\">Precipitation</option>\n                            <option value=\"wind\">Wind Speed</option>\n                            <option value=\"pressure\">Pressure</option>\n                            <option value=\"snow\">Snowfall</option>\n                            <option value=\"moon\">Moon Phase</option>\n                        </select>\n                    </div>\n                </div>\n                <button id=\"closeDailyModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n            <div class=\"space-y-6\">\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"temp\">\n                    <canvas id=\"dailyTempChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"precip\">\n                    <canvas id=\"dailyPrecipChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"wind\">\n                    <canvas id=\"dailyWindChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"pressure\">\n                    <canvas id=\"dailyPressureChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"snow\">\n                    <canvas id=\"dailySnowChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div class=\"card rounded-xl p-4 chart-container\" data-chart-type=\"moon\">\n                    <canvas id=\"dailyMoonPhaseChart\" style=\"height: 250px;\"></canvas>\n                </div>\n                <div id=\"dailyDetails\" class=\"space-y-3\">\n                    <!-- Detailed daily items will be inserted here -->\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Moon Details Modal -->\n    <div id=\"moonDetailsModal\" class=\"modal\">\n        <div class=\"modal-content p-6 md:p-8 max-w-2xl\">\n            <div class=\"flex justify-between items-center mb-6\">\n                <h2 class=\"text-2xl font-bold text-white flex items-center gap-2\">\n                    <span class=\"text-3xl\">üåô</span> Moon Details\n                </h2>\n                <button id=\"closeMoonDetailsModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n            <div class=\"space-y-6\">\n                <div class=\"text-center\">\n                    <div id=\"moonDetailsEmoji\" class=\"text-8xl mb-4\"></div>\n                    <div id=\"moonDetailsName\" class=\"text-2xl font-bold text-white mb-2\"></div>\n                    <div id=\"moonDetailsDate\" class=\"text-gray-400\"></div>\n                </div>\n                <div class=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-sun text-yellow-400 mr-1\"></i>Illumination</div>\n                        <div id=\"moonIllumination\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-arrow-up text-blue-400 mr-1\"></i>Moonrise</div>\n                        <div id=\"moonRise\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-arrow-down text-orange-400 mr-1\"></i>Moonset</div>\n                        <div id=\"moonSet\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-ruler text-purple-400 mr-1\"></i>Distance</div>\n                        <div id=\"moonDistance\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-calendar text-green-400 mr-1\"></i>Next Full Moon</div>\n                        <div id=\"nextFullMoon\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                    <div class=\"stat-card rounded-xl p-4\">\n                        <div class=\"text-gray-400 text-sm mb-1\"><i class=\"fas fa-calendar text-gray-300 mr-1\"></i>Next New Moon</div>\n                        <div id=\"nextNewMoon\" class=\"text-2xl font-bold text-white\"></div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Symptom Risk Details Modal -->\n    <div id=\"symptomRiskModal\" class=\"modal\">\n        <div class=\"modal-content p-6 md:p-8 max-w-3xl\">\n            <div class=\"flex justify-between items-center mb-6\">\n                <h2 id=\"symptomRiskModalTitle\" class=\"text-2xl font-bold text-white flex items-center gap-2\">\n                    <span class=\"text-3xl\" id=\"symptomRiskModalIcon\"></span>\n                    <span id=\"symptomRiskModalTitleText\"></span>\n                </h2>\n                <button id=\"closeSymptomRiskModal\" class=\"text-gray-400 hover:text-white text-2xl transition-colors\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n            \n            <!-- Current Values Section -->\n            <div class=\"mb-6\">\n                <h3 class=\"text-lg font-semibold text-white mb-3\">Current Values</h3>\n                <div id=\"symptomCurrentValues\" class=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n                    <!-- Populated by JavaScript -->\n                </div>\n            </div>\n            \n            <!-- Formula Section -->\n            <div class=\"space-y-6\">\n                <div id=\"sinusFormulaSection\" class=\"hidden\">\n                    <h3 class=\"text-lg font-semibold text-white mb-3\"><i class=\"fas fa-head-side-cough text-blue-300 mr-2\"></i>Sinus Risk Calculation</h3>\n                    <div class=\"stat-card rounded-xl p-5 space-y-4\">\n                        <p class=\"text-gray-300 text-sm mb-4\">\n                            Sinus symptoms are often triggered by rapid barometric pressure changes, high humidity, and temperature fluctuations. \n                            This index aggregates key meteorological factors associated with sinus discomfort.\n                        </p>\n                        \n                        <div class=\"formula-container\">\n                            <div class=\"text-white\">\n                                \\[ \\text{Sinus Risk} = \\sum \\text{(Factors)} \\]\n                            </div>\n                        </div>\n                        \n                        <h4 class=\"text-white font-semibold mt-4\">Factor Scoring:</h4>\n                        \n                        <div class=\"space-y-3\">\n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-tachometer-alt mr-2\"></i>Pressure Change (inHg)</div>\n                                <div class=\"text-gray-300 text-sm mb-2\">Day-over-day barometric pressure change:</div>\n                                <div class=\"formula-container\">\n                                    \\[ \\Delta P = P_{\\text{today}} - P_{\\text{yesterday}} \\]\n                                </div>\n                                <ul class=\"text-gray-400 text-sm mt-2 space-y-1\">\n                                    <li>‚Ä¢ \\(\\Delta P < -0.30\\) inHg ‚Üí <span class=\"text-red-400 font-semibold\">+5 points</span> (severe drop)</li>\n                                    <li>‚Ä¢ \\(-0.30 \\leq \\Delta P < -0.18\\) inHg ‚Üí <span class=\"text-orange-400 font-semibold\">+3 points</span></li>\n                                    <li>‚Ä¢ \\(-0.18 \\leq \\Delta P < -0.10\\) inHg ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></li>\n                                </ul>\n                            </div>\n                            \n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-tint mr-2\"></i>Humidity</div>\n                                <div class=\"text-gray-400 text-sm\">\n                                    ‚Ä¢ Humidity \\(> 70\\%\\) ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span>\n                                </div>\n                            </div>\n                            \n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-cloud-rain mr-2\"></i>Precipitation</div>\n                                <div class=\"text-gray-400 text-sm\">\n                                    ‚Ä¢ Precipitation \\(> 0.1\\) in ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span>\n                                </div>\n                            </div>\n                            \n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-blue-300 font-semibold mb-2\"><i class=\"fas fa-thermometer-half mr-2\"></i>Temperature Swing</div>\n                                <div class=\"text-gray-300 text-sm mb-2\">Daily high-low difference:</div>\n                                <div class=\"formula-container\">\n                                    \\[ \\Delta T = T_{\\max} - T_{\\min} \\]\n                                </div>\n                                <div class=\"text-gray-400 text-sm mt-2\">\n                                    ‚Ä¢ \\(\\Delta T > 20¬∞F\\) ‚Üí <span class=\"text-yellow-400 font-semibold\">+1 point</span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <div id=\"allergyFormulaSection\" class=\"hidden\">\n                    <h3 class=\"text-lg font-semibold text-white mb-3\"><i class=\"fas fa-seedling text-green-300 mr-2\"></i>Allergy Risk Calculation</h3>\n                    <div class=\"stat-card rounded-xl p-5 space-y-4\">\n                        <p class=\"text-gray-300 text-sm mb-4\">\n                            This calculation uses real pollen data from Open-Meteo, measuring actual pollen counts (grains/m¬≥) for tree, grass, and weed pollen to provide accurate allergy risk assessment.\n                        </p>\n                        \n                        <div class=\"formula-container\">\n                            <div class=\"text-white\">\n                                \\[ \\text{Allergy Risk} = \\sum \\text{(Factors)} \\]\n                            </div>\n                        </div>\n                        \n                        <h4 class=\"text-white font-semibold mt-4\">Factor Scoring:</h4>\n                        <div class=\"space-y-3 mt-3\">\n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-leaf mr-2\"></i>Pollen Count (max of Tree/Grass/Weed)</div>\n                                <ul class=\"text-gray-400 text-sm space-y-1\">\n                                    <li>‚Ä¢ \\(P > 200\\) grains/m¬≥ (Very High) ‚Üí <span class=\"text-red-400 font-semibold\">+5 points</span></li>\n                                    <li>‚Ä¢ \\(80 < P \\leq 200\\) grains/m¬≥ (High) ‚Üí <span class=\"text-orange-400 font-semibold\">+4 points</span></li>\n                                    <li>‚Ä¢ \\(20 < P \\leq 80\\) grains/m¬≥ (Moderate) ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></li>\n                                    <li>‚Ä¢ \\(0 < P \\leq 20\\) grains/m¬≥ (Low) ‚Üí <span class=\"text-green-400 font-semibold\">+1 point</span></li>\n                                </ul>\n                            </div>\n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-wind mr-2\"></i>Wind (disperses pollen)</div>\n                                <div class=\"text-gray-400 text-sm\">‚Ä¢ Wind \\(> 10\\) mph ‚Üí <span class=\"text-yellow-400 font-semibold\">+2 points</span></div>\n                            </div>\n                            <div class=\"stat-card rounded-lg p-3\">\n                                <div class=\"text-green-300 font-semibold mb-2\"><i class=\"fas fa-cloud-rain mr-2\"></i>Rain Washout</div>\n                                <div class=\"text-gray-400 text-sm\">‚Ä¢ Precipitation \\(> 0.1\\) in ‚Üí <span class=\"text-green-400 font-semibold\">‚àí2 points</span></div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <!-- Risk Level Legend -->\n                <div class=\"mt-6\">\n                    <h3 class=\"text-lg font-semibold text-white mb-3\">Risk Level Scale</h3>\n                    <div class=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n                        <div class=\"stat-card rounded-lg p-3 text-center\">\n                            <div class=\"text-green-400 font-bold text-xl\">0-2</div>\n                            <div class=\"text-gray-400 text-sm\">Low</div>\n                        </div>\n                        <div class=\"stat-card rounded-lg p-3 text-center\">\n                            <div class=\"text-yellow-400 font-bold text-xl\">3-4</div>\n                            <div class=\"text-gray-400 text-sm\">Moderate</div>\n                        </div>\n                        <div class=\"stat-card rounded-lg p-3 text-center\">\n                            <div class=\"text-orange-400 font-bold text-xl\">5-7</div>\n                            <div class=\"text-gray-400 text-sm\">High</div>\n                        </div>\n                        <div class=\"stat-card rounded-lg p-3 text-center\">\n                            <div class=\"text-red-400 font-bold text-xl\">8-10</div>\n                            <div class=\"text-gray-400 text-sm\">Very High</div>\n                        </div>\n                    </div>\n                </div>\n                \n                <p class=\"text-gray-500 text-xs mt-4 text-center\">\n                    <i class=\"fas fa-info-circle mr-1\"></i>\n                    These indices are estimates based on meteorological data and general associations. \n                    Individual sensitivity may vary. Consult a healthcare provider for medical advice.\n                </p>\n            </div>\n        </div>\n    </div>\n\n    <script src=\"app.js\"></script>\n    \n    <!-- Footer -->\n    <footer class=\"text-center mt-8 mb-4 py-4 border-t border-gray-700/50\">\n        <p class=\"text-gray-500 text-sm\">Vibecoded with <span class=\"text-gray-500\">‚ù§Ô∏è</span> by Jack A</p>\n        <p class=\"text-gray-600 text-xs mt-2\">Weather data provided by Open-Meteo</p>\n        <a href=\"https://strike.me/anglim3\" target=\"_blank\" rel=\"noopener noreferrer\" \n           class=\"inline-flex items-center gap-2 mt-3 px-4 py-2 text-sm text-gray-400 hover:text-white bg-gray-800/50 hover:bg-gray-700/50 border border-gray-600/50 hover:border-gray-500/50 rounded-lg transition-all\">\n            <svg class=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M23.638 14.904c-1.602 6.43-8.113 10.34-14.542 8.736C2.67 22.05-1.244 15.525.362 9.105 1.962 2.67 8.475-1.243 14.9.358c6.43 1.605 10.342 8.115 8.738 14.548v-.002zm-6.35-4.613c.24-1.59-.974-2.45-2.64-3.03l.54-2.153-1.315-.33-.525 2.107c-.345-.087-.705-.167-1.064-.25l.526-2.127-1.32-.33-.54 2.165c-.285-.067-.565-.132-.84-.2l-1.815-.45-.35 1.407s.975.225.955.236c.535.136.63.486.615.766l-1.477 5.92c-.075.166-.24.406-.614.314.015.02-.96-.24-.96-.24l-.66 1.51 1.71.426.93.242-.54 2.19 1.32.327.54-2.17c.36.1.705.19 1.05.273l-.51 2.154 1.32.33.545-2.19c2.24.427 3.93.257 4.64-1.774.57-1.637-.03-2.58-1.217-3.196.854-.193 1.5-.76 1.68-1.93h.01zm-3.01 4.22c-.404 1.64-3.157.75-4.05.53l.72-2.9c.896.23 3.757.67 3.33 2.37zm.41-4.24c-.37 1.49-2.662.735-3.405.55l.654-2.64c.744.18 3.137.52 2.75 2.084v.006z\"/>\n            </svg>\n            Donate\n        </a>\n    </footer>\n</body>\n</html>\n\n";
const JS_CONTENT = "let currentLat = null;\nlet currentLon = null;\nlet currentLocationName = null;\nlet currentWeatherData = null; // Store full weather data for modals\nlet favorites = []; // Array of favorite locations\nlet hourlyChart = null;\nlet dailyChart = null;\n// Layer switching removed - Ventusky handles layers internally\n\n// Format units from API (e.g., \"mp/h\" -> \"mph\")\nfunction formatUnit(unit) {\n    if (!unit) return '';\n    return unit.replace('mp/h', 'mph');\n}\n\n// Favorites management using IndexedDB (more persistent than localStorage)\nlet favoritesDB = null;\n\n// Initialize IndexedDB\nfunction initFavoritesDB() {\n    return new Promise((resolve, reject) => {\n        const request = indexedDB.open('WeatherAppDB', 1);\n        \n        request.onerror = () => reject(request.error);\n        request.onsuccess = () => {\n            favoritesDB = request.result;\n            resolve(favoritesDB);\n        };\n        \n        request.onupgradeneeded = (event) => {\n            const db = event.target.result;\n            if (!db.objectStoreNames.contains('favorites')) {\n                db.createObjectStore('favorites', { keyPath: 'id', autoIncrement: true });\n            }\n        };\n    });\n}\n\n// Load favorites from IndexedDB\nasync function loadFavorites() {\n    try {\n        if (!favoritesDB) {\n            await initFavoritesDB();\n        }\n        \n        const transaction = favoritesDB.transaction(['favorites'], 'readonly');\n        const store = transaction.objectStore('favorites');\n        const request = store.getAll();\n        \n        request.onsuccess = () => {\n            const dbFavorites = request.result;\n            \n            // If IndexedDB is empty, try to migrate from localStorage\n            if (dbFavorites.length === 0) {\n                const saved = localStorage.getItem('weatherFavorites');\n                if (saved) {\n                    try {\n                        const localFavorites = JSON.parse(saved);\n                        if (localFavorites && localFavorites.length > 0) {\n                            // Migrate from localStorage to IndexedDB\n                            favorites = localFavorites;\n                            saveFavorites(); // This will save to IndexedDB\n                            return;\n                        }\n                    } catch (e) {\n                        console.error('Error parsing localStorage favorites:', e);\n                    }\n                }\n            }\n            \n            // Extract favorites from IndexedDB (remove id field)\n            favorites = dbFavorites.map(fav => ({\n                name: fav.name,\n                lat: fav.lat,\n                lon: fav.lon\n            }));\n            renderFavorites();\n        };\n        \n        request.onerror = () => {\n            console.error('Error loading favorites from IndexedDB');\n            // Fallback to localStorage\n            const saved = localStorage.getItem('weatherFavorites');\n            if (saved) {\n                try {\n                    favorites = JSON.parse(saved);\n                } catch (e) {\n                    favorites = [];\n                }\n            }\n            renderFavorites();\n        };\n    } catch (error) {\n        console.error('Error initializing favorites DB:', error);\n        // Fallback to localStorage if IndexedDB fails\n        const saved = localStorage.getItem('weatherFavorites');\n        if (saved) {\n            try {\n                favorites = JSON.parse(saved);\n            } catch (e) {\n                favorites = [];\n            }\n        }\n        renderFavorites();\n    }\n}\n\n// Save favorites to IndexedDB\nasync function saveFavorites() {\n    try {\n        if (!favoritesDB) {\n            await initFavoritesDB();\n        }\n        \n        const transaction = favoritesDB.transaction(['favorites'], 'readwrite');\n        const store = transaction.objectStore('favorites');\n        \n        // Clear existing favorites\n        await new Promise((resolve, reject) => {\n            const clearRequest = store.clear();\n            clearRequest.onsuccess = () => resolve();\n            clearRequest.onerror = () => reject(clearRequest.error);\n        });\n        \n        // Add all current favorites\n        const promises = favorites.map(fav => {\n            return new Promise((resolve, reject) => {\n                const addRequest = store.add(fav);\n                addRequest.onsuccess = () => resolve();\n                addRequest.onerror = () => reject(addRequest.error);\n            });\n        });\n        \n        await Promise.all(promises);\n        \n        // Also save to localStorage as backup\n        localStorage.setItem('weatherFavorites', JSON.stringify(favorites));\n        \n        renderFavorites();\n    } catch (error) {\n        console.error('Error saving favorites to IndexedDB:', error);\n        // Fallback to localStorage\n        try {\n            localStorage.setItem('weatherFavorites', JSON.stringify(favorites));\n        } catch (e) {\n            console.error('Error saving to localStorage:', e);\n        }\n        renderFavorites();\n    }\n}\n\nfunction addFavorite() {\n    if (!currentLat || !currentLon || !currentLocationName) {\n        alert('Please search for a location first or use your current location.');\n        return;\n    }\n    \n    // Check if already in favorites\n    const exists = favorites.some(fav => \n        Math.abs(fav.lat - currentLat) < 0.001 && \n        Math.abs(fav.lon - currentLon) < 0.001\n    );\n    \n    if (exists) {\n        alert('This location is already in your favorites.');\n        return;\n    }\n    \n    favorites.push({\n        name: currentLocationName,\n        lat: currentLat,\n        lon: currentLon\n    });\n    \n    saveFavorites();\n}\n\nfunction removeFavorite(index) {\n    favorites.splice(index, 1);\n    saveFavorites();\n}\n\nfunction switchToFavorite(lat, lon, name) {\n    currentLocationName = name;\n    fetchWeather(lat, lon);\n    document.getElementById('favoritesDropdown').classList.add('hidden');\n}\n\nfunction renderFavorites() {\n    const favoritesList = document.getElementById('favoritesList');\n    const noFavorites = document.getElementById('noFavorites');\n    \n    favoritesList.innerHTML = '';\n    \n    if (favorites.length === 0) {\n        noFavorites.classList.remove('hidden');\n        favoritesList.classList.add('hidden');\n    } else {\n        noFavorites.classList.add('hidden');\n        favoritesList.classList.remove('hidden');\n        \n        favorites.forEach((fav, index) => {\n            const favItem = document.createElement('div');\n            favItem.className = 'flex items-center justify-between p-3 hover:bg-white/10 rounded-lg mb-1';\n            \n            const nameDiv = document.createElement('div');\n            nameDiv.className = 'flex-1 cursor-pointer';\n            nameDiv.innerHTML = `\n                <div class=\"text-white font-semibold\">${fav.name}</div>\n                <div class=\"text-white/60 text-xs\">${fav.lat.toFixed(4)}, ${fav.lon.toFixed(4)}</div>\n            `;\n            nameDiv.addEventListener('click', () => switchToFavorite(fav.lat, fav.lon, fav.name));\n            \n            const deleteBtn = document.createElement('button');\n            deleteBtn.className = 'text-red-400 hover:text-red-300 ml-2 p-1';\n            deleteBtn.innerHTML = '<i class=\"fas fa-trash\"></i>';\n            deleteBtn.addEventListener('click', (e) => {\n                e.stopPropagation();\n                removeFavorite(index);\n            });\n            \n            favItem.appendChild(nameDiv);\n            favItem.appendChild(deleteBtn);\n            favoritesList.appendChild(favItem);\n        });\n    }\n}\n\n// Prevent iframe from opening new tabs\n// Override window.open globally to prevent Ventusky iframe from opening new tabs\nconst originalWindowOpen = window.open;\nwindow.open = function(url, target, features) {\n    // Block any attempts to open new tabs/windows from iframes\n    if (url && (url.includes('ventusky.com') || url.includes('ventusky'))) {\n        console.log('Blocked Ventusky window.open:', url);\n        return null;\n    }\n    // Also block if target is _blank and URL is from Ventusky\n    if (target === '_blank' && url && (url.includes('ventusky.com') || url.includes('ventusky'))) {\n        console.log('Blocked Ventusky _blank link:', url);\n        return null;\n    }\n    // Allow other window.open calls (for legitimate uses)\n    return originalWindowOpen.apply(this, arguments);\n};\n\n// Intercept postMessage from iframe that might try to open new tabs\nwindow.addEventListener('message', (event) => {\n    // Only trust messages from Ventusky domain\n    if (event.origin.includes('ventusky.com')) {\n        // Block any messages that might trigger navigation\n        if (event.data && (typeof event.data === 'string' || typeof event.data === 'object')) {\n            const dataStr = JSON.stringify(event.data);\n            if (dataStr.includes('open') || dataStr.includes('navigate') || dataStr.includes('window')) {\n                console.log('Blocked Ventusky postMessage:', event.data);\n                event.stopPropagation();\n                return false;\n            }\n        }\n    }\n}, { capture: true });\n\n// Initialize with user's location or default\nwindow.addEventListener('DOMContentLoaded', () => {\n    loadFavorites();\n    \n    // Favorites button click handler\n    document.getElementById('favoritesBtn').addEventListener('click', (e) => {\n        e.stopPropagation();\n        const dropdown = document.getElementById('favoritesDropdown');\n        dropdown.classList.toggle('hidden');\n    });\n    \n    // Add favorite button\n    document.getElementById('addFavoriteBtn').addEventListener('click', (e) => {\n        e.stopPropagation();\n        addFavorite();\n    });\n    \n    // Close dropdown when clicking outside\n    document.addEventListener('click', (e) => {\n        const dropdown = document.getElementById('favoritesDropdown');\n        const btn = document.getElementById('favoritesBtn');\n        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {\n            dropdown.classList.add('hidden');\n        }\n    });\n    \n    if (navigator.geolocation) {\n        navigator.geolocation.getCurrentPosition(\n            (position) => {\n                currentLat = position.coords.latitude;\n                currentLon = position.coords.longitude;\n                fetchWeather(currentLat, currentLon);\n            },\n            () => {\n                // Default to London if geolocation fails\n                fetchWeather(51.5074, -0.1278);\n            }\n        );\n    } else {\n        fetchWeather(51.5074, -0.1278);\n    }\n});\n\n// Search functionality\ndocument.getElementById('searchBtn').addEventListener('click', handleSearch);\ndocument.getElementById('locationInput').addEventListener('keypress', (e) => {\n    if (e.key === 'Enter') handleSearch();\n});\ndocument.getElementById('locationBtn').addEventListener('click', () => {\n    if (navigator.geolocation) {\n        navigator.geolocation.getCurrentPosition(\n            (position) => {\n                currentLat = position.coords.latitude;\n                currentLon = position.coords.longitude;\n                fetchWeather(currentLat, currentLon);\n            },\n            () => showError('Unable to get your location. Please search for a city.')\n        );\n    } else {\n        showError('Geolocation is not supported by your browser.');\n    }\n});\n\n// State abbreviation to full name mapping (US states)\nconst STATE_ABBREVIATIONS = {\n    'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',\n    'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',\n    'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',\n    'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',\n    'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',\n    'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',\n    'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',\n    'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',\n    'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',\n    'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming',\n    'DC': 'District of Columbia'\n};\n\n// Reverse mapping (full name to abbreviation)\nconst STATE_NAMES_TO_ABBR = {};\nObject.keys(STATE_ABBREVIATIONS).forEach(abbr => {\n    STATE_NAMES_TO_ABBR[STATE_ABBREVIATIONS[abbr].toLowerCase()] = abbr;\n});\n\nfunction normalizeState(stateInput) {\n    if (!stateInput) return null;\n    const state = stateInput.trim();\n    // Check if it's an abbreviation\n    if (state.length <= 2) {\n        return STATE_ABBREVIATIONS[state.toUpperCase()] || state;\n    }\n    // Check if it's a full name\n    const lowerState = state.toLowerCase();\n    if (STATE_NAMES_TO_ABBR[lowerState]) {\n        return STATE_ABBREVIATIONS[STATE_NAMES_TO_ABBR[lowerState]];\n    }\n    // Return as-is if not found\n    return state;\n}\n\nfunction matchesState(result, searchState) {\n    if (!searchState) return true;\n    const resultAdmin1 = (result.admin1 || '').toLowerCase();\n    const normalizedSearch = normalizeState(searchState).toLowerCase();\n    return resultAdmin1 === normalizedSearch || \n           resultAdmin1.includes(normalizedSearch) || \n           normalizedSearch.includes(resultAdmin1);\n}\n\nasync function handleSearch() {\n    const query = document.getElementById('locationInput').value.trim();\n    if (!query) return;\n\n    try {\n        // Parse \"City, State\" or \"City, State, Country\" format\n        const parts = query.split(',').map(p => p.trim());\n        const city = parts[0];\n        const state = parts.length > 1 ? parts[1] : null;\n        const country = parts.length > 2 ? parts[2] : null;\n        \n        // Build search query - use city name, optionally add country filter\n        let searchUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}`;\n        if (country) {\n            searchUrl += `&country=${encodeURIComponent(country)}`;\n        }\n        // Get more results to filter through (up to 10)\n        searchUrl += `&count=10`;\n        \n        const response = await fetch(searchUrl);\n        const data = await response.json();\n        \n        if (data.results && data.results.length > 0) {\n            let result = data.results[0];\n            \n            // If state was provided, try to find a match\n            if (state) {\n                const stateMatch = data.results.find(r => matchesState(r, state));\n                if (stateMatch) {\n                    result = stateMatch;\n                } else {\n                    // If no exact match, show all results and let user know\n                    console.log('State not found, using first result:', result);\n                }\n            }\n            \n            currentLat = result.latitude;\n            currentLon = result.longitude;\n            \n            // Store the location name for display - try multiple fields\n            const name = result.name || result.admin1 || result.admin2 || '';\n            const resultCountry = result.country || '';\n            const admin1 = result.admin1 || '';\n            \n            // Check if it's US (handle various formats)\n            const isUS = resultCountry && (\n                resultCountry.includes('United States') || \n                resultCountry === 'US' || \n                resultCountry === 'USA'\n            );\n            \n            if (name && resultCountry) {\n                // For US locations, prefer \"City, State\" format\n                if (isUS && admin1) {\n                    currentLocationName = `${name}, ${admin1}`;\n                } else if (!isUS) {\n                    // For non-US locations, show \"City, Country\"\n                    currentLocationName = `${name}, ${resultCountry}`;\n                } else {\n                    currentLocationName = name;\n                }\n            } else if (name) {\n                currentLocationName = name;\n            } else if (admin1) {\n                currentLocationName = admin1;\n            } else {\n                currentLocationName = null; // Will trigger reverse geocoding\n            }\n            \n            fetchWeather(currentLat, currentLon);\n        } else {\n            showError('Location not found. Please try another search.');\n        }\n    } catch (error) {\n        showError('Error searching for location. Please try again.');\n        console.error(error);\n    }\n}\n\nasync function fetchWeather(lat, lon) {\n    showLoading();\n    hideError();\n    hideContent();\n\n    try {\n        // Make direct request to Open-Meteo from browser (uses user's IP, not shared Cloudflare IP)\n        const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,wind_speed_10m,uv_index,weather_code,dewpoint_2m,surface_pressure&hourly=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,precipitation_probability,precipitation,snowfall,surface_pressure&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,precipitation_probability_max,snowfall_sum,sunrise,sunset&forecast_days=14&past_days=2&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=auto`);\n\n        // Check for rate limiting before parsing JSON\n        if (weatherResponse.status === 429) {\n            const errorData = await weatherResponse.json().catch(() => ({ error: true, reason: 'Rate limit exceeded' }));\n            showError(errorData.reason || 'Rate limit exceeded. Please wait a moment and try again.');\n            return;\n        }\n\n        if (!weatherResponse.ok) {\n            const errorData = await weatherResponse.json().catch(() => ({ error: true, reason: 'Failed to fetch weather data' }));\n            showError(errorData.reason || `Failed to fetch weather data (${weatherResponse.status})`);\n            return;\n        }\n\n        const weatherData = await weatherResponse.json();\n\n        if (weatherData.error) {\n            showError(weatherData.reason || 'Failed to fetch weather data');\n            return;\n        }\n\n        // If we don't have a stored location name, try to get it via reverse geocoding\n        if (!currentLocationName) {\n            try {\n                // Make direct request to BigDataCloud from browser (uses user's IP, not shared Cloudflare IP)\n                const controller = new AbortController();\n                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout\n                \n                const reverseGeoResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&localityLanguage=en`, {\n                    signal: controller.signal\n                });\n                \n                clearTimeout(timeoutId);\n                \n                if (!reverseGeoResponse.ok) {\n                    throw new Error(`HTTP ${reverseGeoResponse.status}`);\n                }\n                \n                const data = await reverseGeoResponse.json();\n                \n                // BigDataCloud returns data directly - transform to match expected format\n                if (data) {\n                    // Try to get city name, fallback to town, village, or municipality\n                    const cityName = data.city || data.locality || data.town || data.village || data.municipality || data.county;\n                    const stateName = data.principalSubdivision;\n                    const countryName = data.countryName;\n                    \n                    // Check if it's US (handle various formats like \"United States\", \"United States of America\", etc.)\n                    const isUS = countryName && (\n                        countryName.includes('United States') || \n                        countryName === 'US' || \n                        countryName === 'USA'\n                    );\n                    \n                    if (cityName) {\n                        if (stateName && isUS) {\n                            // For US locations, show \"City, State\"\n                            currentLocationName = `${cityName}, ${stateName}`;\n                        } else if (countryName && !isUS) {\n                            // For non-US locations, show \"City, Country\"\n                            currentLocationName = `${cityName}, ${countryName}`;\n                        } else {\n                            currentLocationName = cityName;\n                        }\n                    } else if (stateName && isUS) {\n                        currentLocationName = stateName;\n                    } else if (countryName && !isUS) {\n                        currentLocationName = countryName;\n                    }\n                }\n            } catch (error) {\n                // Log error for debugging but don't break the app\n                console.error('Reverse geocoding failed:', error.message);\n            }\n        }\n\n        currentWeatherData = weatherData; // Store for modals\n        displayWeather(weatherData);\n        \n        // Initialize Ventusky radar\n        initializeVentuskyRadar(lat, lon);\n        \n        // Fetch weather alerts (for US locations)\n        fetchWeatherAlerts(lat, lon);\n        \n        // Fetch air quality data\n        fetchAirQuality(lat, lon);\n    } catch (error) {\n        showError('Failed to fetch weather data. Please try again.');\n        console.error(error);\n    } finally {\n        hideLoading();\n    }\n}\n\nfunction displayWeather(data) {\n    // Use stored location name if available (from search or reverse geocoding)\n    let location = currentLocationName;\n    \n    // If we still don't have a location name, show coordinates as last resort\n    if (!location) {\n        location = `${data.latitude.toFixed(2)}, ${data.longitude.toFixed(2)}`;\n    }\n\n    // Current weather\n    document.getElementById('currentLocation').textContent = location;\n    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { \n        weekday: 'long', \n        year: 'numeric', \n        month: 'long', \n        day: 'numeric' \n    });\n    \n    // Last updated timestamp\n    document.getElementById('lastUpdated').textContent = `Updated ${formatLastUpdated(new Date())}`;\n    \n    document.getElementById('currentTemp').textContent = `${Math.round(data.current.temperature_2m)}${data.current_units.temperature_2m}`;\n\n    // Display today's high/low temperatures (index 2 because of past_days=2)\n    if (data.daily && data.daily.temperature_2m_max && data.daily.temperature_2m_max[2] !== undefined) {\n        const todayHigh = Math.round(data.daily.temperature_2m_max[2]);\n        const todayLow = Math.round(data.daily.temperature_2m_min[2]);\n        document.getElementById('currentHighLow').textContent = `H:${todayHigh}¬∞ L:${todayLow}¬∞`;\n    }\n\n    document.getElementById('currentCondition').textContent = getWeatherDescription(data.current.weather_code);\n    document.getElementById('feelsLike').textContent = `${Math.round(data.current.apparent_temperature)}${data.current_units.apparent_temperature}`;\n    document.getElementById('humidity').textContent = `${data.current.relative_humidity_2m}${data.current_units.relative_humidity_2m}`;\n    \n    // Dew point\n    if (data.current.dewpoint_2m !== undefined) {\n        document.getElementById('dewPoint').textContent = `${Math.round(data.current.dewpoint_2m)}${data.current_units.dewpoint_2m}`;\n    }\n    \n    document.getElementById('windSpeed').textContent = `${data.current.wind_speed_10m} ${formatUnit(data.current_units.wind_speed_10m)}`;\n    document.getElementById('uvIndex').textContent = data.current.uv_index;\n    \n    // Pressure with trend\n    displayPressure(data);\n    \n    // Sunrise and sunset times (for today, index 0)\n    if (data.daily && data.daily.sunrise && data.daily.sunrise[0]) {\n        const sunriseTime = new Date(data.daily.sunrise[0]);\n        document.getElementById('sunrise').textContent = formatTime12Hour(sunriseTime);\n    }\n    if (data.daily && data.daily.sunset && data.daily.sunset[0]) {\n        const sunsetTime = new Date(data.daily.sunset[0]);\n        document.getElementById('sunset').textContent = formatTime12Hour(sunsetTime);\n    }\n    \n    // Moon phase (for today)\n    const today = new Date();\n    const moonPhaseValue = calculateMoonPhase(today);\n    const moonPhase = getMoonPhase(moonPhaseValue);\n    document.getElementById('moonPhaseEmoji').textContent = moonPhase.emoji;\n    document.getElementById('moonPhaseName').textContent = moonPhase.name;\n    \n    // Make moon phase card clickable\n    const moonPhaseCard = document.getElementById('moonPhase');\n    if (moonPhaseCard) {\n        moonPhaseCard.style.cursor = 'pointer';\n        moonPhaseCard.addEventListener('click', () => openMoonDetailsModal(today));\n    }\n\n    // Calculate and display symptom risks\n    if (data.hourly && data.hourly.surface_pressure) {\n        // Get today's date and yesterday's date\n        const todayDate = new Date();\n        const yesterdayDate = new Date(todayDate);\n        yesterdayDate.setDate(yesterdayDate.getDate() - 1);\n        \n        // Calculate daily averages for today and yesterday\n        const todayAvg = calculateDailyAverages(data.hourly, todayDate);\n        const yesterdayAvg = calculateDailyAverages(data.hourly, yesterdayDate);\n        \n        if (todayAvg) {\n            // Calculate pressure change (today - yesterday)\n            const pressureChange = yesterdayAvg ? \n                (todayAvg.avgPressureInhg - yesterdayAvg.avgPressureInhg) : 0;\n            \n            // Get temperature swing from daily data (today is at index 2 due to past_days=2)\n            const todayIndex = 2;\n            const tempSwing = data.daily.temperature_2m_max[todayIndex] - \n                             data.daily.temperature_2m_min[todayIndex];\n            \n            // Store symptom data for modal display\n            currentSymptomData = {\n                pressureChange: pressureChange,\n                humidity: todayAvg.avgHumidity,\n                precipitation: todayAvg.precipSum,\n                tempSwing: tempSwing,\n                avgTemp: todayAvg.avgTemp,\n                windMax: todayAvg.windMax\n            };\n            \n            // Calculate risks\n            const sinusRisk = calculateSinusRisk(\n                pressureChange, \n                todayAvg.avgHumidity, \n                todayAvg.precipSum, \n                tempSwing\n            );\n            \n            // Initial allergy risk - will be updated when pollen data arrives\n            const allergyRisk = calculateAllergyRisk(\n                todayAvg.windMax, \n                todayAvg.precipSum,\n                currentPollenData\n            );\n            \n            // Display sinus risk\n            const sinusLabel = getRiskLabel(sinusRisk);\n            document.getElementById('sinusRiskValue').textContent = `${sinusRisk}/10`;\n            document.getElementById('sinusRiskLabel').textContent = sinusLabel.label;\n            document.getElementById('sinusRiskLabel').className = `text-xs font-semibold ${sinusLabel.colorClass}`;\n            \n            // Display allergy risk\n            const allergyLabel = getRiskLabel(allergyRisk);\n            document.getElementById('allergyRiskValue').textContent = `${allergyRisk}/10`;\n            document.getElementById('allergyRiskLabel').textContent = allergyLabel.label;\n            document.getElementById('allergyRiskLabel').className = `text-xs font-semibold ${allergyLabel.colorClass}`;\n        }\n    }\n    \n    // Precipitation timing\n    displayPrecipitationTiming(data);\n\n    // Hourly forecast\n    const hourlyContainer = document.getElementById('hourlyForecast').querySelector('.flex');\n    hourlyContainer.innerHTML = '';\n    const now = new Date();\n    const currentHour = now.getHours();\n    \n    // Find the closest hour in the data\n    let startIndex = 0;\n    for (let i = 0; i < data.hourly.time.length; i++) {\n        const hourTime = new Date(data.hourly.time[i]);\n        if (hourTime.getHours() >= currentHour) {\n            startIndex = i;\n            break;\n        }\n    }\n    \n    for (let i = 0; i < 24 && (startIndex + i) < data.hourly.time.length; i++) {\n        const hourIndex = startIndex + i;\n        const hour = new Date(data.hourly.time[hourIndex]);\n        const hourItem = document.createElement('div');\n        hourItem.className = 'flex flex-col items-center bg-white/10 rounded-lg p-3 backdrop-blur-sm min-w-[80px] clickable';\n        hourItem.innerHTML = `\n            <div class=\"text-white/70 text-sm mb-1\">${formatTime12Hour(hour)}</div>\n            <div class=\"text-2xl mb-2\">${getWeatherIcon(data.hourly.weather_code[hourIndex])}</div>\n            <div class=\"text-white font-bold text-lg\">${Math.round(data.hourly.temperature_2m[hourIndex])}${data.hourly_units.temperature_2m}</div>\n            <div class=\"text-white/60 text-xs mt-1\">${data.hourly.wind_speed_10m[hourIndex]} ${formatUnit(data.hourly_units.wind_speed_10m)}</div>\n        `;\n        hourItem.addEventListener('click', () => openHourlyModal(data));\n        hourlyContainer.appendChild(hourItem);\n    }\n\n    // Daily forecast\n    const dailyContainer = document.getElementById('dailyForecast');\n    dailyContainer.innerHTML = '';\n    \n    // Check if mobile to use abbreviated day names\n    const isMobile = window.innerWidth <= 768;\n    const weekdayFormat = isMobile ? 'short' : 'long';\n    \n    for (let i = 0; i < Math.min(14, data.daily.time.length); i++) {\n        const day = parseDateString(data.daily.time[i]);\n        const dayItem = document.createElement('div');\n        dayItem.className = 'flex items-center justify-between bg-white/10 rounded-lg p-4 backdrop-blur-sm clickable';\n        dayItem.innerHTML = `\n            <div class=\"flex items-center gap-4\">\n                <div class=\"text-3xl\">${getWeatherIcon(data.daily.weather_code[i])}</div>\n                <div>\n                    <div class=\"text-white font-semibold text-lg\">${day.toLocaleDateString('en-US', { weekday: weekdayFormat })}</div>\n                    <div class=\"text-white/70 text-sm\">${day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>\n                </div>\n            </div>\n            <div class=\"flex items-center gap-6\">\n                <div class=\"text-right\">\n                    <div class=\"text-white font-bold text-xl\">${Math.round(data.daily.temperature_2m_max[i])}${data.daily_units.temperature_2m_max}</div>\n                    <div class=\"text-white/70 text-sm\">${Math.round(data.daily.temperature_2m_min[i])}${data.daily_units.temperature_2m_min}</div>\n                </div>\n                <div class=\"text-white/70 text-sm text-right min-w-[100px]\">\n                    ${data.daily.snowfall_sum && data.daily.snowfall_sum[i] > 0 ? '' : `<div><i class=\"fas fa-tint mr-1\"></i>${data.daily.precipitation_sum[i] || 0} ${data.daily_units.precipitation_sum}</div>`}\n                    ${data.daily.snowfall_sum && data.daily.snowfall_sum[i] > 0 ? `<div><i class=\"fas fa-snowflake mr-1\"></i>${data.daily.snowfall_sum[i]} ${data.daily_units.snowfall_sum || 'in'}</div>` : ''}\n                    ${data.daily.snowfall_sum && data.daily.snowfall_sum[i] > 0 ? (data.daily.precipitation_probability_max && data.daily.precipitation_probability_max[i] !== null && data.daily.precipitation_probability_max[i] !== undefined ? `<div><i class=\"fas fa-snowflake mr-1\"></i>${data.daily.precipitation_probability_max[i]}%</div>` : '') : (data.daily.precipitation_probability_max && data.daily.precipitation_probability_max[i] !== null && data.daily.precipitation_probability_max[i] !== undefined ? `<div><i class=\"fas fa-tint mr-1\"></i>${data.daily.precipitation_probability_max[i]}%</div>` : '')}\n                    <div><i class=\"fas fa-wind mr-1\"></i>${data.daily.wind_speed_10m_max[i]} ${formatUnit(data.daily_units.wind_speed_10m_max)}</div>\n                </div>\n            </div>\n        `;\n        \n        dayItem.addEventListener('click', () => openDailyModal(data));\n        dailyContainer.appendChild(dayItem);\n    }\n\n    // Display weekly snow totals if there's snow in the forecast\n    displayWeeklySnowTotals(data);\n\n    showContent();\n    \n    // Add click handlers to section headers\n    if (currentWeatherData) {\n        document.getElementById('hourlyHeader').addEventListener('click', () => openHourlyModal(currentWeatherData));\n        document.getElementById('dailyHeader').addEventListener('click', () => openDailyModal(currentWeatherData));\n    }\n}\n\nfunction displayWeeklySnowTotals(data) {\n    const snowSection = document.getElementById('weeklySnowSection');\n    const snowContent = document.getElementById('weeklySnowContent');\n    snowContent.innerHTML = '';\n    \n    // Check if there's any snow in the forecast\n    if (!data.daily.snowfall_sum) {\n        snowSection.classList.add('hidden');\n        return;\n    }\n    \n    // Collect all days with snow\n    const snowDays = [];\n    // Check if mobile to use abbreviated day names\n    const isMobile = window.innerWidth <= 768;\n    const weekdayFormat = isMobile ? 'short' : 'long';\n    \n    for (let i = 0; i < Math.min(14, data.daily.time.length); i++) {\n        const snowfall = data.daily.snowfall_sum[i] || 0;\n        if (snowfall > 0) {\n            const day = parseDateString(data.daily.time[i]);\n            const dayName = day.toLocaleDateString('en-US', { weekday: weekdayFormat });\n            const dateStr = day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n            // Round to nearest 0.1 inch\n            const roundedSnow = Math.round(snowfall * 10) / 10;\n            snowDays.push({\n                dayName,\n                dateStr,\n                snowfall: roundedSnow,\n                index: i\n            });\n        }\n    }\n    \n    if (snowDays.length === 0) {\n        snowSection.classList.add('hidden');\n        return;\n    }\n    \n    // Group consecutive days\n    const snowPeriods = [];\n    let currentPeriod = null;\n    \n    for (let i = 0; i < snowDays.length; i++) {\n        const snowDay = snowDays[i];\n        \n        if (!currentPeriod) {\n            // Start new period\n            currentPeriod = {\n                days: [snowDay],\n                totalSnow: snowDay.snowfall\n            };\n        } else {\n            // Check if consecutive (within 1 day index difference)\n            const lastDayIndex = currentPeriod.days[currentPeriod.days.length - 1].index;\n            if (snowDay.index === lastDayIndex + 1) {\n                // Consecutive day - add to current period\n                currentPeriod.days.push(snowDay);\n                currentPeriod.totalSnow += snowDay.snowfall;\n            } else {\n                // Not consecutive - save current period and start new one\n                snowPeriods.push(currentPeriod);\n                currentPeriod = {\n                    days: [snowDay],\n                    totalSnow: snowDay.snowfall\n                };\n            }\n        }\n    }\n    \n    // Add the last period\n    if (currentPeriod) {\n        snowPeriods.push(currentPeriod);\n    }\n    \n    // Display snow periods\n    snowSection.classList.remove('hidden');\n    \n    snowPeriods.forEach(period => {\n        const periodItem = document.createElement('div');\n        periodItem.className = 'bg-white/10 rounded-lg p-4 backdrop-blur-sm';\n        \n        // Round total to nearest 0.1\n        const totalSnowRounded = Math.round(period.totalSnow * 10) / 10;\n        \n        // Determine unit (inch vs inches)\n        const unit = totalSnowRounded === 1.0 ? 'inch' : 'inches';\n        \n        let periodText;\n        if (period.days.length === 1) {\n            // Single day\n            const day = period.days[0];\n            const dayUnit = day.snowfall === 1.0 ? 'inch' : 'inches';\n            periodText = `Snowfall on ${day.dayName} (${day.dateStr}) is ${totalSnowRounded.toFixed(1)} ${unit}`;\n            \n            periodItem.innerHTML = `\n                <div class=\"text-white font-semibold\">${periodText}</div>\n            `;\n        } else {\n            // Multiple days - show range\n            const firstDay = period.days[0];\n            const lastDay = period.days[period.days.length - 1];\n            periodText = `Snowfall between ${firstDay.dayName} (${firstDay.dateStr}) and ${lastDay.dayName} (${lastDay.dateStr}) is ${totalSnowRounded.toFixed(1)} ${unit}`;\n            \n            // Add breakdown of individual days\n            const dayBreakdown = period.days.map(day => {\n                const dayUnit = day.snowfall === 1.0 ? 'inch' : 'inches';\n                return `${day.dayName}: ${day.snowfall.toFixed(1)} ${dayUnit}`;\n            }).join(' ‚Ä¢ ');\n            \n            periodItem.innerHTML = `\n                <div class=\"flex-1\">\n                    <div class=\"text-white font-semibold mb-1\">${periodText}</div>\n                    <div class=\"text-white/70 text-sm\">${dayBreakdown}</div>\n                </div>\n            `;\n        }\n        \n        snowContent.appendChild(periodItem);\n    });\n}\n\nfunction getWeatherIcon(code) {\n    // WMO Weather interpretation codes\n    const icons = {\n        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',\n        45: 'üå´Ô∏è', 48: 'üå´Ô∏è',\n        51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üå¶Ô∏è',\n        56: 'üå®Ô∏è', 57: 'üå®Ô∏è',\n        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',\n        66: 'üå®Ô∏è', 67: 'üå®Ô∏è',\n        71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: '‚ùÑÔ∏è',\n        77: '‚ùÑÔ∏è',\n        80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',\n        85: 'üå®Ô∏è', 86: 'üå®Ô∏è',\n        95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'\n    };\n    return icons[code] || '‚òÄÔ∏è';\n}\n\nfunction getWeatherDescription(code) {\n    const descriptions = {\n        0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',\n        45: 'Foggy', 48: 'Depositing rime fog',\n        51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',\n        56: 'Light freezing drizzle', 57: 'Dense freezing drizzle',\n        61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',\n        66: 'Light freezing rain', 67: 'Heavy freezing rain',\n        71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow',\n        77: 'Snow grains',\n        80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',\n        85: 'Slight snow showers', 86: 'Heavy snow showers',\n        95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'\n    };\n    return descriptions[code] || 'Unknown';\n}\n\nfunction calculateMoonPhase(date) {\n    // Calculate days since known new moon (January 6, 2000 18:14 UTC)\n    const knownNewMoon = new Date('2000-01-06T18:14:00Z');\n    const daysSinceNewMoon = (date - knownNewMoon) / (1000 * 60 * 60 * 24);\n    \n    // Moon cycle is approximately 29.53058867 days\n    const moonCycle = 29.53058867;\n    const phase = (daysSinceNewMoon % moonCycle) / moonCycle;\n    \n    // Ensure phase is between 0 and 1\n    return phase < 0 ? phase + 1 : phase;\n}\n\nfunction getMoonPhase(phase) {\n    // Moon phase is a value from 0 to 1\n    // 0 = New Moon, 0.25 = First Quarter, 0.5 = Full Moon, 0.75 = Last Quarter\n    if (phase === null || phase === undefined) return { emoji: 'üåë', name: 'Unknown' };\n    \n    if (phase < 0.03 || phase >= 0.97) {\n        return { emoji: 'üåë', name: 'New Moon' };\n    } else if (phase >= 0.03 && phase < 0.22) {\n        return { emoji: 'üåí', name: 'Waxing Crescent' };\n    } else if (phase >= 0.22 && phase < 0.28) {\n        return { emoji: 'üåì', name: 'First Quarter' };\n    } else if (phase >= 0.28 && phase < 0.47) {\n        return { emoji: 'üåî', name: 'Waxing Gibbous' };\n    } else if (phase >= 0.47 && phase < 0.53) {\n        return { emoji: 'üåï', name: 'Full Moon' };\n    } else if (phase >= 0.53 && phase < 0.72) {\n        return { emoji: 'üåñ', name: 'Waning Gibbous' };\n    } else if (phase >= 0.72 && phase < 0.78) {\n        return { emoji: 'üåó', name: 'Last Quarter' };\n    } else {\n        return { emoji: 'üåò', name: 'Waning Crescent' };\n    }\n}\n\nfunction getMoonIllumination(date) {\n    // Use SunCalc to get accurate moon illumination\n    // Returns illuminated fraction (0 to 1), convert to percentage\n    const moonIllumination = SunCalc.getMoonIllumination(date);\n    return Math.round(moonIllumination.fraction * 100);\n}\n\nfunction calculateMoonDistance(date, lat, lon) {\n    // Use SunCalc to get accurate moon distance\n    // Distance is returned in kilometers, convert to miles\n    const moonPosition = SunCalc.getMoonPosition(date, lat, lon);\n    // Distance is in kilometers, convert to miles (1 km = 0.621371 miles)\n    const distanceInMiles = moonPosition.distance * 0.621371;\n    return Math.round(distanceInMiles);\n}\n\nfunction calculateMoonRiseSet(date, lat, lon) {\n    // Use SunCalc to get accurate moonrise/moonset times\n    const moonTimes = SunCalc.getMoonTimes(date, lat, lon);\n    \n    // SunCalc returns Date objects or null if moon doesn't rise/set that day\n    return {\n        rise: moonTimes.rise || null,\n        set: moonTimes.set || null,\n        alwaysUp: moonTimes.alwaysUp || false,\n        alwaysDown: moonTimes.alwaysDown || false\n    };\n}\n\nfunction getNextFullMoon(date) {\n    const currentPhase = calculateMoonPhase(date);\n    let daysToFull = 0;\n    \n    if (currentPhase < 0.5) {\n        // Before full moon\n        daysToFull = (0.5 - currentPhase) * 29.53058867;\n    } else {\n        // After full moon, next one is in next cycle\n        daysToFull = (1.5 - currentPhase) * 29.53058867;\n    }\n    \n    const nextFullMoon = new Date(date);\n    nextFullMoon.setDate(nextFullMoon.getDate() + Math.round(daysToFull));\n    return { date: nextFullMoon, days: Math.round(daysToFull) };\n}\n\nfunction getNextNewMoon(date) {\n    const currentPhase = calculateMoonPhase(date);\n    let daysToNew = 0;\n    \n    if (currentPhase < 0.97) {\n        // Before new moon\n        daysToNew = (1 - currentPhase) * 29.53058867;\n    } else {\n        // Very close to new moon, next one is in next cycle\n        daysToNew = (1 - currentPhase + 1) * 29.53058867;\n    }\n    \n    const nextNewMoon = new Date(date);\n    nextNewMoon.setDate(nextNewMoon.getDate() + Math.round(daysToNew));\n    return { date: nextNewMoon, days: Math.round(daysToNew) };\n}\n\nfunction openMoonDetailsModal(date) {\n    const modal = document.getElementById('moonDetailsModal');\n    modal.classList.add('active');\n    \n    // Use current location or default to a location if not available\n    const lat = currentLat || 40.7128; // Default to NYC if location not available\n    const lon = currentLon || -74.0060;\n    \n    const moonPhaseValue = calculateMoonPhase(date);\n    const moonPhase = getMoonPhase(moonPhaseValue);\n    const illumination = getMoonIllumination(date);\n    const distance = calculateMoonDistance(date, lat, lon);\n    \n    // Get moonrise/moonset using SunCalc\n    const riseSet = calculateMoonRiseSet(date, lat, lon);\n    \n    // Get next full/new moon\n    const nextFull = getNextFullMoon(date);\n    const nextNew = getNextNewMoon(date);\n    \n    // Populate modal\n    document.getElementById('moonDetailsEmoji').textContent = moonPhase.emoji;\n    document.getElementById('moonDetailsName').textContent = moonPhase.name;\n    document.getElementById('moonDetailsDate').textContent = date.toLocaleDateString('en-US', { \n        weekday: 'long', \n        year: 'numeric', \n        month: 'long', \n        day: 'numeric' \n    });\n    document.getElementById('moonIllumination').textContent = `${illumination}%`;\n    \n    // Handle moonrise/moonset display (may be null if moon doesn't rise/set that day)\n    if (riseSet.alwaysUp) {\n        document.getElementById('moonRise').textContent = 'Always up';\n    } else if (riseSet.alwaysDown) {\n        document.getElementById('moonRise').textContent = 'Always down';\n    } else if (riseSet.rise) {\n        document.getElementById('moonRise').textContent = formatTime12Hour(riseSet.rise);\n    } else {\n        document.getElementById('moonRise').textContent = 'N/A';\n    }\n    \n    if (riseSet.alwaysUp) {\n        document.getElementById('moonSet').textContent = 'Always up';\n    } else if (riseSet.alwaysDown) {\n        document.getElementById('moonSet').textContent = 'Always down';\n    } else if (riseSet.set) {\n        document.getElementById('moonSet').textContent = formatTime12Hour(riseSet.set);\n    } else {\n        document.getElementById('moonSet').textContent = 'N/A';\n    }\n    \n    document.getElementById('moonDistance').textContent = `${distance.toLocaleString()} mi`;\n    document.getElementById('nextFullMoon').textContent = `${nextFull.days} days (${nextFull.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;\n    document.getElementById('nextNewMoon').textContent = `${nextNew.days} days (${nextNew.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;\n}\n\nfunction formatTime12Hour(date) {\n    let hours = date.getHours();\n    const minutes = date.getMinutes();\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; // the hour '0' should be '12'\n    const minutesStr = minutes < 10 ? '0' + minutes : minutes;\n    return `${hours}:${minutesStr} ${ampm}`;\n}\n\nfunction parseDateString(dateString) {\n    // Parse date string (format: \"YYYY-MM-DD\") as local date, not UTC\n    // This prevents timezone issues where UTC dates shift to previous day\n    const parts = dateString.split('-');\n    if (parts.length === 3) {\n        const year = parseInt(parts[0], 10);\n        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed\n        const day = parseInt(parts[2], 10);\n        return new Date(year, month, day);\n    }\n    // Fallback to regular Date parsing if format is different\n    return new Date(dateString);\n}\n\nfunction formatLastUpdated(date) {\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    \n    if (diffMins < 1) {\n        return 'just now';\n    } else if (diffMins === 1) {\n        return '1 minute ago';\n    } else if (diffMins < 60) {\n        return `${diffMins} minutes ago`;\n    } else {\n        const diffHours = Math.floor(diffMins / 60);\n        if (diffHours === 1) {\n            return '1 hour ago';\n        } else {\n            return `${diffHours} hours ago`;\n        }\n    }\n}\n\nfunction displayPressure(data) {\n    const pressureElement = document.getElementById('pressure');\n    const trendElement = document.getElementById('pressureTrend');\n    const statusElement = document.getElementById('pressureStatus');\n    \n    if (!data.current.surface_pressure) {\n        return;\n    }\n    \n    // Convert hPa to inHg (1 hPa = 0.02953 inHg)\n    const pressureInHg = (data.current.surface_pressure * 0.02953).toFixed(2);\n    pressureElement.textContent = `${pressureInHg}\"`;\n    \n    // Calculate pressure trend by comparing to 3 hours ago\n    let trend = '';\n    let trendText = 'Steady';\n    \n    if (data.hourly && data.hourly.surface_pressure) {\n        const now = new Date();\n        const currentHour = now.getHours();\n        \n        // Find current hour index\n        let currentIdx = -1;\n        for (let i = 0; i < data.hourly.time.length; i++) {\n            const hourTime = new Date(data.hourly.time[i]);\n            if (hourTime.getHours() === currentHour && hourTime.getDate() === now.getDate()) {\n                currentIdx = i;\n                break;\n            }\n        }\n        \n        // Compare to 3 hours ago\n        if (currentIdx >= 3) {\n            const currentPressure = data.hourly.surface_pressure[currentIdx];\n            const pastPressure = data.hourly.surface_pressure[currentIdx - 3];\n            const diff = currentPressure - pastPressure;\n            \n            if (diff > 1) {\n                trend = '‚Üë';\n                trendText = 'Rising';\n                trendElement.className = 'text-lg text-green-400';\n            } else if (diff < -1) {\n                trend = '‚Üì';\n                trendText = 'Falling';\n                trendElement.className = 'text-lg text-red-400';\n            } else {\n                trend = '‚Üí';\n                trendText = 'Steady';\n                trendElement.className = 'text-lg text-gray-400';\n            }\n        }\n    }\n    \n    trendElement.textContent = trend;\n    statusElement.textContent = trendText;\n}\n\nfunction displayPrecipitationTiming(data) {\n    const section = document.getElementById('precipTimingSection');\n    const timingText = document.getElementById('precipTiming');\n    const icon = document.getElementById('precipIcon');\n    \n    if (!data.hourly || !data.hourly.precipitation) {\n        section.classList.add('hidden');\n        return;\n    }\n    \n    const now = new Date();\n    const currentHour = now.getHours();\n    \n    // Find current hour index\n    let startIndex = 0;\n    for (let i = 0; i < data.hourly.time.length; i++) {\n        const hourTime = new Date(data.hourly.time[i]);\n        if (hourTime.getHours() >= currentHour && hourTime.getDate() === now.getDate()) {\n            startIndex = i;\n            break;\n        }\n    }\n    \n    // Look ahead 24 hours for precipitation\n    let precipStartTime = null;\n    let precipEndTime = null;\n    let isSnow = false;\n    let precipAmount = 0;\n    \n    for (let i = startIndex; i < Math.min(startIndex + 24, data.hourly.time.length); i++) {\n        const precip = data.hourly.precipitation[i] || 0;\n        const snow = data.hourly.snowfall ? (data.hourly.snowfall[i] || 0) : 0;\n        \n        if (precip > 0 || snow > 0) {\n            if (!precipStartTime) {\n                precipStartTime = new Date(data.hourly.time[i]);\n                isSnow = snow > 0;\n            }\n            precipAmount += precip + snow;\n            precipEndTime = new Date(data.hourly.time[i]);\n        } else if (precipStartTime && !precipEndTime) {\n            // Gap in precipitation - could end the period here\n            break;\n        }\n    }\n    \n    if (!precipStartTime) {\n        // No precipitation expected\n        icon.textContent = '‚òÄÔ∏è';\n        timingText.textContent = 'No precipitation expected in the next 24 hours';\n        section.classList.remove('hidden');\n    } else {\n        const startHour = precipStartTime.getHours();\n        const nowHour = now.getHours();\n        const startDate = precipStartTime.getDate();\n        const nowDate = now.getDate();\n        \n        icon.textContent = isSnow ? '‚ùÑÔ∏è' : 'üåßÔ∏è';\n        \n        // Check if precipitation is happening now (within the current hour)\n        if (startHour === nowHour && startDate === nowDate) {\n            const precipType = isSnow ? 'Snow' : 'Rain';\n            timingText.textContent = `${precipType} is currently falling`;\n        } else {\n            const precipType = isSnow ? 'Snow' : 'Rain';\n            const timeStr = formatTime12Hour(precipStartTime);\n            \n            // Check if it's today or tomorrow\n            if (startDate === nowDate) {\n                timingText.textContent = `${precipType} expected around ${timeStr}`;\n            } else if (startDate === nowDate + 1) {\n                timingText.textContent = `${precipType} expected tomorrow around ${timeStr}`;\n            } else {\n                const dayName = precipStartTime.toLocaleDateString('en-US', { weekday: 'long' });\n                timingText.textContent = `${precipType} expected ${dayName} around ${timeStr}`;\n            }\n        }\n        section.classList.remove('hidden');\n    }\n}\n\nfunction showLoading() {\n    document.getElementById('loading').classList.remove('hidden');\n}\n\nfunction hideLoading() {\n    document.getElementById('loading').classList.add('hidden');\n}\n\nfunction showContent() {\n    document.getElementById('weatherContent').classList.remove('hidden');\n}\n\nfunction hideContent() {\n    document.getElementById('weatherContent').classList.add('hidden');\n}\n\nfunction showError(message) {\n    document.getElementById('errorMessage').classList.remove('hidden');\n    document.getElementById('errorText').textContent = message;\n}\n\nfunction hideError() {\n    document.getElementById('errorMessage').classList.add('hidden');\n}\n\n// Weather alerts functionality\nasync function fetchWeatherAlerts(lat, lon) {\n    // Only fetch alerts for US locations (rough check: lat 24-50, lon -125 to -66)\n    if (lat < 24 || lat > 50 || lon < -125 || lon > -66) {\n        return; // Not in US, skip alerts\n    }\n    \n    try {\n        // First, get the forecast zone for this point\n        const pointResponse = await fetch(`/api/nws-points/${lat.toFixed(4)},${lon.toFixed(4)}`);\n        \n        if (!pointResponse.ok) {\n            console.log('NWS points API not available:', pointResponse.status);\n            return; // Silently fail if not available\n        }\n        \n        const pointData = await pointResponse.json();\n        \n        // Check if the response has an error\n        if (pointData.error) {\n            console.log('NWS points API error:', pointData.reason);\n            return;\n        }\n        \n        const forecastZoneUrl = pointData.properties?.forecastZone;\n        \n        if (!forecastZoneUrl) {\n            console.log('No forecast zone URL found in NWS response');\n            return;\n        }\n        \n        // Extract zone ID from URL (e.g., \"https://api.weather.gov/zones/forecast/AZZ001\" -> \"AZZ001\")\n        const zoneId = forecastZoneUrl.split('/').pop();\n        \n        if (!zoneId) {\n            console.log('Could not extract zone ID from URL:', forecastZoneUrl);\n            return;\n        }\n        \n        // Fetch alerts for this zone\n        const alertsResponse = await fetch(`/api/alerts/active/zone/${zoneId}`);\n        \n        if (!alertsResponse.ok) {\n            console.log('NWS alerts API not available:', alertsResponse.status);\n            return;\n        }\n        \n        const alertsData = await alertsResponse.json();\n        \n        // Check if the response has an error\n        if (alertsData.error) {\n            console.log('NWS alerts API error:', alertsData.reason);\n            return;\n        }\n        \n        if (alertsData.features && alertsData.features.length > 0) {\n            // Filter to only show actual (active) alerts\n            const activeAlerts = alertsData.features.filter(alert => \n                alert.properties.status === 'Actual'\n            );\n            \n            if (activeAlerts.length > 0) {\n                displayAlerts(activeAlerts);\n            }\n        }\n    } catch (error) {\n        // Log error for debugging but don't break the app\n        console.error('Weather alerts error:', error.message);\n    }\n}\n\nfunction displayAlerts(alerts) {\n    const alertsContainer = document.getElementById('weatherAlerts');\n    alertsContainer.innerHTML = '';\n    alertsContainer.classList.remove('hidden');\n    \n    alerts.forEach((alert, index) => {\n        const props = alert.properties;\n        const severity = props.severity?.toLowerCase() || 'unknown';\n        const urgency = props.urgency?.toLowerCase() || 'unknown';\n        \n        // Determine alert color based on severity\n        let alertColor = 'bg-yellow-500/20 border-yellow-300/30';\n        if (severity === 'extreme' || severity === 'severe') {\n            alertColor = 'bg-red-500/20 border-red-300/30';\n        } else if (severity === 'moderate') {\n            alertColor = 'bg-orange-500/20 border-orange-300/30';\n        }\n        \n        const alertItem = document.createElement('div');\n        alertItem.className = `${alertColor} backdrop-blur-sm rounded-lg border shadow-lg mb-3`;\n        \n        const eventType = props.event || 'Weather Alert';\n        const headline = props.headline || '';\n        const description = props.description || '';\n        const effective = props.effective ? new Date(props.effective).toLocaleString('en-US') : '';\n        const expires = props.expires ? new Date(props.expires).toLocaleString('en-US') : '';\n        \n        // Create unique IDs for this alert\n        const alertId = `alert-${index}`;\n        const headerId = `alert-header-${index}`;\n        const contentId = `alert-content-${index}`;\n        const expandIconId = `alert-icon-${index}`;\n        \n        alertItem.innerHTML = `\n            <div class=\"cursor-pointer\" id=\"${headerId}\">\n                <div class=\"flex items-center justify-between p-4\">\n                    <div class=\"flex items-center gap-3 flex-1 min-w-0\">\n                        <i class=\"fas fa-exclamation-triangle text-2xl text-white flex-shrink-0\"></i>\n                        <div class=\"flex-1 min-w-0\">\n                            <div class=\"flex items-center gap-2 mb-1 flex-wrap\">\n                                <h3 class=\"text-xl font-bold text-white\">${eventType}</h3>\n                                ${props.severity ? `<span class=\"px-2 py-1 bg-white/20 rounded text-xs text-white font-semibold uppercase whitespace-nowrap\">${props.severity}</span>` : ''}\n                            </div>\n                            ${headline ? `<p class=\"text-white font-semibold text-sm\">${headline}</p>` : ''}\n                        </div>\n                    </div>\n                    <i id=\"${expandIconId}\" class=\"fas fa-chevron-down text-white transition-transform duration-200 flex-shrink-0 ml-2\"></i>\n                </div>\n            </div>\n            <div id=\"${contentId}\" class=\"hidden px-4 pb-4\">\n                <div class=\"border-t border-white/20 pt-4\">\n                    ${description ? `<p class=\"text-white/90 text-sm mb-3 whitespace-pre-line\">${description}</p>` : ''}\n                    ${(effective || expires) ? `\n                    <div class=\"flex flex-col gap-2 text-white/70 text-xs mt-4 pt-4 border-t border-white/10\">\n                        ${effective ? `<div><i class=\"fas fa-clock mr-1\"></i>Effective: ${effective}</div>` : ''}\n                        ${expires ? `<div><i class=\"fas fa-calendar-times mr-1\"></i>Expires: ${expires}</div>` : ''}\n                    </div>\n                    ` : ''}\n                </div>\n            </div>\n        `;\n        \n        // Add click handler for expand/collapse\n        const header = alertItem.querySelector(`#${headerId}`);\n        const content = alertItem.querySelector(`#${contentId}`);\n        const expandIcon = alertItem.querySelector(`#${expandIconId}`);\n        \n        header.addEventListener('click', () => {\n            const isExpanded = !content.classList.contains('hidden');\n            if (isExpanded) {\n                content.classList.add('hidden');\n                expandIcon.classList.remove('fa-chevron-up');\n                expandIcon.classList.add('fa-chevron-down');\n                expandIcon.style.transform = 'rotate(0deg)';\n            } else {\n                content.classList.remove('hidden');\n                expandIcon.classList.remove('fa-chevron-down');\n                expandIcon.classList.add('fa-chevron-up');\n                expandIcon.style.transform = 'rotate(180deg)';\n            }\n        });\n        \n        alertsContainer.appendChild(alertItem);\n    });\n}\n\n// Air Quality functionality\n// Store pollen data globally for use in allergy risk calculation\nlet currentPollenData = null;\n\nasync function fetchAirQuality(lat, lon) {\n    try {\n        // Fetch air quality data from Open-Meteo Air Quality API including pollen\n        const aqiResponse = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi,pm10,pm2_5,ozone,nitrogen_dioxide,sulphur_dioxide,carbon_monoxide,alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&hourly=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen&forecast_days=5&timezone=auto`);\n        \n        if (!aqiResponse.ok) {\n            // Hide air quality and pollen sections if API is unavailable\n            document.getElementById('airQualitySection').classList.add('hidden');\n            document.getElementById('pollenSection').classList.add('hidden');\n            return;\n        }\n        \n        const aqiData = await aqiResponse.json();\n        \n        if (aqiData.error || !aqiData.current) {\n            document.getElementById('airQualitySection').classList.add('hidden');\n            document.getElementById('pollenSection').classList.add('hidden');\n            return;\n        }\n        \n        // Store pollen data for allergy risk calculation\n        currentPollenData = aqiData;\n        \n        displayAirQuality(aqiData.current);\n        displayPollenData(aqiData);\n        \n        // Recalculate allergy risk with real pollen data\n        updateAllergyRiskWithPollenData();\n    } catch (error) {\n        console.error('Error fetching air quality:', error);\n        document.getElementById('airQualitySection').classList.add('hidden');\n        document.getElementById('pollenSection').classList.add('hidden');\n    }\n}\n\nfunction displayAirQuality(data) {\n    const aqiSection = document.getElementById('airQualitySection');\n    const aqiValue = document.getElementById('aqiValue');\n    const aqiStatus = document.getElementById('aqiStatus');\n    \n    // Show the section\n    aqiSection.classList.remove('hidden');\n    \n    // Get US AQI (0-500 scale)\n    const usAqi = data.us_aqi || 0;\n    \n    // Determine AQI category and color\n    let category, color;\n    if (usAqi <= 50) {\n        category = 'Good';\n        color = 'text-green-400';\n    } else if (usAqi <= 100) {\n        category = 'Moderate';\n        color = 'text-yellow-400';\n    } else if (usAqi <= 150) {\n        category = 'Unhealthy for Sensitive Groups';\n        color = 'text-orange-400';\n    } else if (usAqi <= 200) {\n        category = 'Unhealthy';\n        color = 'text-red-400';\n    } else if (usAqi <= 300) {\n        category = 'Very Unhealthy';\n        color = 'text-purple-400';\n    } else {\n        category = 'Hazardous';\n        color = 'text-red-600';\n    }\n    \n    // Update display\n    aqiValue.textContent = usAqi;\n    aqiValue.className = `text-2xl font-bold ${color}`;\n    aqiStatus.textContent = category;\n    aqiStatus.className = `text-white/90 text-xs mt-1 ${color}`;\n}\n\n// ============================================\n// Symptom Risk Calculation Functions\n// ============================================\n\n// Store symptom data globally for modal display\nlet currentSymptomData = null;\n\n// Convert hPa to inHg (inches of mercury)\nfunction hpaToInhg(hpa) {\n    return hpa * 0.02953;\n}\n\n// Calculate daily averages from hourly data for a specific date\nfunction calculateDailyAverages(hourlyData, targetDate) {\n    const targetDateStr = targetDate.toISOString().split('T')[0];\n    let tempSum = 0, humiditySum = 0, pressureSum = 0, precipSum = 0;\n    let windMax = 0, count = 0;\n    \n    for (let i = 0; i < hourlyData.time.length; i++) {\n        const hourDate = hourlyData.time[i].split('T')[0];\n        if (hourDate === targetDateStr) {\n            tempSum += hourlyData.temperature_2m[i] || 0;\n            humiditySum += hourlyData.relative_humidity_2m[i] || 0;\n            pressureSum += hourlyData.surface_pressure ? (hourlyData.surface_pressure[i] || 0) : 0;\n            precipSum += hourlyData.precipitation ? (hourlyData.precipitation[i] || 0) : 0;\n            windMax = Math.max(windMax, hourlyData.wind_speed_10m[i] || 0);\n            count++;\n        }\n    }\n    \n    if (count === 0) return null;\n    \n    return {\n        avgTemp: tempSum / count,\n        avgHumidity: humiditySum / count,\n        avgPressureInhg: hpaToInhg(pressureSum / count),\n        precipSum: precipSum,\n        windMax: windMax\n    };\n}\n\n// Calculate sinus risk score (0-10)\nfunction calculateSinusRisk(pressureChange, humidity, precipitation, tempSwing) {\n    let risk = 0;\n    \n    // Pressure drop scoring\n    if (pressureChange < -0.30) {\n        risk += 5;\n    } else if (pressureChange >= -0.30 && pressureChange < -0.18) {\n        risk += 3;\n    } else if (pressureChange >= -0.18 && pressureChange < -0.10) {\n        risk += 2;\n    }\n    \n    // High humidity\n    if (humidity > 70) {\n        risk += 1;\n    }\n    \n    // Precipitation\n    if (precipitation > 0.1) {\n        risk += 1;\n    }\n    \n    // Temperature swing\n    if (tempSwing > 20) {\n        risk += 1;\n    }\n    \n    // Clip to 0-10\n    return Math.max(0, Math.min(10, risk));\n}\n\n// Calculate allergy risk score (0-10) - requires pollen data\nfunction calculateAllergyRisk(windMax, precipitation, pollenData = null) {\n    // Requires pollen data - returns 0 if unavailable\n    if (!pollenData || !pollenData.current) {\n        return 0;\n    }\n    \n    let risk = 0;\n    const current = pollenData.current;\n    \n    // Get max pollen levels\n    const treePollen = Math.max(\n        current.alder_pollen || 0,\n        current.birch_pollen || 0,\n        current.olive_pollen || 0\n    );\n    const grassPollen = current.grass_pollen || 0;\n    const weedPollen = Math.max(\n        current.mugwort_pollen || 0,\n        current.ragweed_pollen || 0\n    );\n    const maxPollen = Math.max(treePollen, grassPollen, weedPollen);\n    \n    // Score based on actual pollen levels (grains/m¬≥)\n    if (maxPollen > 200) {\n        risk += 5;  // Very High pollen\n    } else if (maxPollen > 80) {\n        risk += 4;  // High pollen\n    } else if (maxPollen > 20) {\n        risk += 2;  // Moderate pollen\n    } else if (maxPollen > 0) {\n        risk += 1;  // Low pollen\n    }\n    \n    // Wind disperses pollen\n    if (windMax > 10) {\n        risk += 2;\n    }\n    \n    // Wet day reduces risk (rain washes pollen away)\n    if (precipitation > 0.1) {\n        risk -= 2;\n    }\n    \n    // Clip to 0-10\n    return Math.max(0, Math.min(10, risk));\n}\n\n// Get risk level label and color class\nfunction getRiskLabel(risk) {\n    if (risk <= 2) {\n        return { label: 'Low', colorClass: 'text-green-400' };\n    } else if (risk <= 4) {\n        return { label: 'Moderate', colorClass: 'text-yellow-400' };\n    } else if (risk <= 7) {\n        return { label: 'High', colorClass: 'text-orange-400' };\n    } else {\n        return { label: 'Very High', colorClass: 'text-red-400' };\n    }\n}\n\n// Update allergy risk calculation when pollen data becomes available\nfunction updateAllergyRiskWithPollenData() {\n    if (!currentSymptomData || !currentPollenData) return;\n    \n    // Recalculate allergy risk with real pollen data\n    const allergyRisk = calculateAllergyRisk(\n        currentSymptomData.windMax,\n        currentSymptomData.precipitation,\n        currentPollenData\n    );\n    \n    // Update display\n    const allergyLabel = getRiskLabel(allergyRisk);\n    document.getElementById('allergyRiskValue').textContent = `${allergyRisk}/10`;\n    document.getElementById('allergyRiskLabel').textContent = allergyLabel.label;\n    document.getElementById('allergyRiskLabel').className = `text-xs font-semibold ${allergyLabel.colorClass}`;\n}\n\n// ============================================\n// Pollen Display Functions\n// ============================================\n\n// Get pollen level category based on grains/m¬≥\nfunction getPollenLevel(value) {\n    if (value === null || value === undefined || value === 0) {\n        return { label: 'None', colorClass: 'text-gray-400', level: 0 };\n    } else if (value <= 20) {\n        return { label: 'Low', colorClass: 'text-green-400', level: 1 };\n    } else if (value <= 80) {\n        return { label: 'Moderate', colorClass: 'text-yellow-400', level: 2 };\n    } else if (value <= 200) {\n        return { label: 'High', colorClass: 'text-orange-400', level: 3 };\n    } else {\n        return { label: 'Very High', colorClass: 'text-red-400', level: 4 };\n    }\n}\n\n// Display pollen data\nfunction displayPollenData(aqiData) {\n    const pollenSection = document.getElementById('pollenSection');\n    \n    if (!aqiData.current) {\n        pollenSection.classList.add('hidden');\n        return;\n    }\n    \n    const current = aqiData.current;\n    \n    // Calculate combined values for each category\n    const treePollen = Math.max(\n        current.alder_pollen || 0,\n        current.birch_pollen || 0,\n        current.olive_pollen || 0\n    );\n    const grassPollen = current.grass_pollen || 0;\n    const weedPollen = Math.max(\n        current.mugwort_pollen || 0,\n        current.ragweed_pollen || 0\n    );\n    \n    // Check if any pollen data is available\n    if (treePollen === 0 && grassPollen === 0 && weedPollen === 0) {\n        const hasAnyData = [\n            current.alder_pollen, current.birch_pollen, current.olive_pollen,\n            current.grass_pollen, current.mugwort_pollen, current.ragweed_pollen\n        ].some(v => v !== null && v !== undefined);\n        \n        if (!hasAnyData) {\n            pollenSection.classList.add('hidden');\n            return;\n        }\n    }\n    \n    pollenSection.classList.remove('hidden');\n    \n    // Display current tree pollen\n    const treeLevel = getPollenLevel(treePollen);\n    document.getElementById('pollenTreeValue').textContent = Math.round(treePollen);\n    document.getElementById('pollenTreeLabel').textContent = treeLevel.label;\n    document.getElementById('pollenTreeLabel').className = `text-xs mt-1 font-semibold ${treeLevel.colorClass}`;\n    \n    // Display current grass pollen\n    const grassLevel = getPollenLevel(grassPollen);\n    document.getElementById('pollenGrassValue').textContent = Math.round(grassPollen);\n    document.getElementById('pollenGrassLabel').textContent = grassLevel.label;\n    document.getElementById('pollenGrassLabel').className = `text-xs mt-1 font-semibold ${grassLevel.colorClass}`;\n    \n    // Display current weed pollen\n    const weedLevel = getPollenLevel(weedPollen);\n    document.getElementById('pollenWeedValue').textContent = Math.round(weedPollen);\n    document.getElementById('pollenWeedLabel').textContent = weedLevel.label;\n    document.getElementById('pollenWeedLabel').className = `text-xs mt-1 font-semibold ${weedLevel.colorClass}`;\n    \n    // Display 5-day forecast\n    if (aqiData.hourly && aqiData.hourly.time) {\n        displayPollenForecast(aqiData.hourly);\n    }\n}\n\n// Display pollen forecast\nfunction displayPollenForecast(hourlyData) {\n    const forecastContainer = document.getElementById('pollenForecast');\n    forecastContainer.innerHTML = '';\n    \n    // Group hourly data by day and get daily max\n    const dailyData = {};\n    \n    for (let i = 0; i < hourlyData.time.length; i++) {\n        const date = hourlyData.time[i].split('T')[0];\n        \n        if (!dailyData[date]) {\n            dailyData[date] = { tree: 0, grass: 0, weed: 0 };\n        }\n        \n        dailyData[date].tree = Math.max(\n            dailyData[date].tree,\n            hourlyData.alder_pollen?.[i] || 0,\n            hourlyData.birch_pollen?.[i] || 0,\n            hourlyData.olive_pollen?.[i] || 0\n        );\n        dailyData[date].grass = Math.max(\n            dailyData[date].grass,\n            hourlyData.grass_pollen?.[i] || 0\n        );\n        dailyData[date].weed = Math.max(\n            dailyData[date].weed,\n            hourlyData.mugwort_pollen?.[i] || 0,\n            hourlyData.ragweed_pollen?.[i] || 0\n        );\n    }\n    \n    const dates = Object.keys(dailyData).slice(0, 5);\n    const isMobile = window.innerWidth <= 768;\n    \n    dates.forEach((dateStr, index) => {\n        const day = parseDateString(dateStr);\n        const data = dailyData[dateStr];\n        \n        const treeLevel = getPollenLevel(data.tree);\n        const grassLevel = getPollenLevel(data.grass);\n        const weedLevel = getPollenLevel(data.weed);\n        \n        const overallLevel = Math.max(treeLevel.level, grassLevel.level, weedLevel.level);\n        \n        const forecastItem = document.createElement('div');\n        forecastItem.className = 'stat-card rounded-xl p-4 flex items-center justify-between';\n        \n        const dayName = index === 0 ? 'Today' : \n                       index === 1 ? 'Tomorrow' : \n                       day.toLocaleDateString('en-US', { weekday: isMobile ? 'short' : 'long' });\n        const dateDisplay = day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n        \n        forecastItem.innerHTML = `\n            <div class=\"flex items-center gap-3\">\n                <div class=\"text-2xl\">${getPollenEmoji(overallLevel)}</div>\n                <div>\n                    <div class=\"text-white font-semibold\">${dayName}</div>\n                    <div class=\"text-gray-400 text-xs\">${dateDisplay}</div>\n                </div>\n            </div>\n            <div class=\"flex items-center gap-4 text-sm\">\n                <div class=\"text-center\">\n                    <div class=\"text-gray-500 text-xs mb-1\">Tree</div>\n                    <div class=\"${treeLevel.colorClass} font-semibold\">${treeLevel.label}</div>\n                </div>\n                <div class=\"text-center\">\n                    <div class=\"text-gray-500 text-xs mb-1\">Grass</div>\n                    <div class=\"${grassLevel.colorClass} font-semibold\">${grassLevel.label}</div>\n                </div>\n                <div class=\"text-center\">\n                    <div class=\"text-gray-500 text-xs mb-1\">Weed</div>\n                    <div class=\"${weedLevel.colorClass} font-semibold\">${weedLevel.label}</div>\n                </div>\n            </div>\n        `;\n        \n        forecastContainer.appendChild(forecastItem);\n    });\n}\n\n// Get emoji based on pollen level\nfunction getPollenEmoji(level) {\n    switch(level) {\n        case 0: return 'üòä';\n        case 1: return 'üôÇ';\n        case 2: return 'üòê';\n        case 3: return 'üò∑';\n        case 4: return 'ü§ß';\n        default: return 'üåø';\n    }\n}\n\n// ============================================\n// Symptom Risk Modal\n// ============================================\n\nfunction openSymptomRiskModal(type) {\n    const modal = document.getElementById('symptomRiskModal');\n    const titleText = document.getElementById('symptomRiskModalTitleText');\n    const titleIcon = document.getElementById('symptomRiskModalIcon');\n    const sinusSection = document.getElementById('sinusFormulaSection');\n    const allergySection = document.getElementById('allergyFormulaSection');\n    const currentValuesContainer = document.getElementById('symptomCurrentValues');\n    \n    if (type === 'sinus') {\n        titleText.textContent = 'Sinus Risk Methodology';\n        titleIcon.innerHTML = '<i class=\"fas fa-head-side-cough text-blue-300\"></i>';\n        sinusSection.classList.remove('hidden');\n        allergySection.classList.add('hidden');\n    } else {\n        titleText.textContent = 'Allergy Risk Methodology';\n        titleIcon.innerHTML = '<i class=\"fas fa-seedling text-green-300\"></i>';\n        sinusSection.classList.add('hidden');\n        allergySection.classList.remove('hidden');\n    }\n    \n    // Populate current values if available\n    if (currentSymptomData) {\n        const data = currentSymptomData;\n        \n        if (type === 'sinus') {\n            currentValuesContainer.innerHTML = `\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Pressure Change</div>\n                    <div class=\"text-white font-bold\">${data.pressureChange >= 0 ? '+' : ''}${data.pressureChange.toFixed(2)} inHg</div>\n                </div>\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Humidity</div>\n                    <div class=\"text-white font-bold\">${data.humidity.toFixed(0)}%</div>\n                </div>\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Precipitation</div>\n                    <div class=\"text-white font-bold\">${data.precipitation.toFixed(2)} in</div>\n                </div>\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Temp Swing</div>\n                    <div class=\"text-white font-bold\">${data.tempSwing.toFixed(1)}¬∞F</div>\n                </div>\n            `;\n        } else {\n            // Check if we have pollen data\n            let pollenHtml = '';\n            if (currentPollenData && currentPollenData.current) {\n                const pollen = currentPollenData.current;\n                const treePollen = Math.max(pollen.alder_pollen || 0, pollen.birch_pollen || 0, pollen.olive_pollen || 0);\n                const grassPollen = pollen.grass_pollen || 0;\n                const weedPollen = Math.max(pollen.mugwort_pollen || 0, pollen.ragweed_pollen || 0);\n                const treeLevel = getPollenLevel(treePollen);\n                const grassLevel = getPollenLevel(grassPollen);\n                const weedLevel = getPollenLevel(weedPollen);\n                \n                pollenHtml = `\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-tree text-green-400 mr-1\"></i>Tree Pollen</div>\n                        <div class=\"text-white font-bold\">${Math.round(treePollen)}</div>\n                        <div class=\"text-xs ${treeLevel.colorClass}\">${treeLevel.label}</div>\n                    </div>\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-leaf text-lime-400 mr-1\"></i>Grass Pollen</div>\n                        <div class=\"text-white font-bold\">${Math.round(grassPollen)}</div>\n                        <div class=\"text-xs ${grassLevel.colorClass}\">${grassLevel.label}</div>\n                    </div>\n                    <div class=\"stat-card rounded-lg p-3 text-center\">\n                        <div class=\"text-gray-400 text-xs mb-1\"><i class=\"fas fa-seedling text-amber-400 mr-1\"></i>Weed Pollen</div>\n                        <div class=\"text-white font-bold\">${Math.round(weedPollen)}</div>\n                        <div class=\"text-xs ${weedLevel.colorClass}\">${weedLevel.label}</div>\n                    </div>\n                `;\n            }\n            \n            currentValuesContainer.innerHTML = `\n                ${pollenHtml}\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Max Wind</div>\n                    <div class=\"text-white font-bold\">${data.windMax.toFixed(1)} mph</div>\n                </div>\n                <div class=\"stat-card rounded-lg p-3 text-center\">\n                    <div class=\"text-gray-400 text-xs mb-1\">Precipitation</div>\n                    <div class=\"text-white font-bold\">${data.precipitation.toFixed(2)} in</div>\n                </div>\n            `;\n        }\n    }\n    \n    modal.classList.add('active');\n    \n    // Re-render MathJax for the newly visible content\n    if (window.MathJax) {\n        MathJax.typesetPromise([modal]).catch(function (err) {\n            console.log('MathJax typeset error:', err);\n        });\n    }\n}\n\n// Chart selector functionality\nfunction initializeChartSelector(selectId) {\n    const select = document.getElementById(selectId);\n    if (!select) return;\n\n    const modal = select.closest('.modal');\n    const chartContainers = modal.querySelectorAll('.chart-container');\n\n    function updateChartVisibility() {\n        const selectedValue = select.value;\n\n        chartContainers.forEach(container => {\n            if (selectedValue === 'all') {\n                container.style.display = 'block';\n            } else {\n                const chartType = container.getAttribute('data-chart-type');\n                container.style.display = chartType === selectedValue ? 'block' : 'none';\n            }\n        });\n    }\n\n    // Set initial state to show temperature chart\n    select.value = 'temp';\n    updateChartVisibility();\n\n    // Add change event listener\n    select.addEventListener('change', updateChartVisibility);\n}\n\n// Modal functionality\nfunction openHourlyModal(data) {\n    const modal = document.getElementById('hourlyModal');\n    modal.classList.add('active');\n    \n    // Destroy existing charts if they exist\n    if (hourlyChart) {\n        Object.values(hourlyChart).forEach(chart => {\n            if (chart) chart.destroy();\n        });\n    }\n    \n    // Prepare data\n    const now = new Date();\n    const currentHour = now.getHours();\n    let startIndex = 0;\n    for (let i = 0; i < data.hourly.time.length; i++) {\n        const hourTime = new Date(data.hourly.time[i]);\n        if (hourTime.getHours() >= currentHour) {\n            startIndex = i;\n            break;\n        }\n    }\n    \n    const hours = [];\n    const temps = [];\n    const precip = [];\n    const snow = [];\n    const wind = [];\n    const humidity = [];\n    const pressure = [];\n    const labels = [];\n    \n    for (let i = 0; i < 24 && (startIndex + i) < data.hourly.time.length; i++) {\n        const idx = startIndex + i;\n        const hour = new Date(data.hourly.time[idx]);\n        labels.push(formatTime12Hour(hour));\n        hours.push(hour);\n        temps.push(Math.round(data.hourly.temperature_2m[idx]));\n        precip.push(data.hourly.precipitation ? data.hourly.precipitation[idx] : 0);\n        snow.push(data.hourly.snowfall ? data.hourly.snowfall[idx] : 0);\n        wind.push(data.hourly.wind_speed_10m[idx]);\n        humidity.push(data.hourly.relative_humidity_2m[idx]);\n        // Convert hPa to inHg (1 hPa = 0.02953 inHg)\n        pressure.push(data.hourly.surface_pressure ? (data.hourly.surface_pressure[idx] * 0.02953).toFixed(2) : null);\n    }\n    \n    // Create charts\n    const chartConfig = {\n        type: 'line',\n        options: {\n            responsive: true,\n            maintainAspectRatio: false,\n            plugins: {\n                legend: {\n                    labels: { color: '#fff' }\n                }\n            },\n            scales: {\n                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },\n                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }\n            }\n        }\n    };\n    \n    // Check if there's any snow in the hourly forecast\n    const hasSnowHourly = snow.some(val => val > 0);\n    \n    hourlyChart = {\n        temp: new Chart(document.getElementById('hourlyTempChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Temperature (${data.hourly_units.temperature_2m})`,\n                    data: temps,\n                    borderColor: 'rgb(255, 99, 132)',\n                    backgroundColor: 'rgba(255, 99, 132, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        precip: new Chart(document.getElementById('hourlyPrecipChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Precipitation (${data.hourly_units.precipitation || 'in'})`,\n                    data: precip,\n                    borderColor: 'rgb(54, 162, 235)',\n                    backgroundColor: 'rgba(54, 162, 235, 0.2)',\n                    tension: 0.4,\n                    fill: true\n                }]\n            }\n        }),\n        wind: new Chart(document.getElementById('hourlyWindChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Wind Speed (${formatUnit(data.hourly_units.wind_speed_10m)})`,\n                    data: wind,\n                    borderColor: 'rgb(255, 206, 86)',\n                    backgroundColor: 'rgba(255, 206, 86, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        humidity: new Chart(document.getElementById('hourlyHumidityChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Humidity (${data.hourly_units.relative_humidity_2m})`,\n                    data: humidity,\n                    borderColor: 'rgb(75, 192, 192)',\n                    backgroundColor: 'rgba(75, 192, 192, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        pressure: new Chart(document.getElementById('hourlyPressureChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: 'Pressure (inHg)',\n                    data: pressure,\n                    borderColor: 'rgb(34, 197, 94)',\n                    backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        snow: new Chart(document.getElementById('hourlySnowChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Snowfall (${data.hourly_units.snowfall || 'in'})`,\n                    data: snow,\n                    borderColor: 'rgb(176, 196, 222)',\n                    backgroundColor: 'rgba(176, 196, 222, 0.2)',\n                    tension: 0.4,\n                    fill: true\n                }]\n            }\n        })\n    };\n    \n    // Hide/show precipitation and snow charts based on data\n    const hourlyPrecipChartContainer = document.getElementById('hourlyPrecipChart').parentElement;\n    const hourlySnowChartContainer = document.getElementById('hourlySnowChart').parentElement;\n    \n    if (hasSnowHourly) {\n        hourlyPrecipChartContainer.style.display = 'none';\n        hourlySnowChartContainer.style.display = 'block';\n    } else {\n        hourlyPrecipChartContainer.style.display = 'block';\n        hourlySnowChartContainer.style.display = 'none';\n    }\n    \n    // Populate detailed hourly items\n    const detailsContainer = document.getElementById('hourlyDetails');\n    detailsContainer.innerHTML = '';\n    for (let i = 0; i < hours.length; i++) {\n        const idx = startIndex + i;\n        const hour = hours[i];\n        const detailItem = document.createElement('div');\n        detailItem.className = 'bg-white/10 rounded-lg p-4 backdrop-blur-sm';\n        detailItem.innerHTML = `\n                <div class=\"flex items-center justify-between mb-2\">\n                <div class=\"text-white font-semibold\">${hour.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} ${formatTime12Hour(hour)}</div>\n                <div class=\"text-2xl\">${getWeatherIcon(data.hourly.weather_code[idx])}</div>\n            </div>\n            <div class=\"grid grid-cols-2 gap-2 text-sm\">\n                <div><span class=\"text-white/70\">Temp:</span> <span class=\"text-white font-bold\">${Math.round(temps[i])}${data.hourly_units.temperature_2m}</span></div>\n                <div><span class=\"text-white/70\">Condition:</span> <span class=\"text-white\">${getWeatherDescription(data.hourly.weather_code[idx])}</span></div>\n                <div><span class=\"text-white/70\">Wind:</span> <span class=\"text-white\">${wind[i]} ${formatUnit(data.hourly_units.wind_speed_10m)}</span></div>\n                <div><span class=\"text-white/70\">Humidity:</span> <span class=\"text-white\">${humidity[i]}${data.hourly_units.relative_humidity_2m}</span></div>\n                ${pressure[i] ? `<div><span class=\"text-white/70\">Pressure:</span> <span class=\"text-white\">${pressure[i]}\" inHg</span></div>` : ''}\n                ${data.hourly.snowfall && snow[i] > 0 ? '' : (data.hourly.precipitation ? `<div><span class=\"text-white/70\">Precip:</span> <span class=\"text-white\">${precip[i]} ${data.hourly_units.precipitation || 'in'}</span>${data.hourly.precipitation_probability && data.hourly.precipitation_probability[idx] !== null && data.hourly.precipitation_probability[idx] !== undefined ? ` <span class=\"text-white/60\">(${data.hourly.precipitation_probability[idx]}%)</span>` : ''}</div>` : '')}\n                ${data.hourly.snowfall && snow[i] > 0 ? `<div><span class=\"text-white/70\">Snow:</span> <span class=\"text-white\">${snow[i]} ${data.hourly_units.snowfall || 'in'}</span>${data.hourly.precipitation_probability && data.hourly.precipitation_probability[idx] !== null && data.hourly.precipitation_probability[idx] !== undefined ? ` <span class=\"text-white/60\">(${data.hourly.precipitation_probability[idx]}%)</span>` : ''}</div>` : ''}\n                ${data.hourly.snowfall && snow[i] > 0 ? '' : (data.hourly.precipitation_probability && data.hourly.precipitation_probability[idx] !== null && data.hourly.precipitation_probability[idx] !== undefined && !data.hourly.precipitation ? `<div><span class=\"text-white/70\">Rain Chance:</span> <span class=\"text-white\">${data.hourly.precipitation_probability[idx]}%</span></div>` : '')}\n            </div>\n            <div class=\"mt-2 text-white/80 text-sm\">${getWeatherDescription(data.hourly.weather_code[idx])}</div>\n        `;\n        detailsContainer.appendChild(detailItem);\n    }\n\n    // Initialize chart selection dropdown\n    initializeChartSelector('hourlyChartSelect');\n}\n\nfunction openDailyModal(data) {\n    const modal = document.getElementById('dailyModal');\n    modal.classList.add('active');\n    \n    // Destroy existing charts if they exist\n    if (dailyChart) {\n        Object.values(dailyChart).forEach(chart => {\n            if (chart) chart.destroy();\n        });\n    }\n    \n    // Prepare data\n    const labels = [];\n    const maxTemps = [];\n    const minTemps = [];\n    const precip = [];\n    const snowfall = [];\n    const wind = [];\n    const precipProb = [];\n    const moonPhases = [];\n    const dailyPressure = [];\n    \n    for (let i = 0; i < Math.min(14, data.daily.time.length); i++) {\n        const day = parseDateString(data.daily.time[i]);\n        labels.push(day.toLocaleDateString('en-US', { weekday: 'short' }));\n        maxTemps.push(Math.round(data.daily.temperature_2m_max[i]));\n        minTemps.push(Math.round(data.daily.temperature_2m_min[i]));\n        precip.push(data.daily.precipitation_sum[i] || 0);\n        snowfall.push(data.daily.snowfall_sum ? data.daily.snowfall_sum[i] || 0 : 0);\n        wind.push(data.daily.wind_speed_10m_max[i]);\n        precipProb.push(data.daily.precipitation_probability_max ? data.daily.precipitation_probability_max[i] : 0);\n        moonPhases.push(calculateMoonPhase(day));\n        \n        // Calculate daily average pressure from hourly data (noon value for each day)\n        if (data.hourly && data.hourly.surface_pressure) {\n            const dayStr = data.daily.time[i];\n            const noonIdx = data.hourly.time.findIndex(t => t.startsWith(dayStr) && t.includes('T12:'));\n            if (noonIdx !== -1) {\n                // Convert hPa to inHg\n                dailyPressure.push((data.hourly.surface_pressure[noonIdx] * 0.02953).toFixed(2));\n            } else {\n                // Fallback: use first hour of the day\n                const dayIdx = data.hourly.time.findIndex(t => t.startsWith(dayStr));\n                if (dayIdx !== -1) {\n                    dailyPressure.push((data.hourly.surface_pressure[dayIdx] * 0.02953).toFixed(2));\n                } else {\n                    dailyPressure.push(null);\n                }\n            }\n        } else {\n            dailyPressure.push(null);\n        }\n    }\n    \n    // Create charts\n    const chartConfig = {\n        type: 'line',\n        options: {\n            responsive: true,\n            maintainAspectRatio: false,\n            plugins: {\n                legend: {\n                    labels: { color: '#fff' }\n                }\n            },\n            scales: {\n                x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },\n                y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }\n            }\n        }\n    };\n    \n    dailyChart = {\n        temp: new Chart(document.getElementById('dailyTempChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [\n                    {\n                        label: `High (${data.daily_units.temperature_2m_max})`,\n                        data: maxTemps,\n                        borderColor: 'rgb(255, 99, 132)',\n                        backgroundColor: 'rgba(255, 99, 132, 0.2)',\n                        tension: 0.4\n                    },\n                    {\n                        label: `Low (${data.daily_units.temperature_2m_min})`,\n                        data: minTemps,\n                        borderColor: 'rgb(54, 162, 235)',\n                        backgroundColor: 'rgba(54, 162, 235, 0.2)',\n                        tension: 0.4\n                    }\n                ]\n            }\n        }),\n        precip: new Chart(document.getElementById('dailyPrecipChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Precipitation (${data.daily_units.precipitation_sum})`,\n                    data: precip,\n                    borderColor: 'rgb(54, 162, 235)',\n                    backgroundColor: 'rgba(54, 162, 235, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        wind: new Chart(document.getElementById('dailyWindChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Wind Speed (${formatUnit(data.daily_units.wind_speed_10m_max)})`,\n                    data: wind,\n                    borderColor: 'rgb(255, 206, 86)',\n                    backgroundColor: 'rgba(255, 206, 86, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        pressure: new Chart(document.getElementById('dailyPressureChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: 'Pressure (inHg)',\n                    data: dailyPressure,\n                    borderColor: 'rgb(34, 197, 94)',\n                    backgroundColor: 'rgba(34, 197, 94, 0.2)',\n                    tension: 0.4\n                }]\n            }\n        }),\n        snow: new Chart(document.getElementById('dailySnowChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: `Snowfall (${data.daily_units.snowfall_sum || 'in'})`,\n                    data: snowfall,\n                    borderColor: 'rgb(173, 216, 230)',\n                    backgroundColor: 'rgba(173, 216, 230, 0.3)',\n                    tension: 0.4,\n                    fill: true\n                }]\n            }\n        }),\n        moonPhase: new Chart(document.getElementById('dailyMoonPhaseChart'), {\n            ...chartConfig,\n            data: {\n                labels,\n                datasets: [{\n                    label: 'Moon Phase',\n                    data: moonPhases,\n                    borderColor: 'rgb(147, 112, 219)',\n                    backgroundColor: 'rgba(147, 112, 219, 0.2)',\n                    tension: 0.4,\n                    fill: true\n                }]\n            },\n            options: {\n                ...chartConfig.options,\n                scales: {\n                    ...chartConfig.options.scales,\n                    y: {\n                        ...chartConfig.options.scales.y,\n                        min: 0,\n                        max: 1,\n                        ticks: {\n                            ...chartConfig.options.scales.y.ticks,\n                            stepSize: 0.125,\n                            callback: function(value) {\n                                const phase = getMoonPhase(value);\n                                return phase.emoji;\n                            }\n                        }\n                    }\n                },\n                plugins: {\n                    ...chartConfig.options.plugins,\n                    tooltip: {\n                        callbacks: {\n                            label: function(context) {\n                                const phase = getMoonPhase(context.parsed.y);\n                                return `Moon Phase: ${phase.emoji} ${phase.name} (${(context.parsed.y * 100).toFixed(1)}%)`;\n                            }\n                        }\n                    }\n                }\n            }\n        })\n    };\n    \n    // Hide/show charts based on rain and snow presence\n    const snowChartContainer = document.getElementById('dailySnowChart').parentElement;\n    const precipChartContainer = document.getElementById('dailyPrecipChart').parentElement;\n    const hasSnow = snowfall.some(val => val > 0);\n    const hasRain = precip.some(val => val > 0);\n    \n    // Show both charts if both rain and snow are present\n    if (hasSnow && hasRain) {\n        snowChartContainer.style.display = 'block';\n        precipChartContainer.style.display = 'block';\n    } else if (hasSnow) {\n        // Only snow, show snow chart\n        snowChartContainer.style.display = 'block';\n        precipChartContainer.style.display = 'none';\n    } else {\n        // Only rain or neither, show precipitation chart\n        snowChartContainer.style.display = 'none';\n        precipChartContainer.style.display = 'block';\n    }\n    \n    // Populate detailed daily items\n    const detailsContainer = document.getElementById('dailyDetails');\n    detailsContainer.innerHTML = '';\n    for (let i = 0; i < Math.min(14, data.daily.time.length); i++) {\n        const day = parseDateString(data.daily.time[i]);\n        const moonPhaseValue = calculateMoonPhase(day);\n        const moonPhase = getMoonPhase(moonPhaseValue);\n        const detailItem = document.createElement('div');\n        detailItem.className = 'bg-white/10 rounded-lg p-4 backdrop-blur-sm';\n        detailItem.innerHTML = `\n            <div class=\"flex items-center justify-between mb-3\">\n                <div>\n                    <div class=\"text-white font-semibold text-lg\">${day.toLocaleDateString('en-US', { weekday: 'long' })}</div>\n                    <div class=\"text-white/70 text-sm\">${day.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>\n                </div>\n                <div class=\"text-4xl\">${getWeatherIcon(data.daily.weather_code[i])}</div>\n            </div>\n            <div class=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\">High / Low</div>\n                    <div class=\"text-white font-bold\">${Math.round(maxTemps[i])}${data.daily_units.temperature_2m_max} / ${Math.round(minTemps[i])}${data.daily_units.temperature_2m_min}</div>\n                </div>\n                ${snowfall[i] > 0 ? `\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-snowflake mr-1\"></i>Snowfall</div>\n                    <div class=\"text-white font-bold\">${snowfall[i]} ${data.daily_units.snowfall_sum || 'in'}</div>\n                    ${precipProb[i] !== null && precipProb[i] !== undefined ? `<div class=\"text-white/60 text-xs mt-1\"><i class=\"fas fa-snowflake mr-1\"></i>${precipProb[i]}%</div>` : ''}\n                </div>\n                ` : `\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\">Precipitation</div>\n                    <div class=\"text-white font-bold\">${precip[i]} ${data.daily_units.precipitation_sum}</div>\n                    ${precipProb[i] !== null && precipProb[i] !== undefined ? `<div class=\"text-white/60 text-xs mt-1\"><i class=\"fas fa-tint mr-1\"></i>${precipProb[i]}%</div>` : ''}\n                </div>\n                `}\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\">Wind Speed</div>\n                    <div class=\"text-white font-bold\">${wind[i]} ${formatUnit(data.daily_units.wind_speed_10m_max)}</div>\n                </div>\n                ${dailyPressure[i] ? `\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-gauge mr-1\"></i>Pressure</div>\n                    <div class=\"text-white font-bold\">${dailyPressure[i]}\" inHg</div>\n                </div>\n                ` : ''}\n                <div class=\"bg-white/10 rounded p-3 moon-phase-clickable\" style=\"cursor: pointer;\">\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-moon mr-1\"></i>Moon Phase</div>\n                    <div class=\"text-white font-bold flex items-center gap-2\">\n                        <span class=\"text-xl\">${moonPhase.emoji}</span>\n                        <span class=\"text-sm\">${moonPhase.name}</span>\n                    </div>\n                </div>\n                <div class=\"bg-white/10 rounded p-3\">\n                    <div class=\"text-white/70 text-xs mb-1\"><i class=\"fas fa-sun mr-1\"></i>Sun</div>\n                    <div class=\"text-white\">\n                        <span class=\"text-yellow-400 text-xs\">‚Üë</span> <span class=\"text-sm font-semibold\">${data.daily.sunrise && data.daily.sunrise[i] ? formatTime12Hour(new Date(data.daily.sunrise[i])) : 'N/A'}</span>\n                    </div>\n                    <div class=\"text-white mt-0.5\">\n                        <span class=\"text-orange-400 text-xs\">‚Üì</span> <span class=\"text-sm font-semibold\">${data.daily.sunset && data.daily.sunset[i] ? formatTime12Hour(new Date(data.daily.sunset[i])) : 'N/A'}</span>\n                    </div>\n                </div>\n            </div>\n            <div class=\"mt-3 text-white/80\">${getWeatherDescription(data.daily.weather_code[i])}</div>\n        `;\n        \n        // Add click handler for moon phase card in modal\n        const moonPhaseCard = detailItem.querySelector('.moon-phase-clickable');\n        if (moonPhaseCard) {\n            moonPhaseCard.addEventListener('click', (e) => {\n                e.stopPropagation();\n                openMoonDetailsModal(day);\n            });\n        }\n        \n        detailsContainer.appendChild(detailItem);\n    }\n\n    // Initialize chart selection dropdown\n    initializeChartSelector('dailyChartSelect');\n}\n\n// Modal close handlers\ndocument.getElementById('closeHourlyModal').addEventListener('click', () => {\n    document.getElementById('hourlyModal').classList.remove('active');\n});\n\ndocument.getElementById('closeDailyModal').addEventListener('click', () => {\n    document.getElementById('dailyModal').classList.remove('active');\n});\n\ndocument.getElementById('closeMoonDetailsModal').addEventListener('click', () => {\n    document.getElementById('moonDetailsModal').classList.remove('active');\n});\n\ndocument.getElementById('closeSymptomRiskModal').addEventListener('click', () => {\n    document.getElementById('symptomRiskModal').classList.remove('active');\n});\n\n// Close modals when clicking outside\ndocument.getElementById('hourlyModal').addEventListener('click', (e) => {\n    if (e.target.id === 'hourlyModal') {\n        document.getElementById('hourlyModal').classList.remove('active');\n    }\n});\n\ndocument.getElementById('dailyModal').addEventListener('click', (e) => {\n    if (e.target.id === 'dailyModal') {\n        document.getElementById('dailyModal').classList.remove('active');\n    }\n});\n\ndocument.getElementById('moonDetailsModal').addEventListener('click', (e) => {\n    if (e.target.id === 'moonDetailsModal') {\n        document.getElementById('moonDetailsModal').classList.remove('active');\n    }\n});\n\ndocument.getElementById('symptomRiskModal').addEventListener('click', (e) => {\n    if (e.target.id === 'symptomRiskModal') {\n        document.getElementById('symptomRiskModal').classList.remove('active');\n    }\n});\n\n// Close modals with Escape key\ndocument.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape') {\n        document.getElementById('hourlyModal').classList.remove('active');\n        document.getElementById('dailyModal').classList.remove('active');\n        document.getElementById('moonDetailsModal').classList.remove('active');\n        document.getElementById('symptomRiskModal').classList.remove('active');\n    }\n});\n\n// Ventusky Radar functionality\nfunction initializeVentuskyRadar(lat, lon) {\n    // Build Ventusky URL with location parameters\n    // Format: https://www.ventusky.com/precipitation-map?p=[lat];[lon];[zoom]&l=[layer]\n    // Using precipitation map as default - users can change layers within Ventusky\n    // Zoom level 8 shows approximately 50 miles x 50 miles\n    // Use slightly lower zoom on mobile to show more area (zoomed out by one level)\n    const isMobile = window.innerWidth <= 768;\n    const zoom = isMobile ? 7 : 8; // Lower zoom on mobile (more zoomed out)\n    // Use proxy route to request desktop version (removes download app button)\n    const ventuskyUrl = `/ventusky-proxy/precipitation-map?p=${lat};${lon};${zoom}&l=rain`;\n    \n    // Set iframe source\n    const ventuskyFrame = document.getElementById('ventuskyFrame');\n    if (ventuskyFrame) {\n        ventuskyFrame.src = ventuskyUrl;\n        \n        // Prevent iframe from opening in new tab\n        ventuskyFrame.addEventListener('load', () => {\n            try {\n                // Try to access iframe content to prevent new tab opens\n                // This may fail due to cross-origin restrictions, but we'll try\n                const iframeWindow = ventuskyFrame.contentWindow;\n                if (iframeWindow) {\n                    // Override window.open if possible\n                    iframeWindow.open = function() {\n                        console.log('Blocked iframe window.open');\n                        return null;\n                    };\n                }\n            } catch (e) {\n                // Cross-origin restrictions prevent this, which is expected\n            }\n        });\n    }\n    \n    // Prevent container clicks and scroll events from opening new tabs\n    const radarContainer = document.getElementById('radarContainer');\n    const ventuskyContainer = document.getElementById('ventuskyContainer');\n    \n    if (radarContainer) {\n        // Track if user is scrolling to prevent accidental interactions\n        let scrollTimeout;\n        let isUserScrolling = false;\n        \n        // Monitor page scroll to detect when user is actively scrolling\n        window.addEventListener('scroll', () => {\n            isUserScrolling = true;\n            clearTimeout(scrollTimeout);\n            scrollTimeout = setTimeout(() => {\n                isUserScrolling = false;\n            }, 300);\n        }, { passive: true });\n        \n        // Prevent clicks during or right after scrolling\n        radarContainer.addEventListener('click', (e) => {\n            if (isUserScrolling) {\n                e.preventDefault();\n                e.stopPropagation();\n                e.stopImmediatePropagation();\n                return false;\n            }\n            // Only prevent if clicking outside the iframe\n            if (e.target === radarContainer || e.target === ventuskyContainer) {\n                e.preventDefault();\n                e.stopPropagation();\n                return false;\n            }\n        }, { passive: false, capture: true });\n        \n        // Prevent focus events that might trigger new tabs\n        radarContainer.addEventListener('focusin', (e) => {\n            if (isUserScrolling) {\n                e.preventDefault();\n                e.stopPropagation();\n            }\n        }, { capture: true });\n    }\n}\n\nfunction updateVentuskyLocation(lat, lon) {\n    // Update iframe URL when location changes\n    // Zoom level 8 shows approximately 50 miles x 50 miles on desktop\n    // Use slightly lower zoom on mobile to show more area (zoomed out by one level)\n    const isMobile = window.innerWidth <= 768;\n    const zoom = isMobile ? 7 : 8; // Lower zoom on mobile (more zoomed out)\n    // Use proxy route to request desktop version (removes download app button)\n    const ventuskyUrl = `/ventusky-proxy/precipitation-map?p=${lat};${lon};${zoom}&l=rain`;\n    \n    const ventuskyFrame = document.getElementById('ventuskyFrame');\n    if (ventuskyFrame) {\n        ventuskyFrame.src = ventuskyUrl;\n    }\n}\n\n";
const FAVICON_CONTENT = "<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\" width=\"512\" height=\"512\">\n  <defs>\n    <!-- Dark gray gradient background -->\n    <linearGradient id=\"bgGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n      <stop offset=\"0%\" style=\"stop-color:#374151;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#1f2937;stop-opacity:1\" />\n    </linearGradient>\n    <!-- Gradient for cloud -->\n    <linearGradient id=\"cloudGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n      <stop offset=\"0%\" style=\"stop-color:#93c5fd;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#60a5fa;stop-opacity:1\" />\n    </linearGradient>\n    <!-- Gradient for sun -->\n    <radialGradient id=\"sunGradient\" cx=\"50%\" cy=\"50%\">\n      <stop offset=\"0%\" style=\"stop-color:#fef3c7;stop-opacity:1\" />\n      <stop offset=\"100%\" style=\"stop-color:#fbbf24;stop-opacity:1\" />\n    </radialGradient>\n    <!-- Shadow filter -->\n    <filter id=\"shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n      <feGaussianBlur in=\"SourceAlpha\" stdDeviation=\"4\"/>\n      <feOffset dx=\"2\" dy=\"2\" result=\"offsetblur\"/>\n      <feComponentTransfer>\n        <feFuncA type=\"linear\" slope=\"0.3\"/>\n      </feComponentTransfer>\n      <feMerge>\n        <feMergeNode/>\n        <feMergeNode in=\"SourceGraphic\"/>\n      </feMerge>\n    </filter>\n  </defs>\n  \n  <!-- Dark gray gradient background -->\n  <rect width=\"512\" height=\"512\" fill=\"url(#bgGradient)\"/>\n  \n  <!-- Cloud with gradient and shadow - scaled and centered -->\n  <g transform=\"translate(80, 200) scale(0.7)\">\n    <path fill=\"url(#cloudGradient)\" filter=\"url(#shadow)\" d=\"M416 128c-.6 0-1.1.2-1.6.2 1.1-5.2 1.6-10.6 1.6-16 0-44.2-35.8-80-80-80-24.6 0-46.3 11.3-61 28.8C256.4 24.8 219.3 0 176 0 114 0 64 50 64 112c0 7.1.7 14.1 2.1 20.8C27.8 145.4 0 181.5 0 224c0 53 43 96 96 96h320c53 0 96-43 96-96s-43-96-96-96z\"/>\n  </g>\n  \n  <!-- Sun with gradient and shadow - positioned just above the cloud, slightly to the right -->\n  <g transform=\"translate(320, 160)\">\n    <g filter=\"url(#shadow)\">\n      <!-- Sun rays (8 rays evenly spaced) -->\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"0\" y1=\"-100\" x2=\"0\" y2=\"-80\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"0\" y1=\"80\" x2=\"0\" y2=\"100\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-100\" y1=\"0\" x2=\"-80\" y2=\"0\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"80\" y1=\"0\" x2=\"100\" y2=\"0\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-70.71\" y1=\"-70.71\" x2=\"-56.57\" y2=\"-56.57\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"56.57\" y1=\"56.57\" x2=\"70.71\" y2=\"70.71\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"70.71\" y1=\"-70.71\" x2=\"56.57\" y2=\"-56.57\"/>\n      <line stroke=\"#fbbf24\" stroke-width=\"10\" stroke-linecap=\"round\" x1=\"-56.57\" y1=\"56.57\" x2=\"-70.71\" y2=\"70.71\"/>\n      <!-- Sun circle -->\n      <circle fill=\"url(#sunGradient)\" cx=\"0\" cy=\"0\" r=\"40\"/>\n    </g>\n  </g>\n</svg>\n";
const APPLE_TOUCH_ICON_BASE64 = "iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAapklEQVR4nO2d+X8T1RrG+5cIFIQuSZekWZqlTZd0h1IqIAW10BbKphSkLJalLbZlUcArXjbBBSiI7LJ1YxWX63pRrqKAIgj3uqFChSbhuZ/3nKRNoUCLaWYyOT88n2E6ZyZnnvOdN+95ZyaEGJLyICQ8MCjEgxCpOyAkPDAIoAUEIhDk3StCD4WQ8MCgEA9C9LahEBIe6BXigQBaBoMgNFQALSAQF4JeRGgBgV7hHoiUQwaDIDRUAC0gEBeCvusInQsh4YFeIR6E6BJzISQ80CnEAwG0DAZBKFcALSAQF4JORGgBgU7hHoiUQwaDIJQrgBYQiAtB13WEHgIh4YFOIR4IoANagxGX0CGd5P2RXiFxCUMgFIgeDMb0kgTsWaHDsxOs0JizobUOlkG/pJUAOkBhzh2Sglst/eE4EsqW+UOt0FgE1ALoABRF4kmFiQxmj8rGmRFryoTWmiN5/6SUADpAgZ4ytjPQ04tMiInPEEBLPThCPgK62IBoY7oA2nuWLBQYHlBaMXlsQiegZzCg06C1ZEvePyklgJbBIAigB/sOaPr6EgosDzSWuyP09CIDogxp7eW7YJUAOlCBLuwMdFkRTzk8pbtglQC6Vw3OYfDR0tdAF4xI7QT02FFWNin0PdD8HHrjPATQAaTE1AyUl1qROzQdseZsNxC+gyzWnIVXK3U4vyMUr1dFQxWXzMp2vvwcOtaQoRmYOdECm90T/eUNtYjQvWCq3pKNM/URLHLeaOiPZ4qsiDFl+hQIOhYdM8pgh1qfyqJzrNmXx8/BlHEJuN44gJ3HV/Xh0Ld/A8gX6hDeOSHfeZCN1Ax7p3TgemN/lBWbERNPQGSxNr74LIKLInWsOdPnx50yzsouRu/zyMq0sruRHVDLTwJon5vKIWt+JaoLqE0+h5ofx3eAae4B85HVKqjikhBrorRGAB1UogE3J9pxfK26ExStjf0xc0JvQN27MH/waiQSbRZEGVLZxSq3fnsrxDODFfKlB5TfZsGcmIKT69R3R+oiE6KNGe2TRTko1pyNyWO7hjkh0QyVLgXR8fLqc1cSQPciIDRpI6jfXae6C+r8oVSVyJQJINkYMiT9LphPrVPBajWzCorcLkABtMygnjfZ0l6ZkBqCWHM2ykttAQ8zSURoP0Ld4p4ont2mgt3Ob4TIAZRYczZsqXZ8vY1fdMdWq2CxWgImzbgDaOqsUG96QBOpGFMGqxlnZligN9mg1qewv9E26f3PYuU4g8WOrAwLIrW8f9Hx6TLpX/clgPYnNOZMdjePqhzygTn7Hv3LlFn/BNCSm9s1NFz0b18d05fHivV5//wMNOVHQoHiAYeNSoJcFFG9ZMps38bbZgedBNABArIH4OHDUvHSHAP2LNfixLoYnN6iZsu9L2rx0lw9RuZTVSId0Qzw4ANbAC1zEZTGhHQsmWnE9zsi4TgeAceJKDhOaOA46SVaPxHFtn+/MwJLZxpgTLSzKkUwgS2AljnMzxRZcHEngRrFwX3XCMcpMxzvWbnet3X8+5SZb6d2x6MY2NOLTYgydkzyggDojomAkHw8IACXlBtx60hkB8jvWeH8IBnOD9Ph/Ffm3fownW1ncLvBbjsagfUL9dCYU901ZQ/YypQAWqYwb18c547KOi+QM+H8aDCcH+fB+clwOD8ljeBLWv84j2+ndh6waf/jUdixVMufm1Y41AJoGcJM+S+D+V03zB/a4fwoG85P8jnAn4+B899PwfnvQjhPj+NLWv98DN9O7aj9h3Z3tOZQvzhLB7UhldWalQq1AFpWysTYAhtuHaU0wwNzOo+6FIUJWAL4i1I4v5wE55kpcJ6Zype0/kUp387AHu6O1untkZqOWzLajChjmldOrSyFdNQ0haT2gNKBjze5KxinzHB+YHfDPIJH4C/Gc3i/KoPz65lwnZ0N19k5bEnrTvo7bad21J72o/0/sPMJ4wkNPntTjci45PaJotTn7GsJoGUDcyZ7TpqnGkY437fxtIEiLYO5FM7/TIPr63K4vqmA69uFcJ2rhuv8Ir6k9W8q2HZqx9ozqClSZ7PjsYni8SiUj9dBraeSngBa8oFXqgiuljVqHp09qQZN8ih9+KIEzv88DdfZWXB9uwCu8zVwfbcUru+Xw/X9Cr6k9fM1fPvXs1h7th/tT8fxpB4nNDi6WuWO0lSjVhbUIfyEhKT1IAMmWyquN6nYBK4jOlOqUQjnmUk8xSBYL9RygH94Ba7La+G6vJ4vaf375Xz7twt4CkL70f4s9fBEaR2uN0Uigb1S5bnxopzxF0A/BHwEAVd6F+LbqF13j0ntJz1l7kg3KHf+OBfOzwrc0XkaTyfOP8+hvbQarh9fg+vqZrj+W8+XtH5pNd9O7b6Z6049Svhx6HiUS7vTDvqlJU8Zryfn351zl/IiEUD3EObiMYlYt1CL16o1Xeqf83QYMiSVTbq6O7DUrmqaid+6pslge7rxBJxflsL51Qx3dF4C1w8vw/XjRrj+uxW3f96N27/sY0tad9HfaTu1oyj91Qy+Px3Hk3bQ5PB4FOrKdFDp+HMf3T337MF2rKrQYWN11+e/bmEcJoyxsCqKVFALoHsA85iRNtxq7vzeXVe6sncg4i1JblgePLA0+KvnxXXOn6mWTJO6L93pxrlKuL5bxqPw1Tdx+6eduP3rYdy+1sKXP+1kf2fbqd25Sp520P50HDqeVx69fkEUIuOS3NWOB/dRb03Dj3sHPvDcyZ+xoyidkQbqEJqMCD3YA5pAPTfJ+MABJbW1hCI9zQS1Po3t151jb6zW3RNoVtlgQL8A16U1cF3dxKPzb424/cdJvqQofXUT307tqD1VPO4B9JuLtIjQJkHtBu/+fcxAcmoSO6/unH/lVA1UutRunbuvJYDuplE0OBZbCt5/Neq+A9vaGIo3q1UIj03sEdDLyvUd9WcP0J8T0BPdE8KFvJJx6RW4rrwO1//exu1f3uHR+Zd32LqL/k7bqd23C90ReiI/jgdodz165eyeAR1lSMeGSg37bZH7Xcj/2qhGUpJJAC3/b4kM9vVMkYdgHRRjxaBoSxeysu2RcSkMggfDwoGePYFP1hynvCaFrGRHOfR0uL6ZxysYF1/ilQ2Kxv97C7d/2sGWbP3yer6d2n0zj+3H9melO/ek8BT/nPmTYxGhTe5RH1V6O8I1tvucuwVhsQnsuHShSBShvWftQvf3IJ1NeNQGO1T61HuKtvMcsvPM/16iC2VYbjIcxyLcVY5kfofvs8fhPF0E5xmqQc+G61wVj7408bu8jlc2KCrTktZ/eJlvp3Z09/DM03x/Og67Y5jMqxzHIjAiz8xr0e0Runv9pHNT3+/c9fzcPZNif0sA/RCm0WA9SN2F2RuUb99yP/NMeTQ9DkpP0LE82hOlK/hdQYL24koOMNWfaUnr3xHM1awdi860H8ufh7Pj8Wc6NPh2ewQGRfNfQ+o5eL49dwG0Ir9F0llUe7XK/daJ93McLEqP4zdJqHzHoK7kdwUvLIbruyV8SevnKnn9mcp11J72a4/Onuc5ovBGlZqlBiyaShRJBdAKF4FlT0vAtQbvJ+0yef2YboxQ6kAVi6/K2K1t/jzHfF6fpiV7jmMWf0CJ2rFUo8Bdf/ZEZx3+aIjE4Mw4NiHsSVoUKBIph2zE046187WdH1BiqUc+h5NuY9Mkj56oo7uAlFZQNKYlrZ+hJ+0ozSjk7Wk/2t/rwaT1C9QIi7E+ZLohf4XQTFRIHh6oDekwJdpwpl7lLuG5J4gEJUVa9nD/E3CeJrBLOLztKuF/p+3UjtrTfjQRpMrGCQ3O1EfCmmhEuCaJVSx4zpuhKAmgZaV0BlpWRhKuvhPeATVFas+D/p63Vig3pnKcR7T+qedtFf5gP4vMbpj/uz8MedlahFFJUUeVGOXB7Ab6wbNWIf95QPVbKn+Nzrfi0h7346R3viBLT86xdwtzO0TrH2Xf/aLsCQ0u7QtH4XAjqx9TqY6VFRU6rgJouUKtS0FGejw+26Tq/BMGBDZFbIKbKiHtSuYR2euNb9rv0zdUyE6PY3kzg5mlGrxOrEQJoGUNdSpiNYmomKTBZYrWxz0/MKNz/z6HlxjEOr79eBSu7nsUS2dooY2LZyW6YIBZAH2XIWnuO4Fdy7Pdr1DrUxmM5gQLFk7Vo3GVipXe2F1FAtyjYxH4vSESTasiUTVVB7OVpxgRWhuL9h39lx46AXSvmcBB1dqGwV4wAyPKlqOouh5TXjyIspePYvrqk5iy8jAm1O7AU/New2NTlyIxb4K7xOYNeW8OUsetdgI7XJMIXbwFQ7ITML7AgGeLNSgpMCA3ywKdMd7reYokRBLIeru7n9LD5hegabYbXKKol4akx6aguHor5m/7D1aebMNL77q6rRea/8TsjZ9g9Jz1MKSPhkpHwKX1ar/p+CSqUETGpSIiLoU9BEQlOCZtElunh6KoTUeferdfclMQAZ0GTUIeCsrXYOGOC3jppMsnWnmiDeWv/gtDS2sQacrsdbA9F2SH7F5K84I4uED2KORe+aKSFGsdgiee24i6Q79gJUHYS1qw/Ryyxs1jX/UE2N198Yavq+1Sy+7VNzn278FSNNA0MNlj56F6z2WsOOHym2a99jmsg4tZlcIDBvVlVH4C6uvUmFliug/0UsmO6cUW1r8nRli9+ienPgYx0BrLYJTU7fIryN5a2nQd+VNfYGBQTlv6ZDyuu/8fQHqz46mRcoLajoLHEtrfxKF+TnnKiIi45Pbnu6XvYxADbckei/nbv8Py4y5J9eIxJyYuP4xJhQntMHtE1QmqRMgBaJXejimFxrv+c9CphYaAg1phQNthGz4FNQd/xosElIR64ZgTy47cwvaWw/irOawTLCfXRiAu3vQQQHfOwTvn4w+fHtD+GlMyjq+JvAvqpwv1AQW1goC2I3VkGeqa/pQXzC3hnSB5b10ETBYDv3vHbnjYHwgbTWozn5yN0bPXY/LyBkxb/R7KN3zK9PQr76KkbjdGTH8ZSfmTEWni7/71DD5e59bFJ+LYHVDTS7HTiwIH6pDOJaDAlTV3AmoOXsMLx1ySa9kRB7a3NN4F85d7s2C2mDEwmu7gJSPSXSvuSlHGTGQXLUDZmg+wpKm125/9/IFfUVK3D0mPTWX16vt9xp3lv4i4VOhNCThxZ6Ru6I/JTxoe2Gc5KOReX2GBJF3yCFTuvYplBJPEWnrUiRVHruF6S0wnKM4eykf15ncxau4Gfks6LuUeqUMaBpfWYsHuS3+7LzM2fIKUkWXsZgt/ifX+PtLklSKx3mTFyTug/vXgABgtFne/H3wsqRTwQEfGp6Ns/cdYdtQlCy1tceClpiu4daTjV4bOHs5H9aZ38dy281i0/zfkTXmBRbvOYKTClFmIWW+c7v5nHXGyz1vS0saWS484u+iPE+OXHIA2YSi/g9gDqL0j9c2mUNhsRneUFkD3EtCpeLx8HZbSwMlES1ocqG1sxYGGjbjSkoxPDhWjesv7eG7bBVTv/w11TTdR29AKc05xe9mOziNn/CLUHP6zR5/zz5bL2Nu8Da80f4fahhtY3NKGJQR5F+3nv/0DEvImdStae0O9Y2kEvt4WippntBgYTRFaAN1r0dmQMQa1Ddex5KhTNlp8xIG65ptYdPAaKnb8gDnbzmHezkuoPvAbapv+Ytup3TPrP2Q/2kJQjyxfh8UUaXvwGSubr+L3IzoWPX9v0WL5wa9R03CdQ32P/RYd+h320bO6lTZwqFM6flgmxtreX6m/lRWZcpDhU14+ziKS3ERwUiSuOXwdzx/6AzUNN1DXfItD69Uup6QaI2eueYjjt2FL05FOOe7mfdtRue9n9rl3fo63ahpvIGXUjHvm8J1Fk0r3g1Ceh55knD8HNNCJeaWoa3FgMQ2wDEV9q2tp89Ldfa06cK3H50Dta5tvob7xcCegt+x5E/N3XUFNY+sDj1l18BrMOUU9iLbyB7kdaCrDBJqovDT5paNY3OIMOtU1U45+E/UNnYHevHsj5u38ETUNrazNg44ze/NZRMXnMC+lHk9fKoQ9Xxtg0qeNRm0zRUBn0InOu6bxJrbcBfQGVOy4jEWHb3Tbm9HztrTnxVKPqa8UgECn4PHyV1FLgxuEqml24PnGm9jceKgT0Jt2b8BzOy6j+vAN1qY7x1rU8BcMWWPbKxdKUMABTZOT2fUXUNvsDErVNDnwfMNNbG64A+hdG/Dc25dRfegGa9Pd4xUtPuD+rQ5lROmAA1qfVoAaGtgg1fNNDixiQHdOOd7cvRFzCejDraxNd49X3fAXNEnDFROlAwzoFAwuXYLnm5xBq0WNDlQ33MJrh452Anrjzq2Yu+MKqg61sjY9OWZ+2Sr2XqL04xtkQFO6Ma52n+RQSS0CuvbQz7jYnM1gvtiYjvlbP0PFrp9QdeivHgM9dfUnGBST0F5rDmSF8NwpMERfi09v+ByLKFIFsaob21B5qBWVO65i5e6jmLvxS8zadhEL9v+BqoZbPT7ewoM3oDJkutOOlIBWiOcuUCAoXJuMit0/o7qRBjW4VdXQhoUHWzFv7zVU7PkN89/5E5WHb6GqwfFQx7MMnczSDqnH+O8qoIBW6dIkB0lOIngJYg5y20PDTMoevxhhsTYWpaUe56ABOtaai6oGGkghX3swbMYaDIpNFED7E+i41FGobHAK9YIHI+Zsck8MRYT2G9DalJEC5l66oEfOeUMA7e+UI9qUg4WHnUK94EFe2RqlAE0nEBgK16dg/oG/sOCwU8jHHqQXL3L//G6SLMb6YRVCpbBAUZgmCTPevIAFh5xCPvYgvbgWuoxCaGzDMUhnZ16Hef2yqdRj310FGNA2FK88ifmHnEK96EHF/r8w7Y3zKFzchJyJLyIudQzzPhDgDgygNUmwDp2KsYsbmdkCaD9f0AcdmLz2NHImr0BEfDaP3DIFW95Aa5KQPHouJm84i3kHnUIy8GDm2z8hr2wdIo1ZbrBlwIn8gU6CJvlxjF12DBUHnUIy9GDapotILpjLbsbIKVrLEOgkpI+rRfmuP1BxwCkkZw/2O1CwYCci9BmyidYh/OqSh8LikvHYrNeZUZIPlhC668HEtacRY8vnE0eJGZIN0PTG7pN1jZi73ykUgB5Mff0CNCkFCNMkSgu0p94oqWJtGLVwt+SDIuT821DHJORjUKxNMpZkALQNudPWYs5+h5ACPJiw+t8IN6RLBrXkQNsK5mLWvjbMfschpBAPHqt4i/0GNgWroAJaFZ+DafVXJB8AIYdvPdjXhoQRMzEoJjGYgLbhsYq3MWufQ0iBHkzeeB7hev+nHiH8a8H/0mcVY+beWyjf5xBSqAfZU1a5U49Ev3ElEdCJGLXooOSGCzl61YOnt1xBuI6itB+Bpq8Ef0ttGYoZO1sxc69DSOEe2IuX4NFoq9/YkgDoROQ8s05yo4UcfvGgcMVH6K82sQmiIoEeGJOICevOYeYeh1AQeDB9dxuibSMwMCZBmUDHJj+OGXscQkHkQcrYWr+lHX4H2vbUIkynK1coaDwYUXkAA9Rmlm76AWj6EP9p2OytmL6bvoqEgsWDcau+QH+Vkb1V3tt8+RfomAQ8XnsMZbsdQkHkweT6XxEaaXDn0QoCmk6oaNUZlO1yCAWZB2HaNP8ATVUHf+nR6AQUrT+PabscQkHmgcqazyaGvc2Y34Eu2XhJcnOFHH73ICZ1DB6NUiDQRWu+xbSdDqEg8yDcOkyZQD/1j9N4eqdDKMg8GKRJZePvB6DpQ/wjyqGGVzdj6g6HUBB5MOGNn9AvXOfOoXuXMb8CTY8SZpe9LrnBQg6/ejBm5WfoF6FXINAxCbAWzMeUHQ6hIPJgyJxdCI00soDW60BTXuNPRcYPwcTttzDpbYdQkHhgGVWJ0Mh4v/Dld6AHRFkx5h9fSm6ykMMvHkzc1oowQy76q83KBJpKN/YJL2PSdodQEHgwvPY4+obrWSBTJtCUdpjzUFrfionbHUIK98DsSTf8BzR9kH81IMqC3Ip9kpst5OhVD55cewF9BlnZo6P+YksSoEkxyQWYsLUVpW+1CSnUA2thHfpFGFgAUzzQA6LMyHp2i+SmC7X1igcFK06jT7SJvU/oT64kA5o0UJeBsesuoXRbm5CCPJhQ34rYrFJWe37Uj9GZAU2zT6nUX22BNmcSSupbMX5bm5BCPEiduBp9w/SsVOdvpiQFmkNtRnLJyxi/tU1IAR7kVR3DI1EmhKpMkvAkOdAkOvmMGfUo2domFMAejFz2GR7VprMy3QC1RSqg6YMlltqM0GgLMp99C0Vb24QC0IPhL3yKAYbBrKrBUw1pWJIH0B6oI41IKV2DcVtuoqi+TShAPBiysAUDtHb0izRKCrO8gPZArYqHNnc6nnj1f5IPlFDbfT0Yt/kGkieuxiODtCwYSQ2z/IB2q7/KhDDjEGTO3Imxm29i3JY2IZl5MGzJ54hNG4++YToWhCgYSc0NA5pKZ3JUqMqMfhFGxGRMQl71KYzbfEvyQRRqw4gVXyN+VBUeGahF33ADm9BLzYq3ZAt0B9gmZlxU6jjYZ7yN0WuvonBLm5AfPXjytT+QPb8RumGz8Yiaj0e/yHj0V5kl5yPggGZSUW5tYhG7T1gCYjInwjZhLXIWHMHwlWfxxIZfUbi5TWjz3/fgydf+xKhVF5FbfQrJz2yGdmg5+mvS0CdMxyNyJNWY5QeyF9DUucARgU05G5WH6DnbPmFxbFLyyEAN+uuzMciQK2R4OA8eUcczH8lP8rVvuI75THVlnlqYZa+AA7qTGNx3iswXCn0oDzp7Sf5KPsZBBbSQ8EAtgBYQqJXrgYjQMhgEIbPvgKYZq5DwIFQhHgigZTAIQmZfAt1VpUBIeGAKSA8E0DIYBCGTAFpAIC6EUBGhBQShCvdApBwyGAQhk++A7hdpgpDwoJ9CPBBAy2AQhEy+BDqePdsqJDzopwAPBNAyGASheAG0gEBcCP1EhBYQ9FO4ByLlkMEgCMULoAUE4kLo11WE7hsRDyHhQV+FeBDSN8IIIeFBX4V4IICWwSAIGQXQAgJxIfQVEVpA0FfhHoiUQwaDIGQUQAsIxIXQt6sI3SfcCCHhQR+FeBDSJ9wAIeFBH4V4IICWwSAIGQTQAgJxIfTpwoP/A86L6QFiKX1PAAAAAElFTkSuQmCC";

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // Serve the HTML page
    if (url.pathname === '/' || url.pathname === '/index.html') {
      return new Response(HTML_CONTENT, {
        headers: {
          'Content-Type': 'text/html;charset=UTF-8',
        },
      });
    }
    
    // Serve the JavaScript file
    if (url.pathname === '/app.js') {
      return new Response(JS_CONTENT, {
        headers: {
          'Content-Type': 'application/javascript',
        },
      });
    }
    
    // Serve the favicon
    if (url.pathname === '/favicon.svg') {
      return new Response(FAVICON_CONTENT, {
        headers: {
          'Content-Type': 'image/svg+xml',
          'Cache-Control': 'public, max-age=31536000', // Cache for 1 year
        },
      });
    }
    
    // Serve the Apple touch icon (PNG for iOS)
    if (url.pathname === '/apple-touch-icon.png') {
      const pngBuffer = Uint8Array.from(atob(APPLE_TOUCH_ICON_BASE64), c => c.charCodeAt(0));
      return new Response(pngBuffer, {
        headers: {
          'Content-Type': 'image/png',
          'Cache-Control': 'public, max-age=31536000', // Cache for 1 year
        },
      });
    }
    
    // Proxy API requests to avoid CORS issues
    if (url.pathname.startsWith('/api/')) {
      const apiPath = url.pathname.replace('/api/', '');
      let targetUrl;
      
      // Geocoding API uses a different base URL
      if (apiPath.startsWith('geocoding')) {
        // Convert /api/geocoding?name=... to geocoding-api.open-meteo.com/v1/search?name=...
        const searchParams = url.search;
        targetUrl = `https://geocoding-api.open-meteo.com/v1/search${searchParams}`;
      } else if (apiPath.startsWith('reverse')) {
        // Reverse geocoding using BigDataCloud (free, no API key needed)
        // Extract lat and lon from query params
        const lat = url.searchParams.get('lat');
        const lon = url.searchParams.get('lon');
        if (lat && lon) {
          targetUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&localityLanguage=en`;
        } else {
          return new Response(JSON.stringify({ error: true, reason: 'Missing lat or lon parameters' }), {
            status: 400,
            headers: {
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
            },
          });
        }
      } else if (apiPath.startsWith('alerts')) {
        // National Weather Service alerts API (US only)
        // Remove /api/ prefix and construct the full NWS URL
        const nwsPath = apiPath; // apiPath is already "alerts/active/zone/..." or "alerts/active"
        targetUrl = `https://api.weather.gov/${nwsPath}${url.search}`;
      } else if (apiPath.startsWith('nws-points')) {
        // NWS points API to get forecast zones
        const pathParts = apiPath.split('/');
        if (pathParts.length > 1) {
          targetUrl = `https://api.weather.gov/points/${pathParts.slice(1).join('/')}`;
        } else {
          targetUrl = `https://api.weather.gov/points${url.search}`;
        }
      } else if (apiPath.startsWith('nws-wms')) {
        // Proxy for NWS WMS service to handle CORS
        // Extract WMS parameters from query string
        const wmsParams = new URLSearchParams(url.search);
        // #region agent log
        const logData = {originalQuery:url.search,allParams:Object.fromEntries(wmsParams.entries()),hasTime:wmsParams.has('time'),timeValue:wmsParams.get('time')};
        // #endregion
        // Build the WMS GetMap request URL
        // Use RIDGE2 WMS endpoint - official NWS radar service
        const wmsBaseUrl = 'https://opengeo.ncep.noaa.gov/geoserver/ows';
        // Preserve all existing parameters (including time if present)
        wmsParams.set('service', 'WMS');
        wmsParams.set('request', 'GetMap');
        if (!wmsParams.has('version')) {
          wmsParams.set('version', '1.3.0');
        }
        if (!wmsParams.has('styles')) {
          wmsParams.set('styles', '');
        }
        targetUrl = `${wmsBaseUrl}?${wmsParams.toString()}`;
        // #region agent log
        const finalLogData = {targetUrl:targetUrl,finalParams:Object.fromEntries(wmsParams.entries()),hasTimeFinal:wmsParams.has('time'),timeValueFinal:wmsParams.get('time')};
        // #endregion
      } else {
        // Weather API uses the standard base URL
        targetUrl = `https://api.open-meteo.com/v1/${apiPath}${url.search}`;
      }
      
      try {
        let fetchOptions = {};
        // Add user agent for NWS (required by their usage policy)
        if (apiPath.startsWith('alerts') || apiPath.startsWith('nws-points') || apiPath.startsWith('nws-wms')) {
          const headers = new Headers();
          headers.set('User-Agent', 'WeatherApp/1.0 (contact@example.com)');
          fetchOptions = { headers };
        }
        
        // Special handling for NWS WMS - proxy images with CORS headers
        if (apiPath.startsWith('nws-wms')) {
          try {
            // #region agent log
            // Log the full request URL and all parameters for debugging
            const requestParams = {
              targetUrl: targetUrl,
              method: 'GET',
              hasTime: wmsParams.has('time'),
              timeValue: wmsParams.get('time'),
              allParams: Object.fromEntries(wmsParams.entries()),
              bbox: wmsParams.get('BBOX') || wmsParams.get('bbox'),
              crs: wmsParams.get('CRS') || wmsParams.get('crs'),
              layers: wmsParams.get('LAYERS') || wmsParams.get('layers')
            };
            console.error('NWS_WMS_PROXY_REQUEST', JSON.stringify(requestParams));
            // #endregion
            const response = await fetch(targetUrl, fetchOptions);
            
            // Get content type early
            const responseContentType = response.headers.get('Content-Type') || 'unknown';
            const responseIsImage = responseContentType.startsWith('image/');
            const responseIsXML = responseContentType.includes('xml') || responseContentType.includes('html');
            
            // #region agent log
            console.error('NWS_WMS_PROXY_RESPONSE', JSON.stringify({status:response.status,statusText:response.statusText,ok:response.ok,contentType:responseContentType,isImage:responseIsImage,isXML:responseIsXML,targetUrl:targetUrl}));
            // #endregion
            
            if (!response.ok) {
              // #region agent log
              const errorText = await response.text().catch(() => '');
              console.error('NWS_WMS_PROXY_ERROR', JSON.stringify({status:response.status,statusText:response.statusText,errorText:errorText.substring(0,200),targetUrl:targetUrl}));
              // #endregion
              // Return a transparent PNG for errors
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=300',
                },
              });
            }
            
            // Get the response data
            const responseData = await response.arrayBuffer();
            
            // Check if response is actually a valid PNG (starts with PNG signature: 89 50 4E 47)
            const pngFirstBytes = Array.from(new Uint8Array(responseData.slice(0, 8)));
            const pngIsValid = pngFirstBytes[0] === 0x89 && pngFirstBytes[1] === 0x50 && pngFirstBytes[2] === 0x4E && pngFirstBytes[3] === 0x47;
            
            // #region agent log
            console.error('NWS_WMS_PROXY_DATA', JSON.stringify({dataSize:responseData.byteLength,contentType:responseContentType,isImage:responseIsImage,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
            // #endregion
            
            // If it's not an image (likely XML error), return transparent PNG
            if (!responseIsImage) {
              // #region agent log
              const textData = new TextDecoder().decode(responseData.slice(0, 500));
              console.error('NWS_WMS_PROXY_NOT_IMAGE', JSON.stringify({contentType:responseContentType,textData:textData,targetUrl:targetUrl}));
              // #endregion
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=60',
                },
              });
            }
            
            // If it's not a valid PNG (might be error image or XML), check and log
            if (!pngIsValid && responseData.byteLength > 0) {
              // #region agent log
              const textData = new TextDecoder().decode(responseData.slice(0, 500));
              console.error('NWS_WMS_PROXY_INVALID_PNG', JSON.stringify({contentType:responseContentType,textData:textData,dataSize:responseData.byteLength,targetUrl:targetUrl}));
              // #endregion
              // Return transparent PNG for invalid images
              const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
              return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
                status: 200,
                headers: {
                  'Content-Type': 'image/png',
                  'Access-Control-Allow-Origin': '*',
                  'Cache-Control': 'public, max-age=60',
                },
              });
            }
            
            // Only log small PNGs but don't block them - valid tiles can be small
            // Only block if it's exactly our 68-byte error PNG
            const ourErrorPngSize = 68; // Size of our transparent error PNG
            if (pngIsValid && responseData.byteLength === ourErrorPngSize) {
              // #region agent log
              console.error('NWS_WMS_PROXY_SUSPECTED_ERROR_PNG', JSON.stringify({dataSize:responseData.byteLength,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
              // #endregion
              // This might be our own error PNG being returned - investigate but still pass it through
            } else if (pngIsValid && responseData.byteLength < 200) {
              // Log small but potentially valid PNGs (might be empty/transparent tiles)
              // #region agent log
              console.error('NWS_WMS_PROXY_SMALL_PNG', JSON.stringify({dataSize:responseData.byteLength,isPNG:pngIsValid,firstBytes:pngFirstBytes,targetUrl:targetUrl}));
              // #endregion
            }
            
            // #region agent log
            console.error('NWS_WMS_PROXY_SUCCESS', JSON.stringify({imageDataSize:responseData.byteLength,isPNG:pngIsValid,targetUrl:targetUrl}));
            // #endregion
            
            // Return the image with CORS headers - pass through all valid PNGs regardless of size
            return new Response(responseData, {
              headers: {
                'Content-Type': responseContentType || 'image/png',
                'Access-Control-Allow-Origin': '*',
                'Cache-Control': 'public, max-age=300', // Cache for 5 minutes
              },
            });
          } catch (error) {
            // #region agent log
            console.error('NWS_WMS_PROXY_FETCH_ERROR', JSON.stringify({errorMessage:error.message,errorStack:error.stack,targetUrl:targetUrl}));
            // #endregion
            console.error('NWS WMS proxy error:', error, 'for URL:', targetUrl);
            // Return transparent PNG on error
            const transparentPng256 = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            return new Response(Uint8Array.from(atob(transparentPng256), c => c.charCodeAt(0)), {
              status: 200,
              headers: {
                'Content-Type': 'image/png',
                'Access-Control-Allow-Origin': '*',
                'Cache-Control': 'public, max-age=60',
              },
            });
          }
        }
        
        if (apiPath.startsWith('reverse')) {
          // Special handling for reverse geocoding (BigDataCloud)
          try {
            const response = await fetch(targetUrl, fetchOptions);
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Reverse geocoding API error (${response.status}):`, errorText.substring(0, 200));
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // BigDataCloud returns the data directly, no error field to check
            // Transform to match expected format
            const transformedData = {
              address: {
                city: data.city || data.locality,
                town: data.town,
                village: data.village,
                municipality: data.municipality,
                county: data.county,
                state: data.principalSubdivision,
                state_district: data.principalSubdivision,
                country: data.countryName,
              },
              display_name: data.displayName || `${data.city || data.locality || ''}, ${data.principalSubdivision || ''}`.trim(),
            };
            
            return new Response(JSON.stringify(transformedData), {
              headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
              },
            });
          } catch (fetchError) {
            // Re-throw to be caught by outer catch block
            throw fetchError;
          }
        } else {
          // Standard handling for other APIs (forecast, geocoding, etc.)
          try {
            // Create cache key from the full request URL
            const cacheKey = new Request(targetUrl);
            
            // Try to get from cache first (only for forecast and geocoding)
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              const cachedResponse = await caches.default.match(cacheKey);
              if (cachedResponse) {
                // Clone the cached response and add CORS headers
                const cachedData = await cachedResponse.json();
                return new Response(JSON.stringify(cachedData), {
                  headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'X-Cache': 'HIT',
                  },
                });
              }
            }
            
            // Add timeout for long-running requests (30 seconds)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            
            if (!fetchOptions) {
              fetchOptions = {};
            }
            fetchOptions.signal = controller.signal;
            
            // Add User-Agent header for Open-Meteo to help with rate limiting
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              if (!fetchOptions.headers) {
                fetchOptions.headers = new Headers();
              }
              // Use a descriptive User-Agent to help Open-Meteo identify the app
              fetchOptions.headers.set('User-Agent', 'WeatherApp/1.0 (https://weather-app.jackanglim3.workers.dev)');
            }
            
            // Retry logic for rate limits (max 2 retries)
            let response;
            let retries = 0;
            const maxRetries = 2;
            
            while (retries <= maxRetries) {
              response = await fetch(targetUrl, fetchOptions);
              
              // If we get a 429, check for Retry-After header and wait accordingly
              if (response.status === 429 && retries < maxRetries) {
                const retryAfter = response.headers.get('Retry-After');
                const waitTime = retryAfter 
                  ? parseInt(retryAfter, 10) * 1000 
                  : Math.pow(2, retries) * 1000; // 1s, 2s, 4s
                console.log(`Rate limited, retrying in ${waitTime}ms... (attempt ${retries + 1}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, Math.min(waitTime, 10000))); // Max 10s wait
                retries++;
                continue;
              }
              
              break; // Success or non-retryable error
            }
            
            clearTimeout(timeoutId);
            
            // Handle rate limiting (429) after retries exhausted
            if (response.status === 429) {
              // Check for Retry-After header to provide specific wait time
              const retryAfter = response.headers.get('Retry-After');
              let waitMessage = 'Rate limit exceeded. ';
              if (retryAfter) {
                const waitSeconds = parseInt(retryAfter, 10);
                const waitMinutes = Math.ceil(waitSeconds / 60);
                waitMessage += `Please wait ${waitMinutes} minute${waitMinutes > 1 ? 's' : ''} and try again.`;
              } else {
                waitMessage += 'Please wait 1-2 minutes and try again.';
              }
              
              return new Response(JSON.stringify({ 
                error: true, 
                reason: waitMessage
              }), {
                status: 429,
                headers: {
                  'Content-Type': 'application/json',
                  'Access-Control-Allow-Origin': '*',
                },
              });
            }
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error(`API error (${response.status}) for ${targetUrl}:`, errorText.substring(0, 200));
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Try to parse as JSON
            let data;
            let text;
            try {
              text = await response.text();
              // Check if response is empty
              if (!text || text.trim().length === 0) {
                throw new Error('Empty response from API');
              }
              data = JSON.parse(text);
            } catch (parseError) {
              const contentType = response.headers.get('content-type');
              console.error('Failed to parse JSON response. Content-Type:', contentType, 'Response preview:', text?.substring(0, 200));
              
              // If we got a 429 but it's not JSON, return a proper error
              if (response.status === 429) {
                return new Response(JSON.stringify({ 
                  error: true, 
                  reason: 'Rate limit exceeded. Please try again in a few moments.' 
                }), {
                  status: 429,
                  headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                  },
                });
              }
              
              throw new Error(`Invalid response format: ${parseError.message}`);
            }
            
            // Cache successful responses (only for forecast and geocoding)
            if (apiPath.startsWith('forecast') || apiPath.startsWith('geocoding')) {
              // Determine cache duration based on API type
              const cacheSeconds = apiPath.startsWith('forecast') ? 600 : 3600; // 10 min for forecast, 1 hour for geocoding
              
              // Create a response with cache headers
              const cacheResponse = new Response(JSON.stringify(data), {
                headers: {
                  'Content-Type': 'application/json',
                  'Cache-Control': `public, max-age=${cacheSeconds}`,
                },
              });
              
              // Store in cache
              ctx.waitUntil(caches.default.put(cacheKey, cacheResponse.clone()));
            }
            
            return new Response(JSON.stringify(data), {
              headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
                'X-Cache': 'MISS',
              },
            });
          } catch (fetchError) {
            if (fetchError.name === 'AbortError') {
              console.error('Request timeout for', targetUrl);
              throw new Error('Request timeout');
            }
            console.error('Fetch error for', targetUrl, ':', fetchError.message);
            throw fetchError;
          }
        }
      } catch (error) {
        console.error('API proxy error:', error);
        return new Response(JSON.stringify({ error: true, reason: error.message }), {
          status: 500,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
        });
      }
    }
    
    // Proxy Ventusky iframe with desktop user agent to remove mobile download button
    if (url.pathname.startsWith('/ventusky-proxy')) {
      try {
        // Extract Ventusky path and parameters
        // Remove /ventusky-proxy prefix to get the Ventusky path (e.g., /precipitation-map)
        const ventuskyPath = url.pathname.replace('/ventusky-proxy', '') || '/precipitation-map';
        const ventuskyParams = url.search;
        const ventuskyUrl = `https://www.ventusky.com${ventuskyPath}${ventuskyParams}`;
        
        // Fetch with desktop user agent to get desktop version (no download button)
        const response = await fetch(ventuskyUrl, {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.9',
          },
        });
        
        if (!response.ok) {
          return new Response('Failed to load Ventusky', { status: response.status });
        }
        
        // Get the HTML content
        let html = await response.text();
        
        // Inject CSS and JavaScript to hide download button
        const hideButtonScript = `
          <style>
            /* Hide download app button */
            a[href*="app"], 
            button[class*="app"],
            div[class*="app-button"],
            div[class*="download"],
            a[class*="download"],
            button[class*="download"],
            [data-app-button],
            [id*="app-button"],
            [id*="download-button"] {
              display: none !important;
              visibility: hidden !important;
              opacity: 0 !important;
              height: 0 !important;
              width: 0 !important;
              overflow: hidden !important;
            }
          </style>
          <script>
            // Additional JavaScript to hide button after page loads
            (function() {
              function hideDownloadButton() {
                const selectors = [
                  'a[href*="app"]',
                  'button[class*="app"]',
                  'div[class*="app-button"]',
                  'div[class*="download"]',
                  'a[class*="download"]',
                  'button[class*="download"]',
                  '[data-app-button]',
                  '[id*="app-button"]',
                  '[id*="download-button"]'
                ];
                selectors.forEach(selector => {
                  document.querySelectorAll(selector).forEach(el => {
                    el.style.display = 'none';
                    el.style.visibility = 'hidden';
                    el.style.opacity = '0';
                    el.style.height = '0';
                    el.style.width = '0';
                  });
                });
              }
              // Run immediately and on various events
              hideDownloadButton();
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', hideDownloadButton);
              }
              window.addEventListener('load', hideDownloadButton);
              // Use MutationObserver to catch dynamically added buttons
              const observer = new MutationObserver(hideDownloadButton);
              observer.observe(document.body, { childList: true, subtree: true });
              // Also run periodically as fallback
              setInterval(hideDownloadButton, 1000);
            })();
          </script>
        `;
        
        // Inject the script before closing head tag, or at the beginning of body
        if (html.includes('</head>')) {
          html = html.replace('</head>', hideButtonScript + '</head>');
        } else if (html.includes('<body')) {
          html = html.replace('<body', hideButtonScript + '<body');
        } else {
          html = hideButtonScript + html;
        }
        
        // Return modified HTML with proper headers
        return new Response(html, {
          headers: {
            'Content-Type': 'text/html;charset=UTF-8',
            'X-Frame-Options': 'ALLOWALL',
            'Content-Security-Policy': "frame-ancestors *;",
          },
        });
      } catch (error) {
        console.error('Ventusky proxy error:', error);
        return new Response('Error proxying Ventusky', { status: 500 });
      }
    }
    
    return new Response('Not Found', { status: 404 });
  },
};
